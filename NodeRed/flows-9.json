[{"id":"f996f74a.c8c748","type":"tab","label":"Botones persianas","disabled":false,"info":""},{"id":"f0ddc17c.4ba93","type":"tab","label":"Control persianas","disabled":false,"info":""},{"id":"4c31633a.905f9c","type":"tab","label":"Calefaccion","disabled":false,"info":""},{"id":"9fe9cc56.678888","type":"tab","label":"Config","disabled":false,"info":""},{"id":"ccc70095.e8d18","type":"tab","label":"Control de servidores","disabled":false,"info":""},{"id":"6f26701.f6c739","type":"tab","label":"SQL_Temp","disabled":false,"info":""},{"id":"f3d60e61.2dd1f8","type":"tab","label":"Calefacción_old","disabled":false,"info":""},{"id":"5ec721c6.6a6898","type":"tab","label":"test interparking","disabled":true,"info":""},{"id":"fa9b3c4d.e0031","type":"subflow","name":"Control-Persiana","info":"Dispone de Salida para Conectar a MQTT\n## Variables de entorno\n * MQTT_ON = True / False\n * MQTT_Topic = Topic de MQTT al que enviar mensajes\n * move_timer = Tiempo que tarda la Persiana en subir y bajar\n## Imput\n * Se puede mandar pauete con Topic = block para poder mandar mensaje de bloqueo directo a MQTT. Se comprueba de manera booleana. \n * Puedes crear un dispositivo alexa con nombre \"bloqueo de persiana\" para poder dar la orden\n## Imput2\n * Dipone de una entrada donde se puede conectar alexa a o botones para control\n *  * Alexa: https://alexa-node-red.bm.hardill.me.uk/docs\n *  *  Botones:\n *  *  *  true - Levanta al 100%\n *  *  *  false - Baja al 100%\n *  *  *  Cancel - detiene el movimiento","category":"","in":[{"x":20,"y":80,"wires":[{"id":"1b5adff0.3f3768"}]}],"out":[{"x":1160,"y":40,"wires":[{"id":"b27682da.71eec","port":0}]},{"x":1040,"y":1340,"wires":[{"id":"7092d534.1f47dc","port":0},{"id":"9ebd2d0e.11b35","port":0},{"id":"7f44b9a3.981f38","port":0}]},{"x":1040,"y":1440,"wires":[{"id":"1c8dee.e60ce212","port":0},{"id":"811f1386.ec439","port":0},{"id":"ca4b9c61.aa042","port":0}]},{"x":120,"y":40,"wires":[{"id":"fa9b3c4d.e0031","port":0}]},{"x":680,"y":580,"wires":[{"id":"2f4e9ae4.40fc26","port":0},{"id":"2f4e9ae4.40fc26","port":1},{"id":"2f4e9ae4.40fc26","port":2}]},{"x":1060,"y":800,"wires":[{"id":"ca4eeb59.eda1b8","port":0},{"id":"717ef713.35a63","port":0},{"id":"30ab0d4.8956ff2","port":0},{"id":"db35e674.a78f68","port":0},{"id":"eca93e8d.74a7e8","port":0},{"id":"401c0185.5d8008","port":0},{"id":"d22bf217.e22cb","port":0},{"id":"668c607f.5e43c","port":0},{"id":"810d022d.ab013","port":0},{"id":"63deb08e.b89d3","port":0}]},{"x":2140,"y":440,"wires":[{"id":"3b7dae97.ced772","port":0}]}],"env":[{"name":"move_time","type":"num","value":"30"},{"name":"MQTT_Topic","type":"str","value":"persia/per4/order"},{"name":"MQTT_ON","type":"bool","value":"true"},{"name":"up_whit_correction","type":"num","value":"30"},{"name":"down_whit_correction","type":"str","value":"30"}],"meta":{},"color":"#F3B567","inputLabels":["Alexa"],"outputLabels":["MQTT Messages","Persiana %","Internal process ON","Paquete de entrada","Paquete de Decision up/down","Conversión porcentaje a tiempo"]},{"id":"63e478e.65faa88","type":"subflow","name":"Control-Persiana_SIn_correcion_de_Maximos","info":"Dispone de Salida para Conectar a MQTT\n## Variables de entorno\n * MQTT_ON = True / False\n * MQTT_Topic = Topic de MQTT al que enviar mensajes\n * move_timer = Tiempo que tarda la Persiana en subir y bajar\n## Imput\n * Se puede mandar pauete con Topic = block para poder mandar mensaje de bloqueo directo a MQTT. Se comprueba de manera booleana. \n * Puedes crear un dispositivo alexa con nombre \"bloqueo de persiana\" para poder dar la orden\n## Imput2\n * Dipone de una entrada donde se puede conectar alexa a o botones para control\n *  * Alexa: https://alexa-node-red.bm.hardill.me.uk/docs\n *  *  Botones:\n *  *  *  true - Levanta al 100%\n *  *  *  false - Baja al 100%\n *  *  *  ","category":"","in":[{"x":20,"y":80,"wires":[{"id":"d550f1c0.09d7b8"}]}],"out":[{"x":1160,"y":40,"wires":[{"id":"1c56dbfe.fe5d8c","port":0}]},{"x":1060,"y":1180,"wires":[{"id":"acac6149.291998","port":0},{"id":"a5e8f0d7.8f446","port":0},{"id":"83f1f426.b09f8","port":0}]},{"x":1060,"y":1280,"wires":[{"id":"4d50d76a.1133e","port":0},{"id":"550cce7d.c19bc","port":0},{"id":"a6e8d642.9e8678","port":0}]},{"x":120,"y":40,"wires":[{"id":"63e478e.65faa88","port":0}]}],"env":[{"name":"move_time","type":"num","value":"30"},{"name":"MQTT_Topic","type":"str","value":"persia/per4/order"},{"name":"MQTT_ON","type":"bool","value":"true"},{"name":"move_time_down","type":"num","value":"30"}],"meta":{},"color":"#F3B567","inputLabels":["Alexa"],"outputLabels":["MQTT Messages","Persiana %","Internal process ON","Paquete de entrada"]},{"id":"dac02106.9590c","type":"subflow","name":"Calefaccion","info":"Referencia de NEST (dashboard): https://flows.nodered.org/flow/6e4649bc6d6529078cbb731610242eac\n\n1.  Se utilizan varias variables globales para almacenar la información de estado.\n    'ambient':nest1_ambient_temperature\n    'target': nest1_target_temperature\n    'state':  nest1_hvac_state\n    'flame':  nest1_flame\"\n\n2.  Se unifica todo en un json en le modulo de \"Mqtt Json\" para poder enviarlo al feed\n\n3.Para los cambios de CSS se ha introducido el modulo \"dashboard CSS\" dentro del flow de Graficos 1 (se puede situar en cualquier parte)\n\n4. Salida 1 se puede utilizar para SQL\n   ejemplo: INSERT INTO `control`( `ambient`,`target`,`state`,`flame`) VALUES ('{{payload.ambient}}','{{payload.target}}','{{payload.state}}','{{payload.flame}}');\n\n5. Se ha modificado el module nest para tener un led y la temperatura sin redondear.\n\n\n6.Datos configurables del modulo\n    MQTT_Termometro_info\n        #Topic Recepción de información de temperatura de termometro\n        \n    MQTT_Ordenes_Cale\n        #Topic Envío de ordenes a controlador de calefacción\n        \n    MQTT_Ordenes_Termo\n        #Topic envío de ordenes de control de termometro\n        \n    MQTT_Termometro_Time\n        #Topic donde se envía el cambio de tiempo de perido de stanby de termometro de calefacción.\n    \n    MQTT_Periodo_Termo_Off\n        Periodo de stanby para lectura de temperatura de termometro cuando la calefección está apagada. (En microsegundos)\n        \n    MQTT_Periodo_Termo_On\n        Periodo de stanby para lectura de temperatura de termometro cuando la calefección está encendida. (En microsegundos)\n        \n    Histeresis\n        Diferencia de espera para volver a encender la llama de calefacción. (evita el encendido y apagado constante)\n    \n    \n","category":"","in":[{"x":50,"y":30,"wires":[{"id":"15dc45f5.b9bc1a"}]}],"out":[{"x":2020,"y":240,"wires":[{"id":"dc55e7cf.10e578","port":0}]},{"x":1080,"y":1060,"wires":[{"id":"eb3cab85.579e48","port":0}]}],"env":[{"name":"MQTT_Termometro_info","type":"str","value":"persia/temp"},{"name":"MQTT_Ordenes_Cale","type":"str","value":"persia/calefaccion"},{"name":"Histeresis","type":"num","value":"0.3"},{"name":"MQTT_Ordenes_Termo","type":"str","value":"persia/termo/order"},{"name":"MQTT_Termometro_Time","type":"str","value":"persia/termo2/time"},{"name":"MQTT_Periodo_Termo_On","type":"str","value":"{\"time\": \"2e8\"}"},{"name":"MQTT_Periodo_Termo_Off","type":"str","value":"{\"time\": \"9e8\"}"}],"meta":{},"color":"#DDAA99","inputLabels":["Alexa"],"outputLabels":["Paquete de MQTT","Estado de llama"],"status":{"x":460,"y":760,"wires":[{"id":"205dac73.687c14","port":0}]}},{"id":"95ea86bf.d2cda","type":"group","z":"ccc70095.e8d18","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["1ee0a562.b6651b"],"x":1484,"y":139},{"id":"cc03406e.951f78","type":"mqtt-broker","name":"Local_echao","broker":"192.168.3.181","port":"1883","clientid":"server","usetls":false,"compatmode":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"birthTopic":"Hola!","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"sessionExpiry":""},{"id":"f9f94cb8.ee3658","type":"ui_tab","name":"Configuración","icon":"dashboard","order":3,"disabled":false,"hidden":false},{"id":"e17c708f.551c6","type":"ui_group","name":"Interna","tab":"f9f94cb8.ee3658","order":4,"disp":true,"width":6,"collapse":true},{"id":"f360b055.14aa98","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false,"reset":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","reset":false},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":true},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey","palette":"light"}},"site":{"name":"Persia - Node-RED ","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":7,"gy":7,"cx":7,"cy":7,"px":0,"py":0}}},{"id":"bdcba475.3f451","type":"ui_group","name":"Externa","tab":"f9f94cb8.ee3658","order":5,"disp":true,"width":6,"collapse":true},{"id":"24ec8664.0046ea","type":"ui_group","name":"Configuración","tab":"f9f94cb8.ee3658","order":2,"disp":true,"width":"6","collapse":true,"className":""},{"id":"92bf5dd4.6916f8","type":"ui_group","name":"Humedad","tab":"","order":1,"disp":true,"width":8,"collapse":false},{"id":"e0fcee29.3d10c8","type":"ui_group","name":"Temperatura","tab":"","order":2,"disp":true,"width":8,"collapse":false},{"id":"4cab9f17.1e3dc","type":"MySQLdatabase","name":"calefaccion","host":"192.168.3.181","port":"3306","db":"calefaccion","tz":"","charset":""},{"id":"7e1201e0.3a026","type":"ui_group","name":"Default","tab":"","disp":true,"width":"6"},{"id":"1b64051d.e0c82b","type":"ui_group","name":"Default","tab":"3b3fa94a.563c0e","order":3,"disp":true,"width":"6","collapse":false},{"id":"1cc2ab22.16574d","type":"mqtt-broker","name":"paul_broker","broker":"192.168.1.8","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"77e7a084.a7421","type":"ui_group","name":"Remote relay","tab":"","disp":true,"width":"4","collapse":false},{"id":"ebaa9ce8.097a38","type":"ui_group","name":"GAUGE INPUT SELECTOR","tab":"","order":1,"disp":true,"width":8,"collapse":false},{"id":"a3c74eb.0c015b","type":"ui_group","name":"GAUGE INPUT SELECTOR","tab":"","disp":true,"width":8,"collapse":false},{"id":"1b2482ce.9d5025","type":"ui_group","name":"Test tab","tab":"","disp":true,"width":"6","collapse":false},{"id":"b84209ee.f4b318","type":"mqtt-broker","name":"Homey MQTT","broker":"192.168.1.22","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"2db3afb4.5d879","type":"ui_group","name":"Default","tab":"","order":1,"disp":true,"width":"6","collapse":false},{"id":"45adb211.c11d1c","type":"alexa-home-conf","username":"_echao_"},{"id":"65deacaa.c1e404","type":"alexa-home-conf","username":"_echao_"},{"id":"d02bbcae.80504","type":"alexa-home-conf","username":"echao"},{"id":"60a199.33c71668","type":"ui_group","d":true,"name":"Server Status","tab":"f9f94cb8.ee3658","order":3,"disp":true,"width":6,"collapse":true},{"id":"d027ab97.3a492","type":"websocket-listener","path":"/socket","wholemsg":"false"},{"id":"6cef0b3c.fc1fa4","type":"mqtt-broker","name":"","broker":"iot.eclipse.org","port":"1883","clientid":"","usetls":false,"protocolVersion":4,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"80677e24.b1fa78","type":"ui_group","name":"Home_Status","tab":"d8a3365d.44e008","order":2,"disp":false,"width":"6","collapse":false,"className":""},{"id":"2007caa7.9dc636","type":"ui_group","name":"Server CPU","tab":"f9f94cb8.ee3658","order":7,"disp":true,"width":6,"collapse":true},{"id":"d8596899.c56458","type":"ui_group","name":"Default","tab":"","order":2,"disp":true,"width":"6","collapse":false},{"id":"763720f9.ddf278","type":"ui_link","name":"Torrent","link":"http://192.168.3.151:9091/transmission/web/","icon":"open_in_browser","target":"newtab","order":4},{"id":"4cc5f390.dd914c","type":"ui_group","name":"Taller","tab":"f9f94cb8.ee3658","order":6,"disp":true,"width":6,"collapse":true},{"id":"fa7adc1e.6f7dd","type":"ui_group","name":"Taller-Speed","tab":"f9f94cb8.ee3658","order":8,"disp":true,"width":6,"collapse":true},{"id":"c74f3b99.2071a8","type":"ui_spacer","name":"spacer","group":"","order":9,"width":1,"height":1},{"id":"bb7e6d7b.ea72","type":"ui_spacer","name":"spacer","group":"","order":11,"width":3,"height":1},{"id":"407d8879.5943c8","type":"ui_spacer","name":"spacer","group":"","order":15,"width":3,"height":1},{"id":"211b15b5.0fff2a","type":"ui_spacer","name":"spacer","group":"","order":17,"width":1,"height":1},{"id":"b35a7fa4.c64b2","type":"ui_spacer","name":"spacer","group":"","order":22,"width":3,"height":1},{"id":"7e45dca1.4aba74","type":"ui_spacer","name":"spacer","group":"60a199.33c71668","order":3,"width":3,"height":1},{"id":"edbd7a1d.1a08c8","type":"ui_spacer","name":"spacer","group":"60a199.33c71668","order":5,"width":6,"height":1},{"id":"52aebd83.59f734","type":"ui_spacer","name":"spacer","group":"60a199.33c71668","order":7,"width":1,"height":1},{"id":"8a50f58a.83fee8","type":"ui_group","name":"Nest","tab":"d8a3365d.44e008","order":1,"disp":false,"width":"6","collapse":false,"className":""},{"id":"d8a3365d.44e008","type":"ui_tab","name":"Nest Thermostat","icon":"dashboard","order":2,"disabled":false,"hidden":false},{"id":"dc53cc09.4e298","type":"ui_group","name":"Form & Switch","tab":"1854ea3c.181436","order":1,"disp":true,"width":"6","collapse":false},{"id":"1854ea3c.181436","type":"ui_tab","name":"Home","icon":"dashboard","order":1,"disabled":false,"hidden":false},{"id":"b9a8e55f.6a5a68","type":"ui_spacer","z":"ccc70095.e8d18","name":"spacer","group":"ce936d85.893a8","order":3,"width":1,"height":1},{"id":"2ebbffee.bc9c3","type":"ui_spacer","z":"f996f74a.c8c748","name":"spacer","group":"","order":4,"width":"3","height":"1","className":""},{"id":"6145a423.45245c","type":"ui_spacer","z":"4c31633a.905f9c","name":"spacer","group":"ace3971e.5dae38","order":3,"width":1,"height":1},{"id":"47562201.21775c","type":"ui_group","name":"Opcional","tab":"d8a3365d.44e008","order":4,"disp":true,"width":"6","collapse":true,"className":""},{"id":"6f32de3d.bc927","type":"ui_group","name":"Botones_Persiana","tab":"d8a3365d.44e008","order":3,"disp":false,"width":"6","collapse":false,"className":""},{"id":"3126297a.d3bfce","type":"ui_switch","z":"9fe9cc56.678888","name":"","label":"Auto - Externo","tooltip":"","group":"24ec8664.0046ea","order":1,"width":0,"height":0,"passthru":false,"decouple":"true","topic":"persia/per2/mode","style":"","onvalue":"{\"mode\":\"auto\",\"time\": 20000}","onvalueType":"json","onicon":"fa-power-off","oncolor":"green","offvalue":"{\"mode\":\"standard\",\"time\": 20000}","offvalueType":"json","officon":"fa-power-off","offcolor":"red","x":500,"y":180,"wires":[["8918d538.a95e8"]]},{"id":"8918d538.a95e8","type":"mqtt out","z":"9fe9cc56.678888","name":"MQTT - Retain payload","topic":"","qos":"2","retain":"true","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"cc03406e.951f78","x":930,"y":160,"wires":[]},{"id":"148d71d4.8a502e","type":"ui_switch","z":"9fe9cc56.678888","name":"","label":"Auto - Interior","tooltip":"","group":"24ec8664.0046ea","order":2,"width":0,"height":0,"passthru":false,"decouple":"true","topic":"persia/termo/mode","style":"","onvalue":"{\"mode\":\"auto\",\"time\": 20000}","onvalueType":"json","onicon":"fa-power-off","oncolor":"green","offvalue":"{\"mode\":\"standard\",\"time\":20000}","offvalueType":"json","officon":"fa-power-off","offcolor":"red","x":500,"y":120,"wires":[["8918d538.a95e8"]]},{"id":"292b8cc6.4f5734","type":"ui_button","z":"9fe9cc56.678888","name":"","group":"24ec8664.0046ea","order":8,"width":2,"height":1,"passthru":false,"label":"GetInfo","tooltip":"","color":"","bgcolor":"","className":"","icon":"fa-rss fa-x2","payload":"{\"order\":\"getInfo\"}","payloadType":"json","topic":"persia/general","topicType":"str","x":480,"y":240,"wires":[["8918d538.a95e8"]]},{"id":"758d4dd2.615cdc","type":"comment","z":"9fe9cc56.678888","name":"Botones Control","info":"","x":80,"y":60,"wires":[]},{"id":"c95b30d6.9880a8","type":"json","z":"9fe9cc56.678888","name":"","property":"payload","action":"","pretty":false,"x":350,"y":120,"wires":[["148d71d4.8a502e"]]},{"id":"3f02deb8.cfe0ba","type":"mqtt in","z":"9fe9cc56.678888","name":"","topic":"persia/termo/mode","qos":"2","datatype":"auto","broker":"cc03406e.951f78","x":190,"y":120,"wires":[["c95b30d6.9880a8"]]},{"id":"6a91ba02.8c4e94","type":"json","z":"9fe9cc56.678888","name":"","property":"payload","action":"","pretty":false,"x":350,"y":180,"wires":[["3126297a.d3bfce"]]},{"id":"4715a99d.e76258","type":"mqtt in","z":"9fe9cc56.678888","name":"","topic":"persia/per2/mode","qos":"1","datatype":"auto","broker":"cc03406e.951f78","x":190,"y":180,"wires":[["6a91ba02.8c4e94"]]},{"id":"22e784c8.f09d5c","type":"mysql","z":"6f26701.f6c739","d":true,"mydb":"4cab9f17.1e3dc","name":"","x":860,"y":280,"wires":[["c42aed8b.177c2"]]},{"id":"c42aed8b.177c2","type":"debug","z":"6f26701.f6c739","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1130,"y":280,"wires":[]},{"id":"fe07c2bc.1f5638","type":"inject","z":"6f26701.f6c739","name":"","props":[{"p":"payload","v":"","vt":"str"},{"p":"topic","v":"select * from tempera","vt":"string"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"select * from tempera","payload":"","payloadType":"str","x":200,"y":80,"wires":[["22e784c8.f09d5c"]]},{"id":"3b8cc3e.c9fe3bc","type":"inject","z":"6f26701.f6c739","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"INSERT INTO `tempera`( `temp_int`, `hume_int`, `temp_out`, `hume_out`) VALUES (\"22\",\"60.5\",\"15.5\",\"70.5\")","payload":"","payloadType":"str","x":150,"y":140,"wires":[["22e784c8.f09d5c"]]},{"id":"470bcc2b.20ead4","type":"link in","z":"6f26701.f6c739","name":"","links":["bac50edd.b150e"],"x":95,"y":260,"wires":[["9e1df719.ae1ad8"]]},{"id":"58e17682.ec9578","type":"debug","z":"6f26701.f6c739","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":870,"y":500,"wires":[]},{"id":"1e23572f.0c4699","type":"template","z":"6f26701.f6c739","name":"insert","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `tempera`( `temp_int`) VALUES ('{{payload}}');\n","output":"str","x":410,"y":260,"wires":[["22e784c8.f09d5c","58e17682.ec9578"]]},{"id":"9e1df719.ae1ad8","type":"delay","z":"6f26701.f6c739","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":250,"y":260,"wires":[["1e23572f.0c4699"]]},{"id":"5a5b112f.77977","type":"link in","z":"6f26701.f6c739","name":"","links":["c2f96f0a.a4806"],"x":95,"y":340,"wires":[["fbfc2c73.e56418"]]},{"id":"ca40153.6317f68","type":"template","z":"6f26701.f6c739","name":"insert","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `tempera`( `hume_int`) VALUES ('{{payload}}');\n","output":"str","x":410,"y":340,"wires":[["22e784c8.f09d5c","58e17682.ec9578"]]},{"id":"fbfc2c73.e56418","type":"delay","z":"6f26701.f6c739","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":250,"y":340,"wires":[["ca40153.6317f68"]]},{"id":"a409c06c.4c885","type":"link in","z":"6f26701.f6c739","name":"","links":["4d51e19d.8f1f88"],"x":95,"y":440,"wires":[["15bccc56.f7ecec"]]},{"id":"d0332a15.807","type":"template","z":"6f26701.f6c739","name":"insert","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `tempera`( `temp_out`) VALUES ('{{payload}}');\n","output":"str","x":410,"y":440,"wires":[["22e784c8.f09d5c","58e17682.ec9578"]]},{"id":"15bccc56.f7ecec","type":"delay","z":"6f26701.f6c739","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":250,"y":440,"wires":[["d0332a15.807"]]},{"id":"5b5ff363.5b4c7c","type":"link in","z":"6f26701.f6c739","name":"","links":["e64d7026.56855"],"x":95,"y":500,"wires":[["dcb63db5.f8a3e8"]]},{"id":"b9adc8f7.a82f2","type":"template","z":"6f26701.f6c739","name":"insert","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `tempera`( `hume_out`) VALUES ('{{payload}}');\n","output":"str","x":410,"y":500,"wires":[["22e784c8.f09d5c","58e17682.ec9578"]]},{"id":"dcb63db5.f8a3e8","type":"delay","z":"6f26701.f6c739","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":250,"y":500,"wires":[["b9adc8f7.a82f2"]]},{"id":"fa48ecee.6ecca","type":"alexa-home","z":"f3d60e61.2dd1f8","d":true,"conf":"45adb211.c11d1c","device":"100074","acknoledge":false,"name":"calefacción","topic":"","x":70,"y":40,"wires":[["66614344.de9284","7d16323e.5f56cc"]],"info":"https://alexa-node-red.bm.hardill.me.uk/docs"},{"id":"66614344.de9284","type":"switch","z":"f3d60e61.2dd1f8","name":"","property":"command","propertyType":"msg","rules":[{"t":"eq","v":"TurnOnRequest","vt":"str"},{"t":"eq","v":"DecrementTargetTemperatureRequest","vt":"str"},{"t":"eq","v":"TurnOffRequest","vt":"str"},{"t":"eq","v":"SetTargetTemperatureRequest","vt":"str"},{"t":"eq","v":"GetTemperatureReadingRequest","vt":"str"},{"t":"eq","v":"IncrementTargetTemperatureRequest","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":210,"y":200,"wires":[["36cefbd3.a6638c"],["e0fc3e7.6937b4"],["68d864b4.7177f4"],["33287194.4085ce"],["d1090891.a9a77"],["62d98263.88643c"]]},{"id":"56999b3d.568334","type":"mqtt out","z":"f3d60e61.2dd1f8","name":"","topic":"persia/calefaccion","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"cc03406e.951f78","x":970,"y":120,"wires":[]},{"id":"36cefbd3.a6638c","type":"change","z":"f3d60e61.2dd1f8","name":"Calefaccion - ON","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"on\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":470,"y":120,"wires":[["e09e5867.c95ec8","c6f15747.847d88","63db398e.11cda8"]]},{"id":"68d864b4.7177f4","type":"change","z":"f3d60e61.2dd1f8","name":"Calefaccion - OFF","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"off\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":470,"y":320,"wires":[["e09e5867.c95ec8","a281ebef.37dbc8","c6f15747.847d88"]]},{"id":"d2ffc55.cdb19b8","type":"alexa-home-resp","z":"f3d60e61.2dd1f8","x":1400,"y":60,"wires":[]},{"id":"d2698afc.ed878","type":"change","z":"f3d60e61.2dd1f8","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":970,"y":60,"wires":[["d2ffc55.cdb19b8","922ba635.635788"]]},{"id":"3d99a0ef.9cdd08","type":"change","z":"f3d60e61.2dd1f8","name":"Termo - geTemp","rules":[{"t":"set","p":"extra","pt":"msg","to":"{\"temperatureReading\": {\"value\": 20}}","tot":"json"},{"t":"set","p":"extra.temperatureReading.value","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1080,"y":500,"wires":[["a23c9705.c1fce"]]},{"id":"33287194.4085ce","type":"change","z":"f3d60e61.2dd1f8","name":"Calefaccion -setTemp","rules":[{"t":"set","p":"extra","pt":"msg","to":"{\"targetTemperature\":{\"value\":24}}","tot":"json"},{"t":"set","p":"extra.targetTemperature.value","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":480,"y":380,"wires":[["e09e5867.c95ec8","f72adcdb.ac9d1","1961083e.de253"]]},{"id":"50b587c9.845bd","type":"tcp request","z":"f3d60e61.2dd1f8","server":"192.168.3.181","port":"2000","out":"time","splitc":"0","name":"","x":650,"y":500,"wires":[["ff92baaa.cf2318"]]},{"id":"ff92baaa.cf2318","type":"function","z":"f3d60e61.2dd1f8","name":"ASCII to String","func":"msg.payload = msg.payload.toString()\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":860,"y":500,"wires":[["3d99a0ef.9cdd08","4a79f5be.68fed4"]]},{"id":"820884ed.8ba2c","type":"function","z":"f3d60e61.2dd1f8","name":"hlocalTemp","func":"msg.payload = \"hlocalTemp\"\nreturn msg;\n//Temperatura actual en interior","outputs":1,"noerr":0,"initialize":"","finalize":"","x":450,"y":500,"wires":[["50b587c9.845bd"]]},{"id":"a23c9705.c1fce","type":"link out","z":"f3d60e61.2dd1f8","name":"Alexa-out","links":["6b4d1f6f.e0182"],"x":1215,"y":500,"wires":[]},{"id":"6b4d1f6f.e0182","type":"link in","z":"f3d60e61.2dd1f8","name":"Alexa-out","links":["14c46a14.cf7666","a23c9705.c1fce","e09e5867.c95ec8","c5d5bb93.813cf8","a492f08e.756cb"],"x":815,"y":60,"wires":[["d2698afc.ed878"]]},{"id":"e09e5867.c95ec8","type":"link out","z":"f3d60e61.2dd1f8","name":"","links":["6b4d1f6f.e0182"],"x":735,"y":200,"wires":[]},{"id":"e0fc3e7.6937b4","type":"change","z":"f3d60e61.2dd1f8","name":"Calefaccion -decreTemp","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"decre\":msg.payload}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":490,"y":200,"wires":[["e09e5867.c95ec8","c6f15747.847d88"]]},{"id":"f72adcdb.ac9d1","type":"function","z":"f3d60e61.2dd1f8","name":"Cale-Temp","func":"msg.payload = \"hStay,\"+msg.extra.targetTemperature.value;\nreturn msg;","outputs":1,"noerr":0,"x":790,"y":380,"wires":[["89d4212b.820c"]]},{"id":"89d4212b.820c","type":"tcp request","z":"f3d60e61.2dd1f8","server":"192.168.3.181","port":"2000","out":"time","splitc":"0","name":"","x":1050,"y":380,"wires":[["790f814b.cfcff"]]},{"id":"790f814b.cfcff","type":"function","z":"f3d60e61.2dd1f8","name":"ASCII to String","func":"msg.payload = msg.payload.toString()\nreturn msg","outputs":1,"noerr":0,"x":1300,"y":380,"wires":[[]]},{"id":"a281ebef.37dbc8","type":"function","z":"f3d60e61.2dd1f8","name":"Cale-OFF","func":"msg.payload = \"hOff,5\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":780,"y":320,"wires":[["89d4212b.820c","c79c0012.4aa438"]]},{"id":"b79fdd4e.357d7","type":"function","z":"f3d60e61.2dd1f8","name":"Cale-Sube 1 temp actual","func":"msg.payload = \"hRaise,1\";\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":580,"wires":[["69dcd264.d2bb3c"]]},{"id":"7d16323e.5f56cc","type":"debug","z":"f3d60e61.2dd1f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":370,"y":40,"wires":[]},{"id":"62d98263.88643c","type":"change","z":"f3d60e61.2dd1f8","name":"Clefa- Incremento","rules":[{"t":"set","p":"extra","pt":"msg","to":"{\"targetTemperature\":{\"value\":24}}","tot":"json"},{"t":"set","p":"extra.targetTemperature.value","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":470,"y":580,"wires":[["b79fdd4e.357d7","f9bb68f5.fe3db8"]]},{"id":"14c46a14.cf7666","type":"link out","z":"f3d60e61.2dd1f8","name":"","links":["6b4d1f6f.e0182"],"x":1515,"y":700,"wires":[]},{"id":"69dcd264.d2bb3c","type":"tcp request","z":"f3d60e61.2dd1f8","server":"192.168.3.181","port":"2000","out":"time","splitc":"0","name":"","x":1050,"y":580,"wires":[["790f814b.cfcff"]]},{"id":"d1775f.167ac8a","type":"change","z":"f3d60e61.2dd1f8","name":"Termo - geTemp","rules":[{"t":"set","p":"extra","pt":"msg","to":"{\"temperatureReading\": {\"value\": 20}}","tot":"json"},{"t":"set","p":"extra.temperatureReading.value","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"extra.targetTemperature.value","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1260,"y":700,"wires":[["151604ed.3e4e9b"]]},{"id":"2b6246ee.1ea0ea","type":"tcp request","z":"f3d60e61.2dd1f8","server":"192.168.3.181","port":"2000","out":"time","splitc":"0","name":"","x":830,"y":700,"wires":[["a8229307.7b4c3"]]},{"id":"a8229307.7b4c3","type":"function","z":"f3d60e61.2dd1f8","name":"ASCII to String","func":"msg.payload = msg.payload.toString()\nreturn msg","outputs":1,"noerr":0,"x":1060,"y":700,"wires":[["d1775f.167ac8a"]]},{"id":"f9bb68f5.fe3db8","type":"function","z":"f3d60e61.2dd1f8","name":"hlocalTemp","func":"msg.payload = \"hlocalTemp\"\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":700,"wires":[["2b6246ee.1ea0ea"]]},{"id":"151604ed.3e4e9b","type":"function","z":"f3d60e61.2dd1f8","name":"Suma","func":"var i = parseInt(msg.extra.temperatureReading.value);\ni = i +1;\n\nmsg.extra.targetTemperature.value = i;\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1410,"y":700,"wires":[["14c46a14.cf7666","b2303033.4088b"]]},{"id":"c6f15747.847d88","type":"link out","z":"f3d60e61.2dd1f8","name":"mqtt","links":["68c5c419.a1b3f4"],"x":735,"y":120,"wires":[]},{"id":"68c5c419.a1b3f4","type":"link in","z":"f3d60e61.2dd1f8","name":"","links":["c6f15747.847d88","4a79f5be.68fed4","44922194.426228","97c5fd39.7b0048","4103b6d8.3783e8"],"x":815,"y":120,"wires":[["56999b3d.568334","c79c0012.4aa438"]]},{"id":"4a79f5be.68fed4","type":"link out","z":"f3d60e61.2dd1f8","name":"mqtt","links":["68c5c419.a1b3f4"],"x":1015,"y":440,"wires":[]},{"id":"63db398e.11cda8","type":"function","z":"f3d60e61.2dd1f8","name":"Cale-20 - 21.5","func":"msg.payload = \"hStay,20\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":800,"y":260,"wires":[["89d4212b.820c","c79c0012.4aa438"]]},{"id":"4103b6d8.3783e8","type":"link out","z":"f3d60e61.2dd1f8","name":"mqtt","links":["68c5c419.a1b3f4"],"x":1415,"y":640,"wires":[]},{"id":"7d1f67fd.26abe8","type":"comment","z":"f3d60e61.2dd1f8","name":"","info":"Comprobar que recibo Temp cada 25 segundos para encender y apagar led","x":940,"y":180,"wires":[]},{"id":"685c25e9.0b067c","type":"ssh-client","z":"ccc70095.e8d18","d":true,"debug":false,"ssh":"","hostname":"192.168.3.151","name":"servidor","x":540,"y":560,"wires":[[]]},{"id":"8babaf97.76475","type":"function","z":"ccc70095.e8d18","name":"Sudo Shutdown -r","func":"msg.payload = \"sudo /sbin/shutdown -r now\";\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":560,"wires":[["685c25e9.0b067c"]]},{"id":"9dbaa87d.2e50d8","type":"inject","z":"ccc70095.e8d18","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":100,"y":560,"wires":[["8babaf97.76475"]]},{"id":"54b39485.f07cec","type":"function","z":"ccc70095.e8d18","name":"RPI-server","func":"msg.payload = \"server,1\";\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":620,"wires":[["77856d7d.a0e4b4"]]},{"id":"77856d7d.a0e4b4","type":"tcp request","z":"ccc70095.e8d18","server":"192.168.3.181","port":"2000","out":"time","splitc":"0","name":"","x":490,"y":620,"wires":[[]]},{"id":"b8bc7737.5c8218","type":"inject","z":"ccc70095.e8d18","name":"","props":[{"p":"payload","v":"","vt":"date"},{"p":"topic","v":"","vt":"string"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":100,"y":620,"wires":[["54b39485.f07cec"]]},{"id":"7df6a766.21be88","type":"comment","z":"ccc70095.e8d18","name":"","info":"Sirve para poder apagar el server.\nEl primero conectando directamente por ssh\nEl segundo manda el comando server al Servidor python de Rpi","x":97.14285278320312,"y":510,"wires":[]},{"id":"5f419ecf.4ce1e","type":"ui_led","z":"ccc70095.e8d18","order":2,"group":"60a199.33c71668","width":3,"height":1,"label":"Server","labelPlacement":"left","labelAlignment":"left","colorForValue":[{"color":"red","value":"false","valueType":"bool"},{"color":"green","value":"true","valueType":"str"},{"color":"green","value":"true","valueType":"bool"}],"allowColorForValueInMessage":false,"shape":"circle","showGlow":true,"name":"","x":710,"y":100,"wires":[]},{"id":"c5a4468a.7c2f3","type":"tcp in","z":"ccc70095.e8d18","name":"","server":"server","host":"","port":"1881","datamode":"stream","datatype":"buffer","newline":"","topic":"payload","base64":false,"x":100,"y":100,"wires":[["3388c60e.477312","22650dd9.e210ba"]]},{"id":"612492e7.a0821c","type":"inject","z":"ccc70095.e8d18","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"true","payloadType":"bool","x":90,"y":180,"wires":[["a09cb5f4.215cb8","1fe763fd.6df044"]]},{"id":"a09cb5f4.215cb8","type":"timeouttrigger","z":"ccc70095.e8d18","ontimeouttype":"bool","ontimeoutval":"false","duration":"5","units":"s","name":"","x":450,"y":160,"wires":[["5f419ecf.4ce1e","fec08578.dd151"]]},{"id":"d6870f1b.da06e","type":"comment","z":"ccc70095.e8d18","name":"","info":"Control de estado de encendido del server","x":100,"y":40,"wires":[]},{"id":"1454438a.d58284","type":"switch","z":"ccc70095.e8d18","name":"","property":"payload.name","propertyType":"msg","rules":[{"t":"eq","v":"core_1","vt":"str"},{"t":"eq","v":"core_2","vt":"str"},{"t":"eq","v":"core_3","vt":"str"},{"t":"eq","v":"core_4","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":1150,"y":260,"wires":[["14e96d43.812503"],["6ea32bc1.5e4a2c"],["fbfb53eb.1be5c"],["f40731b3.4e592"]]},{"id":"1983e55d.3c2d53","type":"function","z":"ccc70095.e8d18","name":"ASCII to String","func":"msg.payload = \"true\";\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":480,"y":100,"wires":[["5f419ecf.4ce1e","fec08578.dd151"]]},{"id":"1fe763fd.6df044","type":"function","z":"ccc70095.e8d18","name":"ASCII to String","func":"msg.payload = msg.payload.toString();\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":480,"y":260,"wires":[["cd8eefc9.ab146"]]},{"id":"20ef86bf.1c515a","type":"json","z":"ccc70095.e8d18","name":"","property":"payload","action":"","pretty":false,"x":850,"y":260,"wires":[["d5e1fddb.b426c8"]]},{"id":"d5e1fddb.b426c8","type":"split","z":"ccc70095.e8d18","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":990,"y":260,"wires":[["1454438a.d58284","98c329f6.2b0fc"]]},{"id":"14e96d43.812503","type":"function","z":"ccc70095.e8d18","name":"ASCII to String","func":"msg.payload = msg.payload.usage;\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1360,"y":180,"wires":[["1ee0a562.b6651b"]]},{"id":"894036cf.c84a1","type":"ui_gauge","z":"ccc70095.e8d18","name":"","group":"2007caa7.9dc636","order":2,"width":3,"height":3,"gtype":"gage","title":"CPU-2","label":"units","format":"{{value}}","min":"1","max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":1560,"y":240,"wires":[]},{"id":"6ea32bc1.5e4a2c","type":"function","z":"ccc70095.e8d18","name":"ASCII to String","func":"msg.payload = msg.payload.usage;\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1360,"y":240,"wires":[["894036cf.c84a1"]]},{"id":"fc0eee9e.2f9988","type":"ui_gauge","z":"ccc70095.e8d18","name":"","group":"2007caa7.9dc636","order":3,"width":3,"height":3,"gtype":"gage","title":"CPU-3","label":"units","format":"{{value}}","min":"1","max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":1560,"y":300,"wires":[]},{"id":"fbfb53eb.1be5c","type":"function","z":"ccc70095.e8d18","name":"ASCII to String","func":"msg.payload = msg.payload.usage;\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1360,"y":300,"wires":[["fc0eee9e.2f9988"]]},{"id":"966bb08c.a0ce38","type":"ui_gauge","z":"ccc70095.e8d18","name":"","group":"2007caa7.9dc636","order":4,"width":3,"height":3,"gtype":"gage","title":"CPU-4","label":"units","format":"{{value}}","min":"1","max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":1560,"y":360,"wires":[]},{"id":"f40731b3.4e592","type":"function","z":"ccc70095.e8d18","name":"ASCII to String","func":"msg.payload = msg.payload.usage;\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1360,"y":360,"wires":[["966bb08c.a0ce38"]]},{"id":"98c329f6.2b0fc","type":"timeouttrigger","z":"ccc70095.e8d18","ontimeouttype":"num","ontimeoutval":"0","duration":"4","units":"s","name":"","x":1230,"y":440,"wires":[["e1b74c19.e4b6c"]]},{"id":"ca29897e.c22a58","type":"comment","z":"ccc70095.e8d18","name":"","info":"Resetear los contadores\n","x":780,"y":640,"wires":[]},{"id":"e1b74c19.e4b6c","type":"switch","z":"ccc70095.e8d18","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1370,"y":440,"wires":[["894036cf.c84a1","fc0eee9e.2f9988","966bb08c.a0ce38","1ee0a562.b6651b"]]},{"id":"86125c3d.2b6c3","type":"link out","z":"fa9b3c4d.e0031","name":"Control_Persia_Ordenador","links":["989eb1ab.13533","7466fde3.5274e4"],"x":495,"y":140,"wires":[]},{"id":"cbd933b2.d095f","type":"switch","z":"fa9b3c4d.e0031","name":"","property":"payload","propertyType":"msg","rules":[{"t":"true"},{"t":"false"},{"t":"eq","v":"off","vt":"str"},{"t":"eq","v":"cancel","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":690,"y":280,"wires":[["8c96d5c0.166568","63deb08e.b89d3"],["752a7994.a26658","810d022d.ab013"],["7d523ed3.374f8"],["63deb08e.b89d3","810d022d.ab013"]]},{"id":"989eb1ab.13533","type":"link in","z":"fa9b3c4d.e0031","name":"decision total","links":["86125c3d.2b6c3","fa52b803.f4e088","91ad1bf6.ca80c8","16747088.6b6eaf"],"x":595,"y":280,"wires":[["cbd933b2.d095f"]]},{"id":"8c96d5c0.166568","type":"change","z":"fa9b3c4d.e0031","name":"Sube","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"up\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":870,"y":260,"wires":[["30b1ea54.fc8306"]]},{"id":"7d523ed3.374f8","type":"change","z":"fa9b3c4d.e0031","name":"Stop","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"stop\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":870,"y":380,"wires":[["30b1ea54.fc8306"]]},{"id":"b4ed1e8a.9e2d1","type":"json","z":"fa9b3c4d.e0031","name":"","property":"payload","action":"obj","pretty":false,"x":1030,"y":200,"wires":[["30b1ea54.fc8306"]]},{"id":"b27682da.71eec","type":"link in","z":"fa9b3c4d.e0031","name":"persia/per3/order","links":["c89d7483.38f288","5058a9b1.fe5938","30b1ea54.fc8306","4d8441a.98b09c","7759fb5a.cc4984"],"x":895,"y":40,"wires":[["61cc1390.a0768c"]]},{"id":"30b1ea54.fc8306","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["b27682da.71eec"],"x":1155,"y":280,"wires":[]},{"id":"752a7994.a26658","type":"change","z":"fa9b3c4d.e0031","name":"baja","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"down\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":870,"y":300,"wires":[["30b1ea54.fc8306"]]},{"id":"13bf59d2.f6f2d6","type":"switch","z":"fa9b3c4d.e0031","name":"","property":"command","propertyType":"msg","rules":[{"t":"eq","v":"SetPercentageRequest","vt":"str"},{"t":"eq","v":"IncrementPercentageRequest","vt":"str"},{"t":"eq","v":"DecrementPercentageRequest","vt":"str"}],"checkall":"false","repair":false,"outputs":3,"x":610,"y":80,"wires":[["f445fe6d.13fcc"],["ff401842.c44608"],["d0956143.15e68"]]},{"id":"ca4eeb59.eda1b8","type":"range","z":"fa9b3c4d.e0031","minin":"0","maxin":"100","minout":"0","maxout":"${move_time}","action":"scale","round":false,"property":"payload","name":"conversor tiempo","x":530,"y":720,"wires":[["9ebd2d0e.11b35"]]},{"id":"d22bf217.e22cb","type":"mytimeout","z":"fa9b3c4d.e0031","name":"","outtopic":"","outsafe":"","outwarning":"","outunsafe":"off","warning":"","timer":"25","debug":false,"ndebug":false,"ignoreCase":false,"repeat":false,"again":false,"x":910,"y":680,"wires":[["91ad1bf6.ca80c8","a1aaf6fb.7f1a38"],[]]},{"id":"9ebd2d0e.11b35","type":"template","z":"fa9b3c4d.e0031","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"\n{ \n\"payload\": \"on\", \n\"timeout\": {{payload}}, \n\"warning\": true }","output":"json","x":740,"y":720,"wires":[["d22bf217.e22cb"]]},{"id":"f43e1571.5d99e8","type":"change","z":"fa9b3c4d.e0031","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":640,"wires":[["91ad1bf6.ca80c8"]]},{"id":"91ad1bf6.ca80c8","type":"link out","z":"fa9b3c4d.e0031","name":"Control_Persia_Ordenador","links":["989eb1ab.13533"],"x":1095,"y":640,"wires":[]},{"id":"668c607f.5e43c","type":"mytimeout","z":"fa9b3c4d.e0031","name":"","outtopic":"","outsafe":"","outwarning":"","outunsafe":"off","warning":"","timer":"25","debug":false,"ndebug":false,"ignoreCase":false,"repeat":false,"again":false,"x":910,"y":920,"wires":[["16747088.6b6eaf","53981b22.80f064"],[]]},{"id":"7f44b9a3.981f38","type":"template","z":"fa9b3c4d.e0031","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"\n{ \n\"payload\": \"on\", \n\"timeout\": {{payload}}, \n\"warning\": true }","output":"json","x":740,"y":960,"wires":[["668c607f.5e43c"]]},{"id":"2af01267.469e6e","type":"change","z":"fa9b3c4d.e0031","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":880,"wires":[["16747088.6b6eaf"]]},{"id":"16747088.6b6eaf","type":"link out","z":"fa9b3c4d.e0031","name":"Control_Persia_Ordenador","links":["989eb1ab.13533"],"x":1095,"y":880,"wires":[]},{"id":"c4b0adf0.a4f1f","type":"function","z":"fa9b3c4d.e0031","name":"","func":"var i = parseInt(msg.payload);\ni = i * -1;\n\nmsg.payload = i.toString();\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":740,"y":1040,"wires":[["7f44b9a3.981f38"]]},{"id":"ee528879.3e2628","type":"comment","z":"fa9b3c4d.e0031","name":"Incremento","info":"Rama para el incremento del 25%\n\nSube persiana","x":90,"y":620,"wires":[]},{"id":"30733c35.f1a6a4","type":"comment","z":"fa9b3c4d.e0031","name":"Decremento","info":"Rama para el Decremento del 25%.\n\nBaja persiana","x":90,"y":880,"wires":[]},{"id":"ff401842.c44608","type":"link out","z":"fa9b3c4d.e0031","name":"Incrementa out","links":["63b2bb59.a03e54"],"x":815,"y":80,"wires":[]},{"id":"63b2bb59.a03e54","type":"link in","z":"fa9b3c4d.e0031","name":"Incrementa-in","links":["fa52b803.f4e088","ff401842.c44608","2aee56b3.d7091a","f5de4fff.0afaf"],"x":135,"y":660,"wires":[["805bc423.e4fe68","da9fc3be.d4c69","b3395f62.8419b"]]},{"id":"1254df1e.3a0fe1","type":"link in","z":"fa9b3c4d.e0031","name":"Decrementa in","links":["fa52b803.f4e088","d0956143.15e68","29648235.bb2f9e"],"x":135,"y":920,"wires":[["9db1f41a.7f0548","3bd7906d.b0b47","83906244.912c58"]]},{"id":"d0956143.15e68","type":"link out","z":"fa9b3c4d.e0031","name":"Incrementa out","links":["1254df1e.3a0fe1"],"x":815,"y":120,"wires":[]},{"id":"f445fe6d.13fcc","type":"link out","z":"fa9b3c4d.e0031","name":"% out","links":["2510bc9f.9188f4"],"x":815,"y":40,"wires":[]},{"id":"63deb08e.b89d3","type":"mytimeout","z":"fa9b3c4d.e0031","name":"","outtopic":"","outsafe":"","outwarning":"","outunsafe":"{\"order\":\"stop\"}","warning":"","timer":"${move_time}","debug":false,"ndebug":false,"ignoreCase":false,"repeat":false,"again":false,"x":870,"y":200,"wires":[["b4ed1e8a.9e2d1","583a91e.7b94b7"],[]]},{"id":"810d022d.ab013","type":"mytimeout","z":"fa9b3c4d.e0031","name":"","outtopic":"","outsafe":"","outwarning":"","outunsafe":"{\"order\":\"stop\"}","warning":"","timer":"${move_time}","debug":false,"ndebug":false,"ignoreCase":false,"repeat":false,"again":false,"x":890,"y":340,"wires":[["30b1ea54.fc8306","66356958.6786f8"],[]]},{"id":"10e423e5.5edbec","type":"change","z":"fa9b3c4d.e0031","name":"reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"},{"t":"set","p":"payload","pt":"msg","to":"cancel","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":220,"wires":[["fa52b803.f4e088"]]},{"id":"805bc423.e4fe68","type":"switch","z":"fa9b3c4d.e0031","name":"Cancel","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"cancel","vt":"str"},{"t":"eq","v":"cancel","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":320,"y":660,"wires":[["f43e1571.5d99e8","b058471b.a644f8"],["d22bf217.e22cb"]]},{"id":"9db1f41a.7f0548","type":"switch","z":"fa9b3c4d.e0031","name":"Cancel","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"cancel","vt":"str"},{"t":"eq","v":"cancel","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":320,"y":900,"wires":[["2af01267.469e6e","bf701251.cdbf3"],["668c607f.5e43c"]]},{"id":"14ac0c13.77b9e4","type":"change","z":"fa9b3c4d.e0031","name":"Stop","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"stop\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":180,"wires":[["c89d7483.38f288"]]},{"id":"c89d7483.38f288","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["b27682da.71eec"],"x":495,"y":180,"wires":[]},{"id":"d15e2c1b.0d171","type":"link in","z":"fa9b3c4d.e0031","name":"Reset","links":["6a9e4975.0534a8","a1aaf6fb.7f1a38","53981b22.80f064"],"x":275,"y":180,"wires":[["10e423e5.5edbec","14ac0c13.77b9e4"]]},{"id":"2afb7067.454ce","type":"delay","z":"fa9b3c4d.e0031","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":360,"y":80,"wires":[["13bf59d2.f6f2d6","86125c3d.2b6c3"]]},{"id":"fa52b803.f4e088","type":"link out","z":"fa9b3c4d.e0031","name":"reset OUT","links":["989eb1ab.13533","2510bc9f.9188f4","63b2bb59.a03e54","1254df1e.3a0fe1","37dc1c07.9329f4","dced68ef.c21068","7466fde3.5274e4"],"x":495,"y":220,"wires":[]},{"id":"6a9e4975.0534a8","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["d15e2c1b.0d171"],"x":275,"y":140,"wires":[]},{"id":"8324c228.4dd19","type":"comment","z":"fa9b3c4d.e0031","name":"reset - previo","info":"Reseteo todos los contadores y espero 1 segundo para mandar la nueva orden","x":390,"y":40,"wires":[]},{"id":"f674de3f.a5ce4","type":"comment","z":"fa9b3c4d.e0031","name":"Selector Principal","info":"Aquí se seleccionan todas las ordenes y se envían a MQTT","x":680,"y":220,"wires":[]},{"id":"368f4488.8834cc","type":"function","z":"fa9b3c4d.e0031","name":"Local - 100%","func":"//var local=context.get('data') || {};\n\nvar local=flow.get('data') || {};\n\nlocal.count=100;\n\nflow.set('data',local);\n\nmsg.payload=local.count;\n\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":680,"y":1160,"wires":[["f1e0be21.5f5a","7092d534.1f47dc"]]},{"id":"2ecca3dd.3fe57c","type":"function","z":"fa9b3c4d.e0031","name":"Local - 0%","func":"//var local=context.get('data') || {};\n\nvar local=flow.get('data') || {};\n\nlocal.count=0;\n\nflow.set('data',local);\n\nmsg.payload=local.count;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":670,"y":1220,"wires":[["f1e0be21.5f5a","7092d534.1f47dc"]]},{"id":"20a5d872.abc028","type":"link in","z":"fa9b3c4d.e0031","name":"Local 100%","links":["583a91e.7b94b7"],"x":315,"y":1160,"wires":[["658bd69e.83f128"]]},{"id":"ed7609c6.517498","type":"link in","z":"fa9b3c4d.e0031","name":"Local 0%","links":["66356958.6786f8","ebd10f25.1d563"],"x":315,"y":1220,"wires":[["4cd0dfb2.2b296"]]},{"id":"66356958.6786f8","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["ed7609c6.517498"],"x":1075,"y":380,"wires":[]},{"id":"583a91e.7b94b7","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["20a5d872.abc028"],"x":995,"y":160,"wires":[]},{"id":"33be32a0.ddc82e","type":"function","z":"fa9b3c4d.e0031","name":"Local Suma","func":"var local=flow.get('data') || {};\n\nif (local.count===undefined)//test exists\n{\n  local.count=0;\n}\n\nvar i = parseInt(msg.payload);\n\nlocal.count +=i;\n\nflow.set('data',local);\n\nmsg.payload=local.count;\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":670,"y":1280,"wires":[["f1e0be21.5f5a","7092d534.1f47dc"]]},{"id":"3e1fe211.06a58e","type":"link in","z":"fa9b3c4d.e0031","name":"Local Suma","links":["da9fc3be.d4c69","74209058.c0c5c"],"x":315,"y":1280,"wires":[["8fa2e14e.6456d"]]},{"id":"3bd7906d.b0b47","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["ff7deb41.674b08"],"x":275,"y":960,"wires":[]},{"id":"da9fc3be.d4c69","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["3e1fe211.06a58e"],"x":235,"y":760,"wires":[]},{"id":"f1e0be21.5f5a","type":"debug","z":"fa9b3c4d.e0031","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":950,"y":1220,"wires":[]},{"id":"658bd69e.83f128","type":"switch","z":"fa9b3c4d.e0031","name":"Cancel","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"cancel","vt":"str"},{"t":"eq","v":"cancel","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":480,"y":1160,"wires":[["368f4488.8834cc"],[]]},{"id":"4cd0dfb2.2b296","type":"switch","z":"fa9b3c4d.e0031","name":"Cancel","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"cancel","vt":"str"},{"t":"eq","v":"cancel","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":480,"y":1220,"wires":[["2ecca3dd.3fe57c"],[]]},{"id":"8fa2e14e.6456d","type":"switch","z":"fa9b3c4d.e0031","name":"Cancel","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"cancel","vt":"str"},{"t":"eq","v":"cancel","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":480,"y":1280,"wires":[["33be32a0.ddc82e"],[]]},{"id":"53981b22.80f064","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["d15e2c1b.0d171"],"x":1095,"y":920,"wires":[]},{"id":"a1aaf6fb.7f1a38","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["d15e2c1b.0d171"],"x":1095,"y":680,"wires":[]},{"id":"fe645618.af2188","type":"function","z":"fa9b3c4d.e0031","name":"Local Resta","func":"var local=flow.get('data') || {};\n\nif (local.count===undefined)//test exists\n{\n  local.count=0;\n}\n\nvar i = parseInt(msg.payload);\ni = i * -1;\n\nlocal.count -=i;\n\nif (local.count < 0)//test exists\n{\n  local.count=0;\n}\n\nflow.set('data',local);\n\nmsg.payload=local.count;\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":670,"y":1340,"wires":[["f1e0be21.5f5a","7092d534.1f47dc"]]},{"id":"ff7deb41.674b08","type":"link in","z":"fa9b3c4d.e0031","name":"Local Resta","links":["3bd7906d.b0b47","9029e1c0.aa0c5"],"x":315,"y":1340,"wires":[["5d94dcb9.bd2dc4"]]},{"id":"5d94dcb9.bd2dc4","type":"switch","z":"fa9b3c4d.e0031","name":"Cancel","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"cancel","vt":"str"},{"t":"eq","v":"cancel","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":480,"y":1340,"wires":[["fe645618.af2188"],[]]},{"id":"c5115ed0.2b5f4","type":"inject","z":"fa9b3c4d.e0031","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"-1","payloadType":"num","x":170,"y":1340,"wires":[["fe645618.af2188"]]},{"id":"5c27fd89.e83f14","type":"inject","z":"fa9b3c4d.e0031","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"100","payloadType":"num","x":170,"y":1160,"wires":[["368f4488.8834cc"]]},{"id":"11ade912.245fc7","type":"inject","z":"fa9b3c4d.e0031","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"num","x":170,"y":1220,"wires":[["2ecca3dd.3fe57c"]]},{"id":"7be62c6d.5c5634","type":"inject","z":"fa9b3c4d.e0031","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":170,"y":1280,"wires":[["33be32a0.ddc82e"]]},{"id":"2510bc9f.9188f4","type":"link in","z":"fa9b3c4d.e0031","name":"% in","links":["f445fe6d.13fcc","fa52b803.f4e088"],"x":135,"y":480,"wires":[["2f4e9ae4.40fc26"]]},{"id":"2f4e9ae4.40fc26","type":"function","z":"fa9b3c4d.e0031","name":"Decision up/down","func":"var local=flow.get('data') || {};\n\n\nif (local.count===undefined)//test exists\n{\n  return [ msg, null, null ];\n}\n\n  msg.demand = msg.payload; \n  msg.initial = local.count;\n  \n//Saber si la ventana esta en maximos para decidir que tiempo usar\n\nmsg.time_to_use = \"standar\";\n \nif (local.count===100)//test exists\n{\n    msg.time_to_use = \"up_whit_correction\";\n  //return [ msg, null, null ];\n}\n\nif (local.count===0)\n{\n    msg.time_to_use = \"down_whit_correction\";\n    \n    //var user_move_time = env.get(\"move_time\");\n    //var correction_up = env.get(\"Up_correction\");\n    \n    //user_move_time = user_move_time+correction_up;\n    //global.set(\"move_time_set\",user_move_time);\n    \n    //msg.time_to_use = user_move_time;\n  \n  //return [ msg, null, null ];\n} \n//-----------------------------------------\n\n\nif (msg.payload > local.count)//test Subir\n{\n  msg.type =\"up\";\n  msg.payload=msg.payload - local.count;\n  if (msg.payload > 100)//test exists\n        {\n            msg.payload=100;\n        }\n\n  return [ null, msg, null ];\n}\n\n\nif (msg.payload < local.count)//test Bajar\n{\n      msg.type =\"down\";\n      msg.payload=local.count - msg.payload;\n      \n      if (msg.payload < 0)//test exists\n            {\n                msg.payload=0;\n            }\n      else {      \n          var i = parseInt(msg.payload);\n          i = i * -1;\n          msg.payload = i;\n       }\n      \n      return [ null, null, msg ];\n}\n","outputs":3,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":480,"wires":[["a2587652.783fd8","937a81b6.543df","c2aab41.9933d48"],["f5de4fff.0afaf","c2aab41.9933d48"],["29648235.bb2f9e","c2aab41.9933d48"]]},{"id":"f5de4fff.0afaf","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["63b2bb59.a03e54"],"x":455,"y":540,"wires":[]},{"id":"29648235.bb2f9e","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["1254df1e.3a0fe1"],"x":455,"y":580,"wires":[]},{"id":"a19b3726.fb2fb8","type":"change","z":"fa9b3c4d.e0031","name":"Baja","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"down\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":690,"y":460,"wires":[["5058a9b1.fe5938"]]},{"id":"5058a9b1.fe5938","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["b27682da.71eec"],"x":1055,"y":460,"wires":[]},{"id":"db0dd655.c15288","type":"mytimeout","z":"fa9b3c4d.e0031","name":"","outtopic":"","outsafe":"","outwarning":"","outunsafe":"{\"order\":\"stop\"}","warning":"","timer":"${move_time}","debug":false,"ndebug":false,"ignoreCase":false,"repeat":false,"again":false,"x":710,"y":500,"wires":[["5058a9b1.fe5938","ebd10f25.1d563","e0141531.9f3b88"],[]]},{"id":"a2587652.783fd8","type":"switch","z":"fa9b3c4d.e0031","name":"!Cancel","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"cancel","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":500,"y":460,"wires":[["a19b3726.fb2fb8"]]},{"id":"ebd10f25.1d563","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["ed7609c6.517498"],"x":1055,"y":500,"wires":[]},{"id":"937a81b6.543df","type":"change","z":"fa9b3c4d.e0031","name":"","rules":[{"t":"set","p":"backup","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":520,"y":500,"wires":[["db0dd655.c15288"]]},{"id":"e0141531.9f3b88","type":"change","z":"fa9b3c4d.e0031","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"backup","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":900,"y":540,"wires":[["2aee56b3.d7091a"]]},{"id":"2aee56b3.d7091a","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["63b2bb59.a03e54"],"x":1055,"y":540,"wires":[]},{"id":"55c58d3f.299204","type":"comment","z":"fa9b3c4d.e0031","name":"%Directo","info":"","x":80,"y":440,"wires":[]},{"id":"9cdbd5ca.aee968","type":"comment","z":"fa9b3c4d.e0031","name":"Porcentajes","info":"Control de variable de estado de porcentaje de persiana.","x":90,"y":1120,"wires":[]},{"id":"827ba467.222188","type":"debug","z":"f0ddc17c.4ba93","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":750,"y":280,"wires":[]},{"id":"7092d534.1f47dc","type":"function","z":"fa9b3c4d.e0031","name":"","func":"msg.payload = \"Persiana al \"+msg.payload+\"%\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":920,"y":1340,"wires":[[]]},{"id":"4277df20.fbbc","type":"comment","z":"fa9b3c4d.e0031","name":"% de persiana","info":"Salida para sabee el % de la persiana","x":1040,"y":1280,"wires":[]},{"id":"e0ec640c.5ce718","type":"comment","z":"fa9b3c4d.e0031","name":"Estado del nodo","info":"Saber que está trabajando dentro del nodo","x":1000,"y":1400,"wires":[]},{"id":"b058471b.a644f8","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["ca3a8a2e.6f82d8"],"x":155,"y":740,"wires":[]},{"id":"1c8dee.e60ce212","type":"change","z":"fa9b3c4d.e0031","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"\"% ON\"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":840,"y":1440,"wires":[[]]},{"id":"811f1386.ec439","type":"change","z":"fa9b3c4d.e0031","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"\"Incremento ON\"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":840,"y":1500,"wires":[[]]},{"id":"bf701251.cdbf3","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["eb654dc3.55cd5"],"x":155,"y":980,"wires":[]},{"id":"c2aab41.9933d48","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["fc8e422f.c6ac2"],"x":295,"y":560,"wires":[]},{"id":"ca4b9c61.aa042","type":"change","z":"fa9b3c4d.e0031","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"\"Decremento ON\"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":840,"y":1560,"wires":[[]]},{"id":"fc8e422f.c6ac2","type":"link in","z":"fa9b3c4d.e0031","name":"","links":["c2aab41.9933d48"],"x":695,"y":1440,"wires":[["1c8dee.e60ce212"]]},{"id":"ca3a8a2e.6f82d8","type":"link in","z":"fa9b3c4d.e0031","name":"","links":["b058471b.a644f8"],"x":695,"y":1500,"wires":[["811f1386.ec439"]]},{"id":"eb654dc3.55cd5","type":"link in","z":"fa9b3c4d.e0031","name":"","links":["bf701251.cdbf3"],"x":695,"y":1560,"wires":[["ca4b9c61.aa042"]]},{"id":"72cb428e.3c430c","type":"mqtt out","z":"fa9b3c4d.e0031","name":"MQTT","topic":"${MQTT_Topic}","qos":"1","retain":"","broker":"cc03406e.951f78","x":1150,"y":100,"wires":[]},{"id":"61cc1390.a0768c","type":"switch","z":"fa9b3c4d.e0031","name":"Cancel","property":"MQTT_ON","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1020,"y":100,"wires":[["72cb428e.3c430c"]]},{"id":"87e20296.91045","type":"alexa-home","z":"f0ddc17c.4ba93","conf":"45adb211.c11d1c","device":"117622","acknoledge":true,"name":"persiana","topic":"principal","x":160,"y":180,"wires":[["f0ba9981.8ffa78"]],"info":"https://alexa-node-red.bm.hardill.me.uk/devices"},{"id":"38bb8661.ebd1aa","type":"alexa-home","z":"f0ddc17c.4ba93","conf":"45adb211.c11d1c","device":"117626","acknoledge":true,"name":"persiana de estudio","topic":"principal","x":190,"y":300,"wires":[["e394640a.cc3d18"]],"info":"https://alexa-node-red.bm.hardill.me.uk/devices"},{"id":"2603bd23.c14992","type":"alexa-home","z":"f0ddc17c.4ba93","conf":"45adb211.c11d1c","device":"135911","acknoledge":true,"name":"Persiana de comedor 2","topic":"principal","x":200,"y":420,"wires":[["1266d002.07163"]],"info":"https://alexa-node-red.bm.hardill.me.uk/devices"},{"id":"f0ba9981.8ffa78","type":"subflow:fa9b3c4d.e0031","z":"f0ddc17c.4ba93","name":"","env":[{"name":"move_time","value":"25","type":"num"},{"name":"MQTT_Topic","value":"persia/per3/order","type":"str"},{"name":"up_whit_correction","value":"16","type":"num"},{"name":"down_whit_correction","value":"31","type":"str"}],"x":490,"y":180,"wires":[["977f3eec.f3d9b"],[],[],["827ba467.222188"],[],["8be55b70.cc5e9"],[]]},{"id":"e394640a.cc3d18","type":"subflow:fa9b3c4d.e0031","z":"f0ddc17c.4ba93","name":"","env":[{"name":"move_time","value":"24","type":"num"},{"name":"MQTT_Topic","value":"persia/per2/order","type":"str"},{"name":"up_whit_correction","value":"18","type":"num"},{"name":"down_whit_correction","value":"27","type":"str"},{"name":"Up_correction","value":"0","type":"num"}],"x":490,"y":300,"wires":[["977f3eec.f3d9b"],[],[],["827ba467.222188"],[],["8be55b70.cc5e9"],[]]},{"id":"1266d002.07163","type":"subflow:fa9b3c4d.e0031","z":"f0ddc17c.4ba93","name":"","env":[{"name":"move_time","value":"24","type":"num"},{"name":"MQTT_Topic","value":"persia/per1/order","type":"str"},{"name":"up_whit_correction","value":"18","type":"num"},{"name":"down_whit_correction","value":"28","type":"str"}],"x":490,"y":420,"wires":[["977f3eec.f3d9b"],["7e9ed2b3.e9db8c"],[],["827ba467.222188"],[],["8be55b70.cc5e9"],[]]},{"id":"629c9c3f.e61024","type":"mqtt in","z":"f3d60e61.2dd1f8","name":"","topic":"persia/temp","qos":"2","datatype":"auto","broker":"cc03406e.951f78","x":290,"y":1200,"wires":[["c6d26d6d.32231","ff4d1aa3.e52cf8"]]},{"id":"8f0c7729.355ca8","type":"switch","z":"f3d60e61.2dd1f8","name":"Interior-Exterior","property":"payload.disp","propertyType":"msg","rules":[{"t":"eq","v":"termo","vt":"str"},{"t":"eq","v":"per2","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":600,"y":1260,"wires":[["9e72d429.826738"],[]]},{"id":"c6d26d6d.32231","type":"json","z":"f3d60e61.2dd1f8","name":"","property":"payload","action":"","pretty":false,"x":450,"y":1260,"wires":[["8f0c7729.355ca8"]]},{"id":"9af63537.ae2bd8","type":"alexa-home","z":"f3d60e61.2dd1f8","conf":"45adb211.c11d1c","device":"118865","acknoledge":false,"name":"Interior","topic":"","x":150,"y":860,"wires":[["9a7e9d01.ef0ac"]],"info":"https://alexa-node-red.bm.hardill.me.uk/docs"},{"id":"d79107f2.f24b48","type":"mqtt out","z":"f3d60e61.2dd1f8","name":"","topic":"persia/termo/order","qos":"1","retain":"","broker":"cc03406e.951f78","x":710,"y":860,"wires":[]},{"id":"8b6ffd0d.53f8a","type":"change","z":"f3d60e61.2dd1f8","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"getTemp\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":480,"y":860,"wires":[["d79107f2.f24b48"]]},{"id":"9a7e9d01.ef0ac","type":"switch","z":"f3d60e61.2dd1f8","name":"","property":"command","propertyType":"msg","rules":[{"t":"eq","v":"GetTemperatureReadingRequest","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":310,"y":860,"wires":[["8b6ffd0d.53f8a","9f497572.d8efb8","4ab18c54.ebf91c"]]},{"id":"37df3e8a.af48c2","type":"change","z":"f3d60e61.2dd1f8","name":"Termo - geTemp","rules":[{"t":"set","p":"extra","pt":"msg","to":"{\"temperatureReading\": {\"value\": 20}}","tot":"json"},{"t":"set","p":"extra.temperatureReading.value","pt":"msg","to":"interior","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":660,"y":940,"wires":[["c5d5bb93.813cf8"]]},{"id":"9f497572.d8efb8","type":"delay","z":"f3d60e61.2dd1f8","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":480,"y":940,"wires":[["37df3e8a.af48c2"]]},{"id":"c5d5bb93.813cf8","type":"link out","z":"f3d60e61.2dd1f8","name":"","links":["6b4d1f6f.e0182"],"x":795,"y":940,"wires":[]},{"id":"106bfa9c.e0f265","type":"alexa-home","z":"f3d60e61.2dd1f8","conf":"45adb211.c11d1c","device":"118864","acknoledge":false,"name":"Exterior","topic":"","x":160,"y":1000,"wires":[["8b0ceabb.de84d8"]],"info":"https://alexa-node-red.bm.hardill.me.uk/docs"},{"id":"67e38aa5.ab79f4","type":"mqtt out","z":"f3d60e61.2dd1f8","name":"","topic":"persia/per2/order","qos":"1","retain":"","broker":"cc03406e.951f78","x":710,"y":1000,"wires":[]},{"id":"b15bc38d.f5b51","type":"change","z":"f3d60e61.2dd1f8","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"getTemp\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":480,"y":1000,"wires":[["67e38aa5.ab79f4"]]},{"id":"8b0ceabb.de84d8","type":"switch","z":"f3d60e61.2dd1f8","name":"","property":"command","propertyType":"msg","rules":[{"t":"eq","v":"GetTemperatureReadingRequest","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":310,"y":1000,"wires":[["b15bc38d.f5b51","39c6f511.f17b1a","4ab18c54.ebf91c"]]},{"id":"3a5fe600.d7448a","type":"change","z":"f3d60e61.2dd1f8","name":"Termo - geTemp","rules":[{"t":"set","p":"extra","pt":"msg","to":"{\"temperatureReading\": {\"value\": 20}}","tot":"json"},{"t":"set","p":"extra.temperatureReading.value","pt":"msg","to":"exterior","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":870,"y":1080,"wires":[["a492f08e.756cb"]]},{"id":"39c6f511.f17b1a","type":"delay","z":"f3d60e61.2dd1f8","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":480,"y":1080,"wires":[["3a5fe600.d7448a"]]},{"id":"a492f08e.756cb","type":"link out","z":"f3d60e61.2dd1f8","name":"","links":["6b4d1f6f.e0182"],"x":1035,"y":1080,"wires":[]},{"id":"4f145eb4.d223d","type":"comment","z":"f3d60e61.2dd1f8","name":"Temperatura","info":"# Responde con las temperaturas\n * temperatura de exterior\n * temperatura de interior\n# Pagina de test\n * https://developer.amazon.com/alexa/console/ask/test/amzn1.ask.skill.c1ce23b7-d6e2-46b0-82b3-ad6b2bacfbdd/development/es_ES/","x":160,"y":800,"wires":[]},{"id":"9e72d429.826738","type":"change","z":"f3d60e61.2dd1f8","name":"Actu-Temp-Actual-Interior","rules":[{"t":"set","p":"topic","pt":"msg","to":"currentTemp","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"payload.Temperatura","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":900,"y":1340,"wires":[[]]},{"id":"ff4d1aa3.e52cf8","type":"gate","z":"f3d60e61.2dd1f8","name":"","controlTopic":"control","defaultState":"closed","openCmd":"open","closeCmd":"close","toggleCmd":"toggle","defaultCmd":"default","persist":false,"x":830,"y":1200,"wires":[["5f695a59.7a2dac"]]},{"id":"4ab18c54.ebf91c","type":"change","z":"f3d60e61.2dd1f8","name":"Open Gate","rules":[{"t":"set","p":"payload","pt":"msg","to":"open","tot":"str"},{"t":"set","p":"topic","pt":"msg","to":"control","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":630,"y":1140,"wires":[["ff4d1aa3.e52cf8"]]},{"id":"f608c800.af2d2","type":"change","z":"f3d60e61.2dd1f8","name":"Close Gate","rules":[{"t":"set","p":"payload","pt":"msg","to":"close","tot":"str"},{"t":"set","p":"topic","pt":"msg","to":"control","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1510,"y":1140,"wires":[["ff4d1aa3.e52cf8"]]},{"id":"1e6be1ad.17f856","type":"switch","z":"f3d60e61.2dd1f8","name":"","property":"payload.disp","propertyType":"msg","rules":[{"t":"eq","v":"termo","vt":"str"},{"t":"eq","v":"per2","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1070,"y":1200,"wires":[["ea03b3b5.46995"],["b6aa2e9e.ac2ac8"]]},{"id":"ea03b3b5.46995","type":"change","z":"f3d60e61.2dd1f8","name":"","rules":[{"t":"set","p":"interior","pt":"flow","to":"payload.Temperatura","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1280,"y":1140,"wires":[["f608c800.af2d2"]]},{"id":"5f695a59.7a2dac","type":"json","z":"f3d60e61.2dd1f8","name":"","property":"payload","action":"","pretty":false,"x":950,"y":1200,"wires":[["1e6be1ad.17f856"]]},{"id":"b6aa2e9e.ac2ac8","type":"change","z":"f3d60e61.2dd1f8","name":"","rules":[{"t":"set","p":"exterior","pt":"flow","to":"payload.Temperatura","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1290,"y":1200,"wires":[["f608c800.af2d2"]]},{"id":"99010d64.874ff","type":"comment","z":"f3d60e61.2dd1f8","name":"Displ-Calefa-ActualTemp","info":"Extrae la temperatura interior que envía los ESP de manera constante para poder tener un display o actualizar la temperatura.\n\n# Pagina de test\n * https://developer.amazon.com/alexa/console/ask/test/amzn1.ask.skill.c1ce23b7-d6e2-46b0-82b3-ad6b2bacfbdd/development/es_ES/","x":890,"y":1300,"wires":[]},{"id":"2e03c4f0.8deff4","type":"comment","z":"f3d60e61.2dd1f8","name":"Actualizar Valor de Variable","info":"Cambia el valor de la variable para poder pasar la temperatura a Alexa desde Termo-getemp\n\n# Pagina de test\n * https://developer.amazon.com/alexa/console/ask/test/amzn1.ask.skill.c1ce23b7-d6e2-46b0-82b3-ad6b2bacfbdd/development/es_ES/","x":1320,"y":1080,"wires":[]},{"id":"d1090891.a9a77","type":"function","z":"f3d60e61.2dd1f8","name":"htrigger","func":"msg.payload = \"htrigger\"\nreturn msg;\n//Temperatura trigger de calefaccion","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":460,"wires":[["50b587c9.845bd"]]},{"id":"fec153f7.498318","type":"change","z":"f3d60e61.2dd1f8","name":"Crear paquete","rules":[{"t":"set","p":"topic","pt":"msg","to":"userConfig","tot":"str"},{"t":"set","p":"mqtt","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"{\"isUserCustomLocked\":true,\"userTargetValue\":\"userConfig\",\"isUserCustom\":true,\"mqtt\":true}","tot":"json"},{"t":"set","p":"payload.mqtt","pt":"msg","to":"mqtt","tot":"msg"},{"t":"set","p":"payload.userTargetValue","pt":"msg","to":"payload.mqtt.order","tot":"msg"},{"t":"delete","p":"payload.mqtt","pt":"msg"},{"t":"delete","p":"mqtt","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":980,"y":1460,"wires":[[]]},{"id":"bd5c7459.f1852","type":"mqtt in","z":"f3d60e61.2dd1f8","name":"","topic":"persia/calefaccion","qos":"2","datatype":"auto","broker":"cc03406e.951f78","x":290,"y":1460,"wires":[["c191bbb7.5c9188","bf3cdade.c5447"]]},{"id":"c191bbb7.5c9188","type":"json","z":"f3d60e61.2dd1f8","name":"","property":"payload","action":"","pretty":false,"x":510,"y":1460,"wires":[["2f541f15.d6e1"]]},{"id":"1961083e.de253","type":"change","z":"f3d60e61.2dd1f8","name":"Mqtt-SetTemp","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"grados\"}","tot":"json"},{"t":"set","p":"payload.order","pt":"msg","to":"extra.targetTemperature.value","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":800,"y":440,"wires":[["4a79f5be.68fed4"]]},{"id":"2f541f15.d6e1","type":"switch","z":"f3d60e61.2dd1f8","name":"","property":"payload.order","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"istype","v":"number","vt":"number"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":650,"y":1460,"wires":[["baec5259.40fb3"],["fec153f7.498318"],["2d6d72a1.07bf9e"]]},{"id":"baec5259.40fb3","type":"change","z":"f3d60e61.2dd1f8","name":"On-21.5","rules":[{"t":"set","p":"payload.order","pt":"msg","to":"21.5","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":800,"y":1420,"wires":[["fec153f7.498318"]]},{"id":"2d6d72a1.07bf9e","type":"change","z":"f3d60e61.2dd1f8","name":"Off-21.5","rules":[{"t":"set","p":"payload.order","pt":"msg","to":"0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":800,"y":1500,"wires":[["fec153f7.498318"]]},{"id":"9596ef8c.11df7","type":"comment","z":"f3d60e61.2dd1f8","name":"Actualizar Display de calefacción","info":"\n\n# Pagina de test\n * https://developer.amazon.com/alexa/console/ask/test/amzn1.ask.skill.c1ce23b7-d6e2-46b0-82b3-ad6b2bacfbdd/development/es_ES/","x":340,"y":1400,"wires":[]},{"id":"b2303033.4088b","type":"change","z":"f3d60e61.2dd1f8","name":"Mqtt-Incremento","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"grados\"}","tot":"json"},{"t":"set","p":"payload.order","pt":"msg","to":"extra.targetTemperature.value","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1270,"y":640,"wires":[["4103b6d8.3783e8"]]},{"id":"e070fc0c.2a4568","type":"debug","z":"f3d60e61.2dd1f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1470,"y":1320,"wires":[]},{"id":"c58166ef.c4d7d","type":"switch","z":"f3d60e61.2dd1f8","name":"","property":"payload.targetValue","propertyType":"msg","rules":[{"t":"gte","v":"21","vt":"num"},{"t":"lt","v":"21","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1330,"y":1340,"wires":[["e070fc0c.2a4568"],[]]},{"id":"bf3cdade.c5447","type":"debug","z":"f3d60e61.2dd1f8","name":"MQTT","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":510,"y":1560,"wires":[]},{"id":"f9de5dbb.a6c4e8","type":"comment","z":"f0ddc17c.4ba93","name":"Dirección de configuración Alexa","info":"https://alexa-node-red.bm.hardill.me.uk/devices\n\nSecundaria_\n\nhttps://red.cb-net.co.uk/devices","x":140,"y":80,"wires":[]},{"id":"1b5adff0.3f3768","type":"switch","z":"fa9b3c4d.e0031","name":"","property":"topic","propertyType":"msg","rules":[{"t":"neq","v":"block","vt":"str"},{"t":"eq","v":"block","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":130,"y":120,"wires":[["6a9e4975.0534a8","2afb7067.454ce"],["ebe64c6a.dc3f9"]]},{"id":"254b1cca.8a1f4c","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["65f9a03b.8bb04"],"x":495,"y":260,"wires":[]},{"id":"1dc98c81.26ed7b","type":"change","z":"fa9b3c4d.e0031","name":"Block","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"block\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":260,"wires":[["254b1cca.8a1f4c"]]},{"id":"ebe64c6a.dc3f9","type":"switch","z":"fa9b3c4d.e0031","name":"","property":"payload","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":270,"y":280,"wires":[["1dc98c81.26ed7b"],["f898a9f3.801fb"]]},{"id":"f898a9f3.801fb","type":"change","z":"fa9b3c4d.e0031","name":"unlock","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"unlock\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":300,"wires":[["254b1cca.8a1f4c"]]},{"id":"bca27a09.49e82","type":"mqtt out","z":"ccc70095.e8d18","name":"","topic":"persia/server","qos":"","retain":"","broker":"cc03406e.951f78","x":850,"y":1060,"wires":[]},{"id":"fec08578.dd151","type":"ui_led","z":"ccc70095.e8d18","order":6,"group":"80677e24.b1fa78","width":"3","height":1,"label":"Server","labelPlacement":"left","labelAlignment":"left","colorForValue":[{"color":"#ff0000","value":"false","valueType":"bool"},{"color":"#008000","value":"true","valueType":"str"},{"color":"#008000","value":"true","valueType":"bool"}],"allowColorForValueInMessage":false,"shape":"circle","showGlow":true,"name":"server","x":710,"y":140,"wires":[]},{"id":"cd8eefc9.ab146","type":"switch","z":"ccc70095.e8d18","name":"Torrent","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"transmision","vt":"str"},{"t":"eq","v":"transmision","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":660,"y":260,"wires":[["20ef86bf.1c515a"],["28286aa6.e8ffb6"]]},{"id":"ebb2386f.a5bad8","type":"ui_switch","z":"ccc70095.e8d18","name":"","label":"Torrent","tooltip":"","group":"47562201.21775c","order":2,"width":"3","height":1,"passthru":true,"decouple":"false","topic":"","topicType":"str","style":"","onvalue":"{\"torrent\":\"on\"}","onvalueType":"json","onicon":"","oncolor":"","offvalue":"{\"torrent\":\"off\"}","offvalueType":"json","officon":"","offcolor":"","animate":true,"className":"","x":670,"y":1060,"wires":[["bca27a09.49e82","c04833e1.60b86"]]},{"id":"adf666ae.f104b8","type":"link in","z":"ccc70095.e8d18","name":"","links":["28286aa6.e8ffb6"],"x":75,"y":1040,"wires":[["801ab894.b4a26","209f5ebd.3bdac2"]]},{"id":"28286aa6.e8ffb6","type":"link out","z":"ccc70095.e8d18","name":"","links":["adf666ae.f104b8"],"x":815,"y":320,"wires":[]},{"id":"12c88c55.fcaebc","type":"ui_led","z":"ccc70095.e8d18","order":7,"group":"80677e24.b1fa78","width":"3","height":1,"label":"Torrent","labelPlacement":"left","labelAlignment":"left","colorForValue":[{"color":"#ff0000","value":"false","valueType":"bool"},{"color":"#008000","value":"true","valueType":"bool"},{"color":"#008000","value":"true","valueType":"str"},{"color":"#ff2600","value":"false","valueType":"str"}],"allowColorForValueInMessage":false,"shape":"circle","showGlow":true,"name":"Torrent","x":510,"y":1000,"wires":[]},{"id":"801ab894.b4a26","type":"function","z":"ccc70095.e8d18","name":"","func":"msg.payload = \"true\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":250,"y":1000,"wires":[["12c88c55.fcaebc"]]},{"id":"2864672d.240d08","type":"comment","z":"ccc70095.e8d18","name":"torrent Status","info":"Leds para indicar como está torrent\nRecibe paquede desde servidor","x":110,"y":960,"wires":[]},{"id":"f707f6a9.87ae08","type":"mqtt out","z":"fa9b3c4d.e0031","name":"MQTT Retain","topic":"${MQTT_Topic}","qos":"1","retain":"true","broker":"cc03406e.951f78","x":620,"y":380,"wires":[]},{"id":"deacf464.c832f","type":"switch","z":"fa9b3c4d.e0031","name":"Cancel","property":"MQTT_ON","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":460,"y":380,"wires":[["f707f6a9.87ae08"]]},{"id":"65f9a03b.8bb04","type":"link in","z":"fa9b3c4d.e0031","name":"","links":["254b1cca.8a1f4c"],"x":335,"y":380,"wires":[["deacf464.c832f"]]},{"id":"da03f0dd.5c2a78","type":"switch","z":"ccc70095.e8d18","name":"FromRpiEstudio","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Taller","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":470,"y":340,"wires":[["7637ee6c.45d87"]]},{"id":"3388c60e.477312","type":"switch","z":"ccc70095.e8d18","name":"FromServer","property":"ip","propertyType":"msg","rules":[{"t":"cont","v":"192.168.3.151","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":270,"y":100,"wires":[["1fe763fd.6df044","a09cb5f4.215cb8","1983e55d.3c2d53"]]},{"id":"7637ee6c.45d87","type":"link out","z":"ccc70095.e8d18","name":"","links":["2068cf3a.45a42"],"x":635,"y":340,"wires":[]},{"id":"39340efd.8e29d2","type":"function","z":"ccc70095.e8d18","name":"","func":"msg.payload = \"true\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":260,"y":1240,"wires":[["6b9425a0.43e72c","88cf75a4.2a0868"]]},{"id":"6b9425a0.43e72c","type":"ui_led","z":"ccc70095.e8d18","order":1,"group":"60a199.33c71668","width":6,"height":1,"label":"Estudio","labelPlacement":"left","labelAlignment":"left","colorForValue":[{"color":"red","value":"false","valueType":"bool"},{"color":"green","value":"true","valueType":"bool"},{"color":"green","value":"true","valueType":"str"}],"allowColorForValueInMessage":false,"shape":"circle","showGlow":true,"name":"Estudio","x":530,"y":1240,"wires":[]},{"id":"2068cf3a.45a42","type":"link in","z":"ccc70095.e8d18","name":"","links":["7637ee6c.45d87"],"x":75,"y":1240,"wires":[["39340efd.8e29d2","d4777532.19591"]]},{"id":"d4777532.19591","type":"timeouttrigger","z":"ccc70095.e8d18","ontimeouttype":"bool","ontimeoutval":"false","duration":"7","units":"s","name":"","x":250,"y":1280,"wires":[["6b9425a0.43e72c","88cf75a4.2a0868"]]},{"id":"88cf75a4.2a0868","type":"ui_led","z":"ccc70095.e8d18","order":3,"group":"47562201.21775c","width":"3","height":1,"label":"Estudio","labelPlacement":"left","labelAlignment":"left","colorForValue":[{"color":"#ff0000","value":"false","valueType":"bool"},{"color":"#008000","value":"true","valueType":"str"},{"color":"#008000","value":"true","valueType":"bool"}],"allowColorForValueInMessage":false,"shape":"circle","showGlow":true,"name":"Estudio","x":520,"y":1280,"wires":[]},{"id":"a1b414bc.a48b28","type":"ui_button","z":"ccc70095.e8d18","name":"","group":"60a199.33c71668","order":6,"width":5,"height":1,"passthru":false,"label":"Trans-Web","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"","x":110,"y":880,"wires":[["20d9075.7eee778"]]},{"id":"6a7118f.50e6ce8","type":"ui_toast","z":"ccc70095.e8d18","position":"dialog","displayTime":"6","highlight":"red","sendall":true,"outputs":1,"ok":"OK","cancel":"","raw":true,"topic":"","name":"","x":450,"y":880,"wires":[[]]},{"id":"20d9075.7eee778","type":"template","z":"ccc70095.e8d18","name":"","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<p style=\"text-align: center\">Unfortunately Node Red cannot solve this for you. Click on link below to find the one who does</p>\n<p style=\"text-align:center\"><a href=\"http://192.168.3.151:9091/transmission/web/\"  target=\"_blank\" style=\"color:red;font-size:300%\">Open Transmission</a></p>","output":"str","x":280,"y":880,"wires":[["6a7118f.50e6ce8"]]},{"id":"6a7a912d.11ebe","type":"comment","z":"ccc70095.e8d18","name":"Abrir la web de torrent","info":"","x":140,"y":840,"wires":[]},{"id":"1ee0a562.b6651b","type":"ui_gauge","z":"ccc70095.e8d18","g":"95ea86bf.d2cda","name":"","group":"2007caa7.9dc636","order":1,"width":3,"height":3,"gtype":"gage","title":"CPU-1","label":"units","format":"{{value}}","min":"1","max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":1560,"y":180,"wires":[]},{"id":"22650dd9.e210ba","type":"function","z":"ccc70095.e8d18","name":"ASCII to String","func":"msg.payload = msg.payload.toString();\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":280,"y":340,"wires":[["da03f0dd.5c2a78","2b1313dc.cd923c"]]},{"id":"1aa3b80c.9bcb78","type":"json","z":"ccc70095.e8d18","name":"","property":"payload","action":"","pretty":false,"x":470,"y":440,"wires":[["628b3329.e2338c","101e8bd6.dad8bc"]]},{"id":"5cebd892.78bbb8","type":"comment","z":"ccc70095.e8d18","name":"Speed Taller","info":"Control de estado de encendido del server","x":490,"y":400,"wires":[]},{"id":"2b1313dc.cd923c","type":"switch","z":"ccc70095.e8d18","name":"Talller-Speed","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"Taller","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":280,"y":440,"wires":[["1aa3b80c.9bcb78"]]},{"id":"f21d7f5f.ec8e2","type":"ui_chart","z":"ccc70095.e8d18","d":true,"name":"","group":"fa7adc1e.6f7dd","order":1,"width":6,"height":3,"label":"Upload","chartType":"line","legend":"false","xformat":"HH:mm","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"className":"","x":960,"y":420,"wires":[[]]},{"id":"c740e364.bfb448","type":"ui_chart","z":"ccc70095.e8d18","d":true,"name":"","group":"fa7adc1e.6f7dd","order":2,"width":6,"height":3,"label":"Download","chartType":"line","legend":"false","xformat":"HH:mm","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"className":"","x":960,"y":460,"wires":[[]]},{"id":"628b3329.e2338c","type":"change","z":"ccc70095.e8d18","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.speeds.upload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":710,"y":420,"wires":[["f21d7f5f.ec8e2"]]},{"id":"101e8bd6.dad8bc","type":"change","z":"ccc70095.e8d18","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.speeds.download","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":710,"y":460,"wires":[["c740e364.bfb448"]]},{"id":"2b08d48f.de1a14","type":"link out","z":"63e478e.65faa88","name":"Control_Persia_Ordenador","links":["f4ead960.53dca"],"x":495,"y":140,"wires":[]},{"id":"d8042dcb.478f2","type":"switch","z":"63e478e.65faa88","name":"","property":"payload","propertyType":"msg","rules":[{"t":"true"},{"t":"false"},{"t":"eq","v":"off","vt":"str"},{"t":"eq","v":"cancel","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":690,"y":280,"wires":[["6df32469.afea7c","40ef8de1.08f02c"],["375113bc.e5c3dc","9ac3f56a.2bbf68"],["c7ad9b07.5b112"],["40ef8de1.08f02c","9ac3f56a.2bbf68"]]},{"id":"f4ead960.53dca","type":"link in","z":"63e478e.65faa88","name":"decision total","links":["2b08d48f.de1a14","2120248f.394364","c28704a9.6cbda","23f553bc.f50dfc"],"x":595,"y":280,"wires":[["d8042dcb.478f2"]]},{"id":"6df32469.afea7c","type":"change","z":"63e478e.65faa88","name":"Sube","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"up\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":870,"y":260,"wires":[["823239b1.9f04b8"]]},{"id":"c7ad9b07.5b112","type":"change","z":"63e478e.65faa88","name":"Stop","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"stop\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":870,"y":400,"wires":[["823239b1.9f04b8"]]},{"id":"fe903789.00201","type":"json","z":"63e478e.65faa88","name":"","property":"payload","action":"obj","pretty":false,"x":1030,"y":200,"wires":[["823239b1.9f04b8"]]},{"id":"1c56dbfe.fe5d8c","type":"link in","z":"63e478e.65faa88","name":"persia/per3/order","links":["543204a3.208374","fae2d57d.c1ab08","823239b1.9f04b8","4d8441a.98b09c"],"x":895,"y":40,"wires":[["a5e77256.120518"]]},{"id":"823239b1.9f04b8","type":"link out","z":"63e478e.65faa88","name":"","links":["1c56dbfe.fe5d8c"],"x":1155,"y":280,"wires":[]},{"id":"375113bc.e5c3dc","type":"change","z":"63e478e.65faa88","name":"baja","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"down\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":870,"y":300,"wires":[["823239b1.9f04b8"]]},{"id":"b730613e.c64d1","type":"switch","z":"63e478e.65faa88","name":"","property":"command","propertyType":"msg","rules":[{"t":"eq","v":"SetPercentageRequest","vt":"str"},{"t":"eq","v":"IncrementPercentageRequest","vt":"str"},{"t":"eq","v":"DecrementPercentageRequest","vt":"str"}],"checkall":"false","repair":false,"outputs":3,"x":610,"y":80,"wires":[["1dc26d15.ca55bb"],["f7103b37.fb18a8"],["1729ad6d.47716b"]]},{"id":"7bdcb2df.ff105c","type":"range","z":"63e478e.65faa88","minin":"0","maxin":"100","minout":"0","maxout":"${move_time}","action":"scale","round":false,"property":"payload","name":"conversor tiempo","x":350,"y":720,"wires":[["a5e8f0d7.8f446"]]},{"id":"f7056922.6e654","type":"mytimeout","z":"63e478e.65faa88","name":"","outtopic":"","outsafe":"","outwarning":"","outunsafe":"off","warning":"","timer":"25","debug":false,"ndebug":false,"ignoreCase":false,"repeat":false,"again":false,"x":770,"y":680,"wires":[["c28704a9.6cbda","8dd5f536.fa7298"],[]]},{"id":"a5e8f0d7.8f446","type":"template","z":"63e478e.65faa88","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"\n{ \n\"payload\": \"on\", \n\"timeout\": {{payload}}, \n\"warning\": true }","output":"json","x":520,"y":720,"wires":[["f7056922.6e654"]]},{"id":"40a731f.7ffddd","type":"change","z":"63e478e.65faa88","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":640,"wires":[["c28704a9.6cbda"]]},{"id":"c28704a9.6cbda","type":"link out","z":"63e478e.65faa88","name":"Control_Persia_Ordenador","links":["f4ead960.53dca"],"x":975,"y":640,"wires":[]},{"id":"4ebcee6b.a5791","type":"range","z":"63e478e.65faa88","minin":"0","maxin":"100","minout":"0","maxout":"${move_time}","action":"scale","round":false,"property":"payload","name":"conversor tiempo","x":350,"y":880,"wires":[["7e73c1a2.e6d6e8"]]},{"id":"6564b3b0.bfc76c","type":"mytimeout","z":"63e478e.65faa88","name":"","outtopic":"","outsafe":"","outwarning":"","outunsafe":"off","warning":"","timer":"25","debug":false,"ndebug":false,"ignoreCase":false,"repeat":false,"again":false,"x":850,"y":840,"wires":[["23f553bc.f50dfc","9e4cb586.3df51"],[]]},{"id":"83f1f426.b09f8","type":"template","z":"63e478e.65faa88","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"\n{ \n\"payload\": \"on\", \n\"timeout\": {{payload}}, \n\"warning\": true }","output":"json","x":660,"y":880,"wires":[["6564b3b0.bfc76c"]]},{"id":"36ec314f.5c0a0e","type":"change","z":"63e478e.65faa88","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":800,"wires":[["23f553bc.f50dfc"]]},{"id":"23f553bc.f50dfc","type":"link out","z":"63e478e.65faa88","name":"Control_Persia_Ordenador","links":["f4ead960.53dca"],"x":975,"y":800,"wires":[]},{"id":"7e73c1a2.e6d6e8","type":"function","z":"63e478e.65faa88","name":"","func":"var i = parseInt(msg.payload);\ni = i * -1;\n\nmsg.payload = i.toString();\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":520,"y":880,"wires":[["83f1f426.b09f8"]]},{"id":"7bdec9b3.6075a","type":"comment","z":"63e478e.65faa88","name":"Incremento","info":"Rama para el incremento del 25%\n\nSube persiana","x":90,"y":620,"wires":[]},{"id":"2f355a8b.81a7ae","type":"comment","z":"63e478e.65faa88","name":"Decremento","info":"Rama para el Decremento del 25%.\n\nBaja persiana","x":90,"y":800,"wires":[]},{"id":"f7103b37.fb18a8","type":"link out","z":"63e478e.65faa88","name":"Incrementa out","links":["92065079.5969b"],"x":815,"y":80,"wires":[]},{"id":"92065079.5969b","type":"link in","z":"63e478e.65faa88","name":"Incrementa-in","links":["2120248f.394364","f7103b37.fb18a8","6daf4d9c.8250cc","e52c1604.f796e8"],"x":135,"y":660,"wires":[["7bdcb2df.ff105c","17a2a440.7a132c","52d86f34.c1ca"]]},{"id":"e4d596a1.2e7","type":"link in","z":"63e478e.65faa88","name":"Decrementa in","links":["2120248f.394364","1729ad6d.47716b","3012823f.c8026e"],"x":135,"y":840,"wires":[["4ebcee6b.a5791","7d01983b.9d9e8","15ddc316.a93395"]]},{"id":"1729ad6d.47716b","type":"link out","z":"63e478e.65faa88","name":"Incrementa out","links":["e4d596a1.2e7"],"x":815,"y":120,"wires":[]},{"id":"1dc26d15.ca55bb","type":"link out","z":"63e478e.65faa88","name":"% out","links":["d9fbcedb.10074"],"x":815,"y":40,"wires":[]},{"id":"40ef8de1.08f02c","type":"mytimeout","z":"63e478e.65faa88","name":"","outtopic":"","outsafe":"","outwarning":"","outunsafe":"{\"order\":\"stop\"}","warning":"","timer":"${move_time}","debug":false,"ndebug":false,"ignoreCase":false,"repeat":false,"again":false,"x":870,"y":200,"wires":[["fe903789.00201","d0fe6eff.7be808"],[]]},{"id":"9ac3f56a.2bbf68","type":"mytimeout","z":"63e478e.65faa88","name":"","outtopic":"","outsafe":"","outwarning":"","outunsafe":"{\"order\":\"stop\"}","warning":"","timer":"${move_time}","debug":false,"ndebug":false,"ignoreCase":false,"repeat":false,"again":false,"x":890,"y":340,"wires":[["823239b1.9f04b8","b37f3fbc.49541"],[]]},{"id":"3d20e0b.76deca","type":"change","z":"63e478e.65faa88","name":"reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"},{"t":"set","p":"payload","pt":"msg","to":"cancel","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":220,"wires":[["2120248f.394364"]]},{"id":"17a2a440.7a132c","type":"switch","z":"63e478e.65faa88","name":"Cancel","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"cancel","vt":"str"},{"t":"eq","v":"cancel","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":320,"y":660,"wires":[["40a731f.7ffddd","ad6fafc4.0a3ee8"],["f7056922.6e654"]]},{"id":"7d01983b.9d9e8","type":"switch","z":"63e478e.65faa88","name":"Cancel","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"cancel","vt":"str"},{"t":"eq","v":"cancel","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":320,"y":820,"wires":[["36ec314f.5c0a0e","559409c3.c40fa"],["6564b3b0.bfc76c"]]},{"id":"1de505f8.4cc8da","type":"change","z":"63e478e.65faa88","name":"Stop","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"stop\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":180,"wires":[["543204a3.208374"]]},{"id":"543204a3.208374","type":"link out","z":"63e478e.65faa88","name":"","links":["1c56dbfe.fe5d8c"],"x":495,"y":180,"wires":[]},{"id":"a48c24ca.ba67d","type":"link in","z":"63e478e.65faa88","name":"Reset","links":["3f606e56.86ad72","8dd5f536.fa7298","9e4cb586.3df51"],"x":275,"y":180,"wires":[["3d20e0b.76deca","1de505f8.4cc8da"]]},{"id":"98f540f0.db2f18","type":"delay","z":"63e478e.65faa88","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":360,"y":80,"wires":[["b730613e.c64d1","2b08d48f.de1a14"]]},{"id":"2120248f.394364","type":"link out","z":"63e478e.65faa88","name":"reset OUT","links":["f4ead960.53dca","d9fbcedb.10074","92065079.5969b","e4d596a1.2e7"],"x":495,"y":220,"wires":[]},{"id":"3f606e56.86ad72","type":"link out","z":"63e478e.65faa88","name":"","links":["a48c24ca.ba67d"],"x":275,"y":140,"wires":[]},{"id":"102a3d2d.edc7b3","type":"comment","z":"63e478e.65faa88","name":"reset - previo","info":"Reseteo todos los contadores y espero 1 segundo para mandar la nueva orden","x":390,"y":40,"wires":[]},{"id":"a5fc5771.552e98","type":"comment","z":"63e478e.65faa88","name":"Selector Principal","info":"Aquí se seleccionan todas las ordenes y se envían a MQTT","x":680,"y":220,"wires":[]},{"id":"6e2ccb.e8cd8334","type":"function","z":"63e478e.65faa88","name":"Local - 100%","func":"//var local=context.get('data') || {};\n\nvar local=flow.get('data') || {};\n\nlocal.count=100;\n\nflow.set('data',local);\n\nmsg.payload=local.count;\n\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":700,"y":1000,"wires":[["5c54683a.a8d6a","acac6149.291998"]]},{"id":"11e1f130.dac757","type":"function","z":"63e478e.65faa88","name":"Local - 0%","func":"//var local=context.get('data') || {};\n\nvar local=flow.get('data') || {};\n\nlocal.count=0;\n\nflow.set('data',local);\n\nmsg.payload=local.count;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":690,"y":1060,"wires":[["5c54683a.a8d6a","acac6149.291998"]]},{"id":"b14b290f.432de","type":"link in","z":"63e478e.65faa88","name":"Local 100%","links":["d0fe6eff.7be808"],"x":335,"y":1000,"wires":[["5b072c5e.88dbf4"]]},{"id":"87910d13.bcccc8","type":"link in","z":"63e478e.65faa88","name":"Local 0%","links":["b37f3fbc.49541","8454bdfc.54bb98"],"x":335,"y":1060,"wires":[["244945ee.7596aa"]]},{"id":"b37f3fbc.49541","type":"link out","z":"63e478e.65faa88","name":"","links":["87910d13.bcccc8"],"x":1075,"y":380,"wires":[]},{"id":"d0fe6eff.7be808","type":"link out","z":"63e478e.65faa88","name":"","links":["b14b290f.432de"],"x":995,"y":160,"wires":[]},{"id":"3e02e078.acce6","type":"function","z":"63e478e.65faa88","name":"Local Suma","func":"var local=flow.get('data') || {};\n\nif (local.count===undefined)//test exists\n{\n  local.count=0;\n}\n\nvar i = parseInt(msg.payload);\n\nlocal.count +=i;\n\nflow.set('data',local);\n\nmsg.payload=local.count;\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":690,"y":1120,"wires":[["5c54683a.a8d6a","acac6149.291998"]]},{"id":"ecfea5b0.41846","type":"link in","z":"63e478e.65faa88","name":"Local Suma","links":["52d86f34.c1ca"],"x":335,"y":1120,"wires":[["b915c24e.0f6f"]]},{"id":"15ddc316.a93395","type":"link out","z":"63e478e.65faa88","name":"","links":["bb763427.0b1498"],"x":275,"y":920,"wires":[]},{"id":"52d86f34.c1ca","type":"link out","z":"63e478e.65faa88","name":"","links":["ecfea5b0.41846"],"x":275,"y":760,"wires":[]},{"id":"5c54683a.a8d6a","type":"debug","z":"63e478e.65faa88","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":970,"y":1060,"wires":[]},{"id":"5b072c5e.88dbf4","type":"switch","z":"63e478e.65faa88","name":"Cancel","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"cancel","vt":"str"},{"t":"eq","v":"cancel","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":500,"y":1000,"wires":[["6e2ccb.e8cd8334"],[]]},{"id":"244945ee.7596aa","type":"switch","z":"63e478e.65faa88","name":"Cancel","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"cancel","vt":"str"},{"t":"eq","v":"cancel","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":500,"y":1060,"wires":[["11e1f130.dac757"],[]]},{"id":"b915c24e.0f6f","type":"switch","z":"63e478e.65faa88","name":"Cancel","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"cancel","vt":"str"},{"t":"eq","v":"cancel","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":500,"y":1120,"wires":[["3e02e078.acce6"],[]]},{"id":"9e4cb586.3df51","type":"link out","z":"63e478e.65faa88","name":"","links":["a48c24ca.ba67d"],"x":975,"y":840,"wires":[]},{"id":"8dd5f536.fa7298","type":"link out","z":"63e478e.65faa88","name":"","links":["a48c24ca.ba67d"],"x":975,"y":680,"wires":[]},{"id":"d533c3c8.dadaa","type":"function","z":"63e478e.65faa88","name":"Local Resta","func":"var local=flow.get('data') || {};\n\nif (local.count===undefined)//test exists\n{\n  local.count=0;\n}\n\nvar i = parseInt(msg.payload);\ni = i * -1;\n\nlocal.count -=i;\n\nif (local.count < 0)//test exists\n{\n  local.count=0;\n}\n\nflow.set('data',local);\n\nmsg.payload=local.count;\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":690,"y":1180,"wires":[["5c54683a.a8d6a","acac6149.291998"]]},{"id":"bb763427.0b1498","type":"link in","z":"63e478e.65faa88","name":"Local Resta","links":["15ddc316.a93395"],"x":335,"y":1180,"wires":[["4bfe5198.0e423"]]},{"id":"4bfe5198.0e423","type":"switch","z":"63e478e.65faa88","name":"Cancel","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"cancel","vt":"str"},{"t":"eq","v":"cancel","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":500,"y":1180,"wires":[["d533c3c8.dadaa"],[]]},{"id":"7923d13f.510dc8","type":"inject","z":"63e478e.65faa88","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"-1","payloadType":"num","x":190,"y":1180,"wires":[["d533c3c8.dadaa"]]},{"id":"3f14029a.4f7b66","type":"inject","z":"63e478e.65faa88","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"100","payloadType":"num","x":190,"y":1000,"wires":[["6e2ccb.e8cd8334"]]},{"id":"a7c96619.f361f8","type":"inject","z":"63e478e.65faa88","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"num","x":190,"y":1060,"wires":[["11e1f130.dac757"]]},{"id":"2dd83b4c.c1a11c","type":"inject","z":"63e478e.65faa88","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":190,"y":1120,"wires":[["3e02e078.acce6"]]},{"id":"d9fbcedb.10074","type":"link in","z":"63e478e.65faa88","name":"% in","links":["1dc26d15.ca55bb","2120248f.394364"],"x":135,"y":480,"wires":[["5223a068.a5d2b8"]]},{"id":"5223a068.a5d2b8","type":"function","z":"63e478e.65faa88","name":"Decision up/down","func":"var local=flow.get('data') || {};\n\n\nif (local.count===undefined)//test exists\n{\n  return [ msg, null, null ];\n}\n\n  msg.demand = msg.payload; \n  msg.initial = local.count;\n\nif (msg.payload > local.count)//test Subir\n{\n  msg.type =\"up\";\n  msg.payload=msg.payload - local.count;\n  if (msg.payload > 100)//test exists\n        {\n            msg.payload=100;\n        }\n\n  return [ null, msg, null ];\n}\n\n\nif (msg.payload < local.count)//test Bajar\n{\n      msg.type =\"down\";\n      msg.payload=local.count - msg.payload;\n      \n      if (msg.payload < 0)//test exists\n            {\n                msg.payload=0;\n            }\n      else {      \n          var i = parseInt(msg.payload);\n          i = i * -1;    //invierto el signo negativo del valor\n          msg.payload = i;\n       }\n    \n      return [ null, null, msg ];\n}","outputs":3,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":480,"wires":[["384bdf78.228fc","10ef7bd1.7223cc","43d90a74.c7f6b4"],["e52c1604.f796e8","43d90a74.c7f6b4"],["3012823f.c8026e","43d90a74.c7f6b4"]]},{"id":"e52c1604.f796e8","type":"link out","z":"63e478e.65faa88","name":"","links":["92065079.5969b"],"x":455,"y":540,"wires":[]},{"id":"3012823f.c8026e","type":"link out","z":"63e478e.65faa88","name":"","links":["e4d596a1.2e7"],"x":455,"y":580,"wires":[]},{"id":"4954a37e.de9c7c","type":"change","z":"63e478e.65faa88","name":"Baja","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"down\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":690,"y":460,"wires":[["fae2d57d.c1ab08"]]},{"id":"fae2d57d.c1ab08","type":"link out","z":"63e478e.65faa88","name":"","links":["1c56dbfe.fe5d8c"],"x":1055,"y":460,"wires":[]},{"id":"f13f6196.6b1ea8","type":"mytimeout","z":"63e478e.65faa88","name":"","outtopic":"","outsafe":"","outwarning":"","outunsafe":"{\"order\":\"stop\"}","warning":"","timer":"${move_time}","debug":false,"ndebug":false,"ignoreCase":false,"repeat":false,"again":false,"x":710,"y":500,"wires":[["fae2d57d.c1ab08","8454bdfc.54bb98","60d22480.b7eaac"],[]]},{"id":"384bdf78.228fc","type":"switch","z":"63e478e.65faa88","name":"Cancel","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"cancel","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":500,"y":460,"wires":[["4954a37e.de9c7c"]]},{"id":"8454bdfc.54bb98","type":"link out","z":"63e478e.65faa88","name":"","links":["87910d13.bcccc8"],"x":1055,"y":500,"wires":[]},{"id":"10ef7bd1.7223cc","type":"change","z":"63e478e.65faa88","name":"","rules":[{"t":"set","p":"backup","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":520,"y":500,"wires":[["f13f6196.6b1ea8"]]},{"id":"60d22480.b7eaac","type":"change","z":"63e478e.65faa88","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"backup","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":900,"y":540,"wires":[["6daf4d9c.8250cc"]]},{"id":"6daf4d9c.8250cc","type":"link out","z":"63e478e.65faa88","name":"","links":["92065079.5969b"],"x":1055,"y":540,"wires":[]},{"id":"4cc933e4.acb3ec","type":"comment","z":"63e478e.65faa88","name":"%Directo","info":"","x":80,"y":440,"wires":[]},{"id":"389c374.a3669c8","type":"comment","z":"63e478e.65faa88","name":"Porcentajes","info":"Control de variable de estado de porcentaje de persiana.","x":90,"y":960,"wires":[]},{"id":"acac6149.291998","type":"function","z":"63e478e.65faa88","name":"","func":"msg.payload = \"Persiana al \"+msg.payload+\"%\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":940,"y":1180,"wires":[[]]},{"id":"e6c45224.e16c38","type":"comment","z":"63e478e.65faa88","name":"% de persiana","info":"Salida para sabee el % de la persiana","x":1060,"y":1120,"wires":[]},{"id":"de9a2f0b.21ded","type":"comment","z":"63e478e.65faa88","name":"Estado del nodo","info":"Saber que está trabajando dentro del nodo","x":1020,"y":1240,"wires":[]},{"id":"ad6fafc4.0a3ee8","type":"link out","z":"63e478e.65faa88","name":"","links":["a539e644.e0e88"],"x":155,"y":740,"wires":[]},{"id":"4d50d76a.1133e","type":"change","z":"63e478e.65faa88","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"\"% ON\"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":1280,"wires":[[]]},{"id":"550cce7d.c19bc","type":"change","z":"63e478e.65faa88","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"\"Incremento ON\"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":1340,"wires":[[]]},{"id":"559409c3.c40fa","type":"link out","z":"63e478e.65faa88","name":"","links":["7f5afe65.6cec68"],"x":155,"y":900,"wires":[]},{"id":"43d90a74.c7f6b4","type":"link out","z":"63e478e.65faa88","name":"","links":["2b5fd8f3.bd8208"],"x":295,"y":560,"wires":[]},{"id":"a6e8d642.9e8678","type":"change","z":"63e478e.65faa88","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"\"Decremento ON\"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":1400,"wires":[[]]},{"id":"2b5fd8f3.bd8208","type":"link in","z":"63e478e.65faa88","name":"","links":["43d90a74.c7f6b4"],"x":715,"y":1280,"wires":[["4d50d76a.1133e"]]},{"id":"a539e644.e0e88","type":"link in","z":"63e478e.65faa88","name":"","links":["ad6fafc4.0a3ee8"],"x":715,"y":1340,"wires":[["550cce7d.c19bc"]]},{"id":"7f5afe65.6cec68","type":"link in","z":"63e478e.65faa88","name":"","links":["559409c3.c40fa"],"x":715,"y":1400,"wires":[["a6e8d642.9e8678"]]},{"id":"fa6de207.a77b08","type":"mqtt out","z":"63e478e.65faa88","name":"MQTT","topic":"${MQTT_Topic}","qos":"1","retain":"","broker":"cc03406e.951f78","x":1150,"y":100,"wires":[]},{"id":"a5e77256.120518","type":"switch","z":"63e478e.65faa88","name":"Cancel","property":"MQTT_ON","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1020,"y":100,"wires":[["fa6de207.a77b08"]]},{"id":"d550f1c0.09d7b8","type":"switch","z":"63e478e.65faa88","name":"","property":"topic","propertyType":"msg","rules":[{"t":"neq","v":"block","vt":"str"},{"t":"eq","v":"block","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":130,"y":120,"wires":[["3f606e56.86ad72","98f540f0.db2f18"],["30c0f600.875d8a"]]},{"id":"3a7a17c5.851db","type":"link out","z":"63e478e.65faa88","name":"","links":["68113946.401818"],"x":495,"y":260,"wires":[]},{"id":"48c3290f.6cc2f8","type":"change","z":"63e478e.65faa88","name":"Block","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"block\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":260,"wires":[["3a7a17c5.851db"]]},{"id":"30c0f600.875d8a","type":"switch","z":"63e478e.65faa88","name":"","property":"payload","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":270,"y":280,"wires":[["48c3290f.6cc2f8"],["cd43b78a.f9782"]]},{"id":"cd43b78a.f9782","type":"change","z":"63e478e.65faa88","name":"unlock","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"unlock\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":300,"wires":[["3a7a17c5.851db"]]},{"id":"df350fbe.84ace","type":"mqtt out","z":"63e478e.65faa88","name":"MQTT Retain","topic":"${MQTT_Topic}","qos":"1","retain":"true","broker":"cc03406e.951f78","x":620,"y":380,"wires":[]},{"id":"ec4eb5d7.afcf5","type":"switch","z":"63e478e.65faa88","name":"Cancel","property":"MQTT_ON","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":460,"y":380,"wires":[["df350fbe.84ace"]]},{"id":"68113946.401818","type":"link in","z":"63e478e.65faa88","name":"","links":["3a7a17c5.851db"],"x":335,"y":380,"wires":[["ec4eb5d7.afcf5"]]},{"id":"977f3eec.f3d9b","type":"debug","z":"f0ddc17c.4ba93","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":750,"y":160,"wires":[]},{"id":"b3395f62.8419b","type":"switch","z":"fa9b3c4d.e0031","name":"","property":"time_to_use","propertyType":"msg","rules":[{"t":"eq","v":"standar","vt":"str"},{"t":"null"},{"t":"eq","v":"up_whit_correction","vt":"str"},{"t":"eq","v":"down_whit_correction","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":330,"y":760,"wires":[["ca4eeb59.eda1b8"],["ca4eeb59.eda1b8"],["717ef713.35a63"],["30ab0d4.8956ff2"]]},{"id":"717ef713.35a63","type":"range","z":"fa9b3c4d.e0031","minin":"0","maxin":"100","minout":"0","maxout":"${up_whit_correction}","action":"scale","round":false,"property":"payload","name":"conversor tiempo","x":530,"y":760,"wires":[["9ebd2d0e.11b35"]]},{"id":"30ab0d4.8956ff2","type":"range","z":"fa9b3c4d.e0031","minin":"0","maxin":"100","minout":"0","maxout":"${down_whit_correction}","action":"scale","round":false,"property":"payload","name":"conversor tiempo","x":530,"y":800,"wires":[["9ebd2d0e.11b35"]]},{"id":"8be55b70.cc5e9","type":"debug","z":"f0ddc17c.4ba93","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":750,"y":420,"wires":[]},{"id":"eca93e8d.74a7e8","type":"range","z":"fa9b3c4d.e0031","minin":"0","maxin":"100","minout":"0","maxout":"${move_time}","action":"scale","round":false,"property":"payload","name":"conversor tiempo","x":490,"y":980,"wires":[["c4b0adf0.a4f1f"]]},{"id":"83906244.912c58","type":"switch","z":"fa9b3c4d.e0031","name":"","property":"time_to_use","propertyType":"msg","rules":[{"t":"eq","v":"standar","vt":"str"},{"t":"null"},{"t":"eq","v":"up_whit_correction","vt":"str"},{"t":"eq","v":"down_whit_correction","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":290,"y":1020,"wires":[["eca93e8d.74a7e8"],["eca93e8d.74a7e8"],["db35e674.a78f68"],["401c0185.5d8008"]]},{"id":"db35e674.a78f68","type":"range","z":"fa9b3c4d.e0031","minin":"0","maxin":"100","minout":"0","maxout":"${up_whit_correction}","action":"scale","round":false,"property":"payload","name":"conversor tiempo","x":490,"y":1020,"wires":[["c4b0adf0.a4f1f"]]},{"id":"401c0185.5d8008","type":"range","z":"fa9b3c4d.e0031","minin":"0","maxin":"100","minout":"0","maxout":"${down_whit_correction}","action":"scale","round":false,"property":"payload","name":"conversor tiempo","x":490,"y":1060,"wires":[["c4b0adf0.a4f1f"]]},{"id":"71b26012.8fa7e","type":"comment","z":"f0ddc17c.4ba93","name":"Paquete de entrada","info":"","x":800,"y":240,"wires":[]},{"id":"1f965254.935f5e","type":"comment","z":"f0ddc17c.4ba93","name":"Mensajes MQTT","info":"","x":780,"y":120,"wires":[]},{"id":"1c00f273.4a4ab6","type":"comment","z":"f0ddc17c.4ba93","name":"Porcentaje en tiempo + Stop","info":"","x":820,"y":380,"wires":[]},{"id":"3f6f4cfc.f2a8ac","type":"inject","z":"f3d60e61.2dd1f8","name":"Temp configurado","props":[{"p":"command","v":"GetTemperatureReadingRequest","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payloadType":"str","x":130,"y":520,"wires":[["66614344.de9284"]]},{"id":"e5c5f837.9ec65","type":"inject","z":"f3d60e61.2dd1f8","name":"OFF","props":[{"p":"command","v":"TurnOffRequest","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payloadType":"str","x":90,"y":480,"wires":[["66614344.de9284"]]},{"id":"73a970a5.12a03","type":"inject","z":"f3d60e61.2dd1f8","name":"ON","props":[{"p":"command","v":"TurnOnRequest","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payloadType":"str","x":90,"y":440,"wires":[["66614344.de9284"]]},{"id":"c79c0012.4aa438","type":"debug","z":"f3d60e61.2dd1f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1130,"y":260,"wires":[]},{"id":"3161d726.e3ea08","type":"tcp in","z":"5ec721c6.6a6898","d":true,"name":"","server":"server","host":"","port":"1881","datamode":"stream","datatype":"buffer","newline":"","topic":"","base64":false,"x":230,"y":140,"wires":[["8f86581e.6e0fa8"]]},{"id":"b63db6e4.31db5","type":"debug","z":"5ec721c6.6a6898","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":610,"y":140,"wires":[]},{"id":"8f86581e.6e0fa8","type":"function","z":"5ec721c6.6a6898","name":"ASCII to String","func":"msg.payload = msg.payload.toString();\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":420,"y":140,"wires":[["b63db6e4.31db5"]]},{"id":"922ba635.635788","type":"debug","z":"f3d60e61.2dd1f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1360,"y":140,"wires":[]},{"id":"53b0901c.daeb5","type":"ui_template","z":"dac02106.9590c","group":"8a50f58a.83fee8","name":"Nest","order":1,"width":"0","height":"0","format":"<! https://codepen.io/fskirschbaum/pen/MYJNaj?html-preprocessor=none -->\n\n<div id=\"thermostat\">\n\t<!-- Modificado para mostrar la temperatura dentro del termostato <div id=\"real_temp\" style=\"position:absolute; top:0; left: 0;\"> 0.0 </div> -->\n\t<div id=\"statusLed\" style=\"position:absolute; top:83%; right: 46%;\"> <div id=\"statusLedColor\" class=\"led-green\"> </div>\n</div>\n\n<style>\n\n@import url(http://fonts.googleapis.com/css?family=Open+Sans:300);\n\n#thermostat {\n margin: 0 auto;\n -webkit-tap-highlight-color: rgba(0, 0, 0, 0);\n}\n\n.dial {\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n}\n.dial.away .dial__ico__leaf {\n    visibility: hidden;\n}\n.dial.away .dial__lbl--target {\n    visibility: hidden;\n}\n.dial.away .dial__lbl--target--half {\n    visibility: hidden;\n}\n.dial.away .dial__lbl--away {\n    opacity: 1;\n}\n.dial .dial__shape {\n    -webkit-transition: fill 0.5s;\n    transition: fill 0.5s;\n}\n.dial path.dial__ico__leaf {\n    fill: #13EB13;\n    opacity: 0;\n    -webkit-transition: opacity 0.5s;\n    transition: opacity 0.5s;\n    pointer-events: none;\n}\n.dial.has-leaf .dial__ico__leaf {\n    display: block;\n    opacity: 1;\n    pointer-events: initial;\n}\n.dial__editableIndicator {\n    fill-rule: evenodd;\n    opacity: 0;\n    -webkit-transition: opacity 0.5s;\n    transition: opacity 0.5s;\n}\n.dial--edit path.dial__editableIndicator {\n    fill: white;\n}\n.dial--edit .dial__editableIndicator {\n    opacity: 1;\n}\n.dial--state--off .dial__shape {\n    fill: #3d3c3c;\n}\n.dial--state--heating .dial__shape {\n    fill: #EF7D32;\n}\n.dial--state--cooling .dial__shape {\n    fill: #007AF1;\n}\n.dial .dial__ticks path {\n    fill: rgba(255, 255, 255, 0.3);\n}\n.dial .dial__ticks path.active {\n    fill: rgba(255, 255, 255, 0.8);\n}\n.dial text {\n    fill: white;\n    text-anchor: middle;\n    font-family: Helvetica, sans-serif;\n    alignment-baseline: central;\n}\n.dial__lbl--target {\n    font-size: 120px;\n    font-weight: bold;\n}\n.dial__lbl--target--half {\n    font-size: 40px;\n    font-weight: bold;\n    opacity: 0;\n    -webkit-transition: opacity 0.1s;\n    transition: opacity 0.1s;\n}\n.dial__lbl--target--half.shown {\n    opacity: 1;\n    -webkit-transition: opacity 0s;\n    transition: opacity 0s;\n}\n.dial__lbl--ambient {\n    font-size: 22px;\n    font-weight: bold;\n}\n.dial__lbl--away {\n    font-size: 72px;\n    font-weight: bold;\n    opacity: 0;\n    pointer-events: none;\n}\n#controls {\n    font-family: Open Sans;\n    background-color: rgba(255, 255, 255, 0.25);\n    padding: 20px;\n    border-radius: 5px;\n    position: absolute;\n    left: 50%;\n    -webkit-transform: translatex(-50%);\n    transform: translatex(-50%);\n    margin-top: 20px;\n}\n#controls label {\n    text-align: left;\n    display: block;\n}\n#controls label span {\n    display: inline-block;\n    width: 200px;\n    text-align: right;\n    font-size: 0.8em;\n    text-transform: uppercase;\n}\n#controls p {\n    margin: 0;\n    margin-bottom: 1em;\n    padding-bottom: 1em;\n    border-bottom: 2px solid #ccc;\n}\n\n/*---------------------------------------------------*/\n.container {\n\tbackground-size: cover;\n  background: rgb(226,226,226); /* Old browsers */\n  background: -moz-linear-gradient(top,  rgba(226,226,226,1) 0%, rgba(219,219,219,1) 50%, rgba(209,209,209,1) 51%, rgba(254,254,254,1) 100%); /* FF3.6+ */\n  background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(226,226,226,1)), color-stop(50%,rgba(219,219,219,1)), color-stop(51%,rgba(209,209,209,1)), color-stop(100%,rgba(254,254,254,1))); /* Chrome,Safari4+ */\n  background: -webkit-linear-gradient(top,  rgba(226,226,226,1) 0%,rgba(219,219,219,1) 50%,rgba(209,209,209,1) 51%,rgba(254,254,254,1) 100%); /* Chrome10+,Safari5.1+ */\n  background: -o-linear-gradient(top,  rgba(226,226,226,1) 0%,rgba(219,219,219,1) 50%,rgba(209,209,209,1) 51%,rgba(254,254,254,1) 100%); /* Opera 11.10+ */\n  background: -ms-linear-gradient(top,  rgba(226,226,226,1) 0%,rgba(219,219,219,1) 50%,rgba(209,209,209,1) 51%,rgba(254,254,254,1) 100%); /* IE10+ */\n  background: linear-gradient(to bottom,  rgba(226,226,226,1) 0%,rgba(219,219,219,1) 50%,rgba(209,209,209,1) 51%,rgba(254,254,254,1) 100%); /* W3C */\n  filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#e2e2e2', endColorstr='#fefefe',GradientType=0 ); /* IE6-9 */\n  padding: 20px;\n}\n\n.led-box {\n  height: 30px;\n  width: 25%;\n  margin: 10px 0;\n  float: left;\n}\n\n.led-box p {\n  font-size: 12px;\n  text-align: center;\n  margin: 1em;\n}\n\n.led-red {\n  margin: 0 auto;\n  width: 24px;\n  height: 24px;\n  background-color: #F00;\n  border-radius: 50%;\n  box-shadow: rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset #441313 0 -1px 9px, rgba(255, 0, 0, 0.5) 0 2px 12px;\n  -webkit-animation: blinkRed 1.5s infinite;\n  -moz-animation: blinkRed 1.5s infinite;\n  -ms-animation: blinkRed 1.5s infinite;\n  -o-animation: blinkRed 1.5s infinite;\n  animation: blinkRed 1.5s infinite;\n}\n\n@-webkit-keyframes blinkRed {\n    from { background-color: #F00; }\n    50% { background-color: #A00; box-shadow: rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset #441313 0 -1px 9px, rgba(255, 0, 0, 0.5) 0 2px 0;}\n    to { background-color: #F00; }\n}\n@-moz-keyframes blinkRed {\n    from { background-color: #F00; }\n    50% { background-color: #A00; box-shadow: rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset #441313 0 -1px 9px, rgba(255, 0, 0, 0.5) 0 2px 0;}\n    to { background-color: #F00; }\n}\n@-ms-keyframes blinkRed {\n    from { background-color: #F00; }\n    50% { background-color: #A00; box-shadow: rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset #441313 0 -1px 9px, rgba(255, 0, 0, 0.5) 0 2px 0;}\n    to { background-color: #F00; }\n}\n@-o-keyframes blinkRed {\n    from { background-color: #F00; }\n    50% { background-color: #A00; box-shadow: rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset #441313 0 -1px 9px, rgba(255, 0, 0, 0.5) 0 2px 0;}\n    to { background-color: #F00; }\n}\n@keyframes blinkRed {\n    from { background-color: #F00; }\n    50% { background-color: #A00; box-shadow: rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset #441313 0 -1px 9px, rgba(255, 0, 0, 0.5) 0 2px 0;}\n    to { background-color: #F00; }\n}\n\n.led-yellow {\n  margin: 0 auto;\n  width: 24px;\n  height: 24px;\n  background-color: #FF0;\n  border-radius: 50%;\n  box-shadow: rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset #808002 0 -1px 9px, #FF0 0 2px 12px;\n  -webkit-animation: blinkYellow 1s infinite;\n  -moz-animation: blinkYellow 1s infinite;\n  -ms-animation: blinkYellow 1s infinite;\n  -o-animation: blinkYellow 1s infinite;\n  animation: blinkYellow 1s infinite;\n}\n\n@-webkit-keyframes blinkYellow {\n    from { background-color: #FF0; }\n    50% { background-color: #AA0; box-shadow: rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset #808002 0 -1px 9px, #FF0 0 2px 0; }\n    to { background-color: #FF0; }\n}\n@-moz-keyframes blinkYellow {\n    from { background-color: #FF0; }\n    50% { background-color: #AA0; box-shadow: rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset #808002 0 -1px 9px, #FF0 0 2px 0; }\n    to { background-color: #FF0; }\n}\n@-ms-keyframes blinkYellow {\n    from { background-color: #FF0; }\n    50% { background-color: #AA0; box-shadow: rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset #808002 0 -1px 9px, #FF0 0 2px 0; }\n    to { background-color: #FF0; }\n}\n@-o-keyframes blinkYellow {\n    from { background-color: #FF0; }\n    50% { background-color: #AA0; box-shadow: rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset #808002 0 -1px 9px, #FF0 0 2px 0; }\n    to { background-color: #FF0; }\n}\n@keyframes blinkYellow {\n    from { background-color: #FF0; }\n    50% { background-color: #AA0; box-shadow: rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset #808002 0 -1px 9px, #FF0 0 2px 0; }\n    to { background-color: #FF0; }\n}\n\n.led-green {\n  margin: 0 auto;\n  width: 24px;\n  height: 24px;\n  background-color: #ABFF00;\n  border-radius: 50%;\n  box-shadow: rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset #304701 0 -1px 9px, #89FF00 0 2px 12px;\n}\n\n.led-black {\n  margin: 0 auto;\n  width: 24px;\n  height: 24px;\n  background-color: #121212;\n  border-radius: 50%;\n  box-shadow: rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset #121212 0 -1px 9px, #121212 0 2px 12px;\n}\n\n.led-blue {\n  margin: 0 auto;\n  width: 24px;\n  height: 24px;\n  background-color: #0094CE;\n  border-radius: 50%;\n  box-shadow: rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset #006 0 -1px 9px, #3F8CFF 0 2px 14px;\n}\n/*------------------------------------------*/\n</style>\n<script>\n    //modificaciones echao\n\t\nfunction echaoMod(ambient,led_status){\n    \n    //document.getElementById(\"real_temp\").innerHTML = ambient;\n    \n    switch (led_status) {\n        case \"On\":\n            document.getElementById(\"statusLedColor\").className = \"led-red\";\n        break;\n        \n        case \"Wait\":\n            document.getElementById(\"statusLedColor\").className = \"led-blue\";\n        break;\n        \n        case \"Off\":\n            document.getElementById(\"statusLedColor\").className = \"led-black\";\n        break;\n    };\n\n};\n\n\nvar thermostatDial = (function() {\n\t\n\t/*\n\t * Utility functions\n\t */\n\t\n\t// Create an element with proper SVG namespace, optionally setting its attributes and appending it to another element\n\tfunction createSVGElement(tag,attributes,appendTo) {\n\t\tvar element = document.createElementNS('http://www.w3.org/2000/svg',tag);\n\t\tattr(element,attributes);\n\t\tif (appendTo) {\n\t\t\tappendTo.appendChild(element);\n\t\t}\n\t\treturn element;\n\t}\n\t\n\t// Set attributes for an element\n\tfunction attr(element,attrs) {\n\t\tfor (var i in attrs) {\n\t\t\telement.setAttribute(i,attrs[i]);\n\t\t}\n\t}\n\t\n\t// Rotate a cartesian point about given origin by X degrees\n\tfunction rotatePoint(point, angle, origin) {\n\t\tvar radians = angle * Math.PI/180;\n\t\tvar x = point[0]-origin[0];\n\t\tvar y = point[1]-origin[1];\n\t\tvar x1 = x*Math.cos(radians) - y*Math.sin(radians) + origin[0];\n\t\tvar y1 = x*Math.sin(radians) + y*Math.cos(radians) + origin[1];\n\t\treturn [x1,y1];\n\t}\n\t\n\t// Rotate an array of cartesian points about a given origin by X degrees\n\tfunction rotatePoints(points, angle, origin) {\n\t\treturn points.map(function(point) {\n\t\t\treturn rotatePoint(point, angle, origin);\n\t\t});\n\t}\n\t\n\t// Given an array of points, return an SVG path string representing the shape they define\n\tfunction pointsToPath(points) {\n\t\treturn points.map(function(point, iPoint) {\n\t\t\treturn (iPoint>0?'L':'M') + point[0] + ' ' + point[1];\n\t\t}).join(' ')+'Z';\n\t}\n\t\n\tfunction circleToPath(cx, cy, r) {\n\t\treturn [\n\t\t\t\"M\",cx,\",\",cy,\n\t\t\t\"m\",0-r,\",\",0,\n\t\t\t\"a\",r,\",\",r,0,1,\",\",0,r*2,\",\",0,\n\t\t\t\"a\",r,\",\",r,0,1,\",\",0,0-r*2,\",\",0,\n\t\t\t\"z\"\n\t\t].join(' ').replace(/\\s,\\s/g,\",\");\n\t}\n\t\n\tfunction donutPath(cx,cy,rOuter,rInner) {\n\t\treturn circleToPath(cx,cy,rOuter) + \" \" + circleToPath(cx,cy,rInner);\n\t}\n\t\n\t// Restrict a number to a min + max range\n\tfunction restrictToRange(val,min,max) {\n\t\tif (val < min) return min;\n\t\tif (val > max) return max;\n\t\treturn val;\n\t}\n\t\n\t// Round a number to the nearest 0.5\n\tfunction roundHalf(num) {\n\t\treturn Math.round(num*2)/2;\n\t}\n\t\n\tfunction setClass(el, className, state) {\n\t\tel.classList[state ? 'add' : 'remove'](className);\n\t}\n\t\n\t/*\n\t * The \"MEAT\"\n\t */\n\n\treturn function(targetElement, options) {\n\t\tvar self = this;\n\t\t\n\t\t/*\n\t\t * Options\n\t\t */\n\t\toptions = options || {};\n\t\toptions = {\n\t\t\tdiameter: options.diameter || 400,\n\t\t\tminValue: options.minValue || 10, // Minimum value for target temperature\n\t\t\tmaxValue: options.maxValue || 35, // Maximum value for target temperature\n\t\t\tnumTicks: options.numTicks || 200, // Number of tick lines to display around the dial\n\t\t\tonSetTargetTemperature: options.onSetTargetTemperature || function() {}, // Function called when new target temperature set by the dial\n\t\t};\n\t\t\n\t\t/*\n\t\t * Properties - calculated from options in many cases\n\t\t */\n\t\tvar properties = {\n\t\t\ttickDegrees: 300, // Degrees of the dial that should be covered in tick lines\n\t\t\trangeValue: options.maxValue - options.minValue,\n\t\t\tradius: options.diameter/2,\n\t\t\tticksOuterRadius: options.diameter / 30,\n\t\t\tticksInnerRadius: options.diameter / 8,\n\t\t\thvac_states: ['off', 'heating', 'cooling'],\n\t\t\tdragLockAxisDistance: 15,\n\t\t}\n\t\tproperties.lblAmbientPosition = [properties.radius, properties.ticksOuterRadius-(properties.ticksOuterRadius-properties.ticksInnerRadius)/2]\n\t\tproperties.offsetDegrees = 180-(360-properties.tickDegrees)/2;\n\t\t\n\t\t/*\n\t\t * Object state\n\t\t */\n\t\tvar state = {\n\t\t\ttarget_temperature: options.minValue,\n\t\t\tambient_temperature: options.minValue,\n\t\t\thvac_state: properties.hvac_states[0],\n\t\t\thas_leaf: false,\n\t\t\taway: false\n\t\t};\n\t\t\n\t\t/*\n\t\t * Property getter / setters\n\t\t */\n\t\tObject.defineProperty(this,'target_temperature',{\n\t\t\tget: function() {\n\t\t\t\treturn state.target_temperature;\n\t\t\t},\n\t\t\tset: function(val) {\n\t\t\t\tstate.target_temperature = restrictTargetTemperature(+val);\n\t\t\t\trender();\n\t\t\t}\n\t\t});\n\t\tObject.defineProperty(this,'ambient_temperature',{\n\t\t\tget: function() {\n\t\t\t\treturn state.ambient_temperature;\n\t\t\t},\n\t\t\tset: function(val) {\n\t\t\t\tstate.ambient_temperature = roundHalf(+val);\n\t\t\t\trender();\n\t\t\t}\n\t\t});\n\t\tObject.defineProperty(this,'hvac_state',{\n\t\t\tget: function() {\n\t\t\t\treturn state.hvac_state;\n\t\t\t},\n\t\t\tset: function(val) {\n\t\t\t\tif (properties.hvac_states.indexOf(val)>=0) {\n\t\t\t\t\tstate.hvac_state = val;\n\t\t\t\t\trender();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\tfunction str2bool(strvalue){\n          return (strvalue && typeof strvalue == 'string') ? (strvalue.toLowerCase() == 'true') : (strvalue == true);\n        }\n\t\tObject.defineProperty(this,'has_leaf',{\n\t\t\tget: function() {\n\t\t\t\treturn state.has_leaf;\n\t\t\t},\n\t\t\tset: function(val) {\n\t\t\t\tstate.has_leaf = !!str2bool(val);\n\t\t\t\trender();\n\t\t\t}\n\t\t});\n\t\tObject.defineProperty(this,'away',{\n\t\t\tget: function() {\n\t\t\t\treturn state.away;\n\t\t\t},\n\t\t\tset: function(val) {\n\t\t\t\tstate.away = !!str2bool(val);\n\t\t\t\trender();\n\t\t\t}\n\t\t});\n\t\t\n\t\t/*\n\t\t * SVG\n\t\t */\n\t\tvar svg = createSVGElement('svg',{\n\t\t\twidth: '100%', //options.diameter+'px',\n\t\t\theight: '100%', //options.diameter+'px',\n\t\t\tviewBox: '0 0 '+options.diameter+' '+options.diameter,\n\t\t\tclass: 'dial'\n\t\t},targetElement);\n\t\t// CIRCULAR DIAL\n\t\tvar circle = createSVGElement('circle',{\n\t\t\tcx: properties.radius,\n\t\t\tcy: properties.radius,\n\t\t\tr: properties.radius,\n\t\t\tclass: 'dial__shape'\n\t\t},svg);\n\t\t// EDITABLE INDICATOR\n\t\tvar editCircle = createSVGElement('path',{\n\t\t\td: donutPath(properties.radius,properties.radius,properties.radius-4,properties.radius-8),\n\t\t\tclass: 'dial__editableIndicator',\n\t\t},svg);\n\t\t\n\t\t/*\n\t\t * Ticks\n\t\t */\n\t\tvar ticks = createSVGElement('g',{\n\t\t\tclass: 'dial__ticks'\t\n\t\t},svg);\n\t\tvar tickPoints = [\n\t\t\t[properties.radius-1, properties.ticksOuterRadius],\n\t\t\t[properties.radius+1, properties.ticksOuterRadius],\n\t\t\t[properties.radius+1, properties.ticksInnerRadius],\n\t\t\t[properties.radius-1, properties.ticksInnerRadius]\n\t\t];\n\t\tvar tickPointsLarge = [\n\t\t\t[properties.radius-1.5, properties.ticksOuterRadius],\n\t\t\t[properties.radius+1.5, properties.ticksOuterRadius],\n\t\t\t[properties.radius+1.5, properties.ticksInnerRadius+20],\n\t\t\t[properties.radius-1.5, properties.ticksInnerRadius+20]\n\t\t];\n\t\tvar theta = properties.tickDegrees/options.numTicks;\n\t\tvar tickArray = [];\n\t\tfor (var iTick=0; iTick<options.numTicks; iTick++) {\n\t\t\ttickArray.push(createSVGElement('path',{d:pointsToPath(tickPoints)},ticks));\n\t\t};\n\t\t\n\t\t/*\n\t\t * Labels\n\t\t */\n\t\tvar lblTarget = createSVGElement('text',{\n\t\t\tx: properties.radius,\n\t\t\ty: properties.radius,\n\t\t\tclass: 'dial__lbl dial__lbl--target'\n\t\t},svg);\n\t\tvar lblTarget_text = document.createTextNode('');\n\t\tlblTarget.appendChild(lblTarget_text);\n\t\t//\n\t\tvar lblTargetHalf = createSVGElement('text',{\n\t\t\tx: properties.radius + properties.radius/2.5,\n\t\t\ty: properties.radius - properties.radius/8,\n\t\t\tclass: 'dial__lbl dial__lbl--target--half'\n\t\t},svg);\n\t\tvar lblTargetHalf_text = document.createTextNode('5');\n\t\tlblTargetHalf.appendChild(lblTargetHalf_text);\n\t\t//\n\t\tvar lblAmbient = createSVGElement('text',{\n\t\t\tclass: 'dial__lbl dial__lbl--ambient'\n\t\t},svg);\n\t\tvar lblAmbient_text = document.createTextNode('');\n\t\tlblAmbient.appendChild(lblAmbient_text);\n\t\t//\n\t\tvar lblAway = createSVGElement('text',{\n\t\t\tx: properties.radius,\n\t\t\ty: properties.radius,\n\t\t\tclass: 'dial__lbl dial__lbl--away'\n\t\t},svg);\n\t\tvar lblAway_text = document.createTextNode('AWAY');\n\t\tlblAway.appendChild(lblAway_text);\n\t\t//\n\t\tvar icoLeaf = createSVGElement('path',{\n\t\t\tclass: 'dial__ico__leaf'\n\t\t},svg);\n\t\t\n\t\t/*\n\t\t * LEAF\n\t\t */\n\t\tvar leafScale = properties.radius/5/100;\n\t\tvar leafDef = [\"M\", 3, 84, \"c\", 24, 17, 51, 18, 73, -6, \"C\", 100, 52, 100, 22, 100, 4, \"c\", -13, 15, -37, 9, -70, 19, \"C\", 4, 32, 0, 63, 0, 76, \"c\", 6, -7, 18, -17, 33, -23, 24, -9, 34, -9, 48, -20, -9, 10, -20, 16, -43, 24, \"C\", 22, 63, 8, 78, 3, 84, \"z\"].map(function(x) {\n\t\t\treturn isNaN(x) ? x : x*leafScale;\n\t\t}).join(' ');\n\t\tvar translate = [properties.radius-(leafScale*100*0.5),properties.radius*1.5]\n\t\tvar icoLeaf = createSVGElement('path',{\n\t\t\tclass: 'dial__ico__leaf',\n\t\t\td: leafDef,\n\t\t\ttransform: 'translate('+translate[0]+','+translate[1]+')'\n\t\t},svg);\n\t\t\t\n\t\t/*\n\t\t * RENDER\n\t\t */\n\t\tfunction render() {\n\t\t\trenderAway();\n\t\t\trenderHvacState();\n\t\t\trenderTicks();\n\t\t\trenderTargetTemperature();\n\t\t\trenderAmbientTemperature();\n\t\t\trenderLeaf();\n\t\t}\n\t\trender();\n\n\t\t/*\n\t\t * RENDER - ticks\n\t\t */\n\t\tfunction renderTicks() {\n\t\t\tvar vMin, vMax;\n\t\t\tif (self.away) {\n\t\t\t\tvMin = self.ambient_temperature;\n\t\t\t\tvMax = vMin;\n\t\t\t} else {\n\t\t\t\tvMin = Math.min(self.ambient_temperature, self.target_temperature);\n\t\t\t\tvMax = Math.max(self.ambient_temperature, self.target_temperature);\n\t\t\t}\n\t\t\tvar min = restrictToRange(Math.round((vMin-options.minValue)/properties.rangeValue * options.numTicks),0,options.numTicks-1);\n\t\t\tvar max = restrictToRange(Math.round((vMax-options.minValue)/properties.rangeValue * options.numTicks),0,options.numTicks-1);\n\t\t\t//\n\t\t\ttickArray.forEach(function(tick,iTick) {\n\t\t\t\tvar isLarge = iTick==min || iTick==max;\n\t\t\t\tvar isActive = iTick >= min && iTick <= max;\n\t\t\t\tattr(tick,{\n\t\t\t\t\td: pointsToPath(rotatePoints(isLarge ? tickPointsLarge: tickPoints,iTick*theta-properties.offsetDegrees,[properties.radius, properties.radius])),\n\t\t\t\t\tclass: isActive ? 'active' : ''\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t\n\t\t/*\n\t\t * RENDER - ambient temperature\n\t\t */\n\t\tfunction renderAmbientTemperature() {\n\t\t\tlblAmbient_text.nodeValue = Math.floor(self.ambient_temperature);\n\t\t\tif (self.ambient_temperature%1!=0) {\n\t\t\t\tlblAmbient_text.nodeValue += '⁵';\n\t\t\t}\n\t\t\tvar peggedValue = restrictToRange(self.ambient_temperature, options.minValue, options.maxValue);\n\t\t\tdegs = properties.tickDegrees * (peggedValue-options.minValue)/properties.rangeValue - properties.offsetDegrees;\n\t\t\tif (peggedValue > self.target_temperature) {\n\t\t\t\tdegs += 8;\n\t\t\t} else {\n\t\t\t\tdegs -= 8;\n\t\t\t}\n\t\t\tvar pos = rotatePoint(properties.lblAmbientPosition,degs,[properties.radius, properties.radius]);\n\t\t\tattr(lblAmbient,{\n\t\t\t\tx: pos[0],\n\t\t\t\ty: pos[1]\n\t\t\t});\n\t\t}\n\n\t\t/*\n\t\t * RENDER - target temperature\n\t\t */\n\t\tfunction renderTargetTemperature() {\n\t\t\tlblTarget_text.nodeValue = Math.floor(self.target_temperature);\n\t\t\tsetClass(lblTargetHalf,'shown',self.target_temperature%1!=0);\n\t\t}\n\t\t\n\t\t/*\n\t\t * RENDER - leaf\n\t\t */\n\t\tfunction renderLeaf() {\n\t\t\tsetClass(svg,'has-leaf',self.has_leaf);\n\t\t}\n\t\t\n\t\t/*\n\t\t * RENDER - HVAC state\n\t\t */\n\t\tfunction renderHvacState() {\n\t\t\tArray.prototype.slice.call(svg.classList).forEach(function(c) {\n\t\t\t\tif (c.match(/^dial--state--/)) {\n\t\t\t\t\tsvg.classList.remove(c);\n\t\t\t\t};\n\t\t\t});\n\t\t\tsvg.classList.add('dial--state--'+self.hvac_state);\n\t\t}\n\t\t\n\t\t/*\n\t\t * RENDER - away\n\t\t */\n\t\tfunction renderAway() {\n\t\t\tsvg.classList[self.away ? 'add' : 'remove']('away');\n\t\t}\n\t\t\n\t\t/*\n\t\t * Drag to control\n\t\t */\n\t\tvar _drag = {\n\t\t\tinProgress: false,\n\t\t\tstartPoint: null,\n\t\t\tstartTemperature: 0,\n\t\t\tlockAxis: undefined\n\t\t};\n\t\t\n\t\tfunction eventPosition(ev) {\n\t\t\tif (ev.targetTouches && ev.targetTouches.length) {\n\t\t\t\treturn [ev.targetTouches[0].clientX, ev.targetTouches[0].clientY];\n\t\t\t} else {\n\t\t\t\treturn [ev.x, ev.y];\n\t\t\t};\n\t\t}\n\t\t\n\t\tvar startDelay;\n\t\tfunction dragStart(ev) {\n\t\t\tstartDelay = setTimeout(function() {\n\t\t\t\tsetClass(svg, 'dial--edit', true);\n\t\t\t\t_drag.inProgress = true;\n\t\t\t\t_drag.startPoint = eventPosition(ev);\n\t\t\t\t_drag.startTemperature = self.target_temperature || options.minValue;\n\t\t\t\t_drag.lockAxis = undefined;\n\t\t\t},1000);\n\t\t};\n\t\t\n\t\tfunction dragEnd (ev) {\n\t\t\tclearTimeout(startDelay);\n\t\t\tsetClass(svg, 'dial--edit', false);\n\t\t\tif (!_drag.inProgress) return;\n\t\t\t_drag.inProgress = false;\n\t\t\tif (self.target_temperature != _drag.startTemperature) {\n\t\t\t\tif (typeof options.onSetTargetTemperature == 'function') {\n\t\t\t\t\toptions.onSetTargetTemperature(self.target_temperature);\n\t\t\t\t};\n\t\t\t};\n\t\t};\n\t\t\n\t\tfunction dragMove(ev) {\n\t\t\tev.preventDefault();\n\t\t\tif (!_drag.inProgress) return;\n\t\t\tvar evPos = eventPosition(ev);\n\t\t\tvar dy = _drag.startPoint[1]-evPos[1];\n\t\t\tvar dx = evPos[0] - _drag.startPoint[0];\n\t\t\tvar dxy;\n\t\t\tif (_drag.lockAxis == 'x') {\n\t\t\t\tdxy = dx;\n\t\t\t} else if (_drag.lockAxis == 'y') {\n\t\t\t\tdxy = dy;\n\t\t\t} else if (Math.abs(dy) > properties.dragLockAxisDistance) {\n\t\t\t\t_drag.lockAxis = 'y';\n\t\t\t\tdxy = dy;\n\t\t\t} else if (Math.abs(dx) > properties.dragLockAxisDistance) {\n\t\t\t\t_drag.lockAxis = 'x';\n\t\t\t\tdxy = dx;\n\t\t\t} else {\n\t\t\t\tdxy = (Math.abs(dy) > Math.abs(dx)) ? dy : dx;\n\t\t\t};\n\t\t\tvar dValue = (dxy*getSizeRatio())/(options.diameter)*properties.rangeValue;\n\t\t\tself.target_temperature = roundHalf(_drag.startTemperature+dValue);\n\t\t}\n\t\t\n\t\tsvg.addEventListener('mousedown',dragStart);\n\t\tsvg.addEventListener('touchstart',dragStart);\n\t\t\n\t\tsvg.addEventListener('mouseup',dragEnd);\n\t\tsvg.addEventListener('mouseleave',dragEnd);\n\t\tsvg.addEventListener('touchend',dragEnd);\n\t\t\n\t\tsvg.addEventListener('mousemove',dragMove);\n\t\tsvg.addEventListener('touchmove',dragMove);\n\t\t//\n\t\t\n\t\t/*\n\t\t * Helper functions\n\t\t */\n\t\tfunction restrictTargetTemperature(t) {\n\t\t\treturn restrictToRange(roundHalf(t),options.minValue,options.maxValue);\n\t\t}\n\t\t\n\t\tfunction angle(point) {\n\t\t\tvar dx = point[0] - properties.radius;\n\t\t\tvar dy = point[1] - properties.radius;\n\t\t\tvar theta = Math.atan(dx/dy) / (Math.PI/180);\n\t\t\tif (point[0]>=properties.radius && point[1] < properties.radius) {\n\t\t\t\ttheta = 90-theta - 90;\n\t\t\t} else if (point[0]>=properties.radius && point[1] >= properties.radius) {\n\t\t\t\ttheta = 90-theta + 90;\n\t\t\t} else if (point[0]<properties.radius && point[1] >= properties.radius) {\n\t\t\t\ttheta = 90-theta + 90;\n\t\t\t} else if (point[0]<properties.radius && point[1] < properties.radius) {\n\t\t\t\ttheta = 90-theta+270;\n\t\t\t}\n\t\t\treturn theta;\n\t\t};\n\t\t\n\t\tfunction getSizeRatio() {\n\t\t\treturn options.diameter / targetElement.clientWidth;\n\t\t}\n\t\t\n\t};\n})();\n\n/* ==== */\nvar initializing = true;\n\n(function(scope) {\n    var nest = new thermostatDial(document.getElementById('thermostat'),{\n    \tonSetTargetTemperature: function(v) {\n    \t    var p = {\n    \t        \"ambient_temperature\":nest.ambient_temperature,\n    \t        \"target_temperature\":v,\n    \t        \"hvac_state\":nest.hvac_state,\n    \t        \"has_leaf\": nest.has_leaf,\n    \t        \"away\":nest.away\n    \t    };\n    \t\tscope.send({topic: \"target_temperature\", payload: p});\n    \t}\n    });\n    \n    scope.$watch('msg', function(data) {\n        if (initializing) {\n            initializing = false;\n            } else {\n            nest.ambient_temperature = data.payload.ambient_temperature || 0;\n            nest.target_temperature = data.payload.target_temperature || 0;\n            nest.hvac_state = data.payload.hvac_state || \"off\";\n            nest.has_leaf = data.payload.has_leaf || false;\n            nest.away = data.payload.away || false;\n            //document.getElementById(\"real_temp\").innerHTML = data.payload.ambient_temperature;\n            echaoMod(data.payload.ambient_temperature, data.payload.flame);           \n        }\n        \n    });\n})(scope);\n\n</script>","storeOutMessages":true,"fwdInMessages":false,"resendOnRefresh":false,"templateScope":"local","className":"","x":1430,"y":180,"wires":[["9e3bcada.683d88"]]},{"id":"48f9af83.c9bab","type":"function","z":"dac02106.9590c","name":"ambient_temperature","func":"msg.topic = 'ambient_temperature';\nglobal.set(\"nest1_ambient_temperature\", msg.payload);\nglobal.set(\"last_change\", \"ambient_temperature\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1080,"y":180,"wires":[["5b9460e0.b4693"]]},{"id":"25fcda7e.45d3c6","type":"function","z":"dac02106.9590c","name":"target_temperature","func":"msg.topic = 'target_temperature';\nglobal.set(\"nest1_target_temperature\",msg.payload);\nglobal.set(\"last_change\", \"target_temperature\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1070,"y":220,"wires":[["5b9460e0.b4693"]]},{"id":"f4683732.e68048","type":"function","z":"dac02106.9590c","name":"hvac_state","func":"msg.topic = \"hvac_state\";\nglobal.set(\"nest1_hvac_state\",msg.payload);\nglobal.set(\"last_change\", \"hvac_state\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1050,"y":260,"wires":[["5b9460e0.b4693"]]},{"id":"6a363177.db336","type":"function","z":"dac02106.9590c","name":"has_leaf","func":"msg.topic = \"has_leaf\";\nglobal.set(\"nest1_has_leaf\", msg.payload);\nglobal.set(\"last_change\", \"has_leaf\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1040,"y":300,"wires":[["5b9460e0.b4693"]]},{"id":"14be9312.22620d","type":"function","z":"dac02106.9590c","name":"away","func":"msg.topic = \"away\";\nglobal.set(\"nest1_away\", msg.payload);\nglobal.set(\"last_change\", \"away\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1030,"y":340,"wires":[["5b9460e0.b4693"]]},{"id":"cf3a6910.375408","type":"inject","z":"dac02106.9590c","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"has_leaf","payload":"true","payloadType":"bool","x":770,"y":380,"wires":[["6a363177.db336"]]},{"id":"1209b194.08430e","type":"inject","z":"dac02106.9590c","name":"","repeat":"","crontab":"","once":false,"topic":"has_leaf","payload":"false","payloadType":"bool","x":770,"y":420,"wires":[["6a363177.db336"]]},{"id":"add6e6e2.1ccb08","type":"inject","z":"dac02106.9590c","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"away","payload":"true","payloadType":"str","x":760,"y":460,"wires":[["14be9312.22620d"]]},{"id":"e20f7f.792d808","type":"inject","z":"dac02106.9590c","name":"","repeat":"","crontab":"","once":false,"topic":"away","payload":"false","payloadType":"bool","x":760,"y":500,"wires":[["14be9312.22620d"]]},{"id":"4f7b210e.028b6","type":"inject","z":"dac02106.9590c","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"ambient_temperature","payload":"15","payloadType":"str","x":150,"y":580,"wires":[["467e804d.9ca35"]]},{"id":"833f64d4.d934c8","type":"debug","z":"dac02106.9590c","name":"To your target_temperature MQTT topic","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","statusVal":"","statusType":"auto","x":1940,"y":180,"wires":[]},{"id":"5b9460e0.b4693","type":"function","z":"dac02106.9590c","name":"Data","func":"if (msg.topic == \"target_temperature\") {\n    global.set(\"nest1_target_temperature\",msg.payload);\n}\nmsg.topic = \"update\";\nvar data = {\n    'ambient_temperature': global.get(\"nest1_ambient_temperature\") || 20,\n    'target_temperature': global.get(\"nest1_target_temperature\") || 20,\n    'hvac_state': global.get(\"nest1_hvac_state\") || 'off',\n    'has_leaf': global.get(\"nest1_has_leaf\") || 'false',\n    'away': global.get(\"nest1_away\") || 'false',\n    'flame': global.get(\"nest1_flame\") || 'none'\n}\nmsg.payload = data;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1290,"y":180,"wires":[["53b0901c.daeb5","8bae5588.4b8328"]]},{"id":"9e3bcada.683d88","type":"function","z":"dac02106.9590c","name":"New setpoint from UI","func":"if (msg.topic == \"target_temperature\") {\n    global.set(\"nest1_target_temperature\",msg.payload.target_temperature);\n    return msg;\n}\n","outputs":1,"noerr":0,"x":1620,"y":180,"wires":[["833f64d4.d934c8"]]},{"id":"72cc416f.5447","type":"inject","z":"dac02106.9590c","name":"Load values on node-red startup and recharge dashboard","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"2","crontab":"","once":true,"onceDelay":"0.5","topic":"","payload":"","payloadType":"date","x":1120,"y":60,"wires":[["5b9460e0.b4693"]]},{"id":"e5aff412.ca6388","type":"change","z":"dac02106.9590c","name":"Actu-Temp-Actual-Interior","rules":[{"t":"set","p":"topic","pt":"msg","to":"Termometro","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"payload.Temperatura","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":730,"y":600,"wires":[["467e804d.9ca35","bbbd394e.f7f828"]]},{"id":"285bd2c.ca01f2e","type":"switch","z":"dac02106.9590c","name":"Interior-Exterior","property":"payload.disp","propertyType":"msg","rules":[{"t":"eq","v":"termo","vt":"str"},{"t":"eq","v":"per2","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":500,"y":620,"wires":[["e5aff412.ca6388"],[]]},{"id":"f4eaec27.8cc22","type":"json","z":"dac02106.9590c","name":"","property":"payload","action":"","pretty":false,"x":330,"y":620,"wires":[["285bd2c.ca01f2e"]]},{"id":"4103236f.970fac","type":"mqtt in","z":"dac02106.9590c","name":"","topic":"${MQTT_Termometro_info}","qos":"2","datatype":"auto","broker":"cc03406e.951f78","nl":false,"rap":false,"x":140,"y":620,"wires":[["f4eaec27.8cc22"]]},{"id":"467e804d.9ca35","type":"link out","z":"dac02106.9590c","name":"","links":["e04888c1.b37818"],"x":1015,"y":580,"wires":[]},{"id":"e04888c1.b37818","type":"link in","z":"dac02106.9590c","name":"","links":["467e804d.9ca35"],"x":895,"y":180,"wires":[["48f9af83.c9bab"]]},{"id":"30058f2f.b8934","type":"subflow:dac02106.9590c","z":"4c31633a.905f9c","name":"","env":[],"x":1030,"y":160,"wires":[["f87c405c.2393a"],["efaefc50.2fa47"]]},{"id":"15dc45f5.b9bc1a","type":"switch","z":"dac02106.9590c","name":"","property":"command","propertyType":"msg","rules":[{"t":"eq","v":"TurnOnRequest","vt":"str"},{"t":"eq","v":"DecrementTargetTemperatureRequest","vt":"str"},{"t":"eq","v":"TurnOffRequest","vt":"str"},{"t":"eq","v":"SetTargetTemperatureRequest","vt":"str"},{"t":"eq","v":"GetTemperatureReadingRequest","vt":"str"},{"t":"eq","v":"IncrementTargetTemperatureRequest","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":150,"y":220,"wires":[["e591746b.7141d8"],[],["d56abc3f.fd245"],["c9cd0514.b21368"],["ede12ef7.685c28"],[]]},{"id":"d56abc3f.fd245","type":"change","z":"dac02106.9590c","name":"Off_Display","rules":[{"t":"set","p":"payload","pt":"msg","to":"off","tot":"str"},{"t":"set","p":"topic","pt":"msg","to":"hvac_state","tot":"str"},{"t":"set","p":"last_change","pt":"global","to":"hvac_state","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":450,"y":120,"wires":[["3e309b7e.594174","1d9c0b93.d98344"]]},{"id":"64b7d170.1c411","type":"mqtt out","z":"dac02106.9590c","name":"MQTT","topic":"${MQTT_Ordenes_Cale}","qos":"1","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"cc03406e.951f78","x":2170,"y":280,"wires":[]},{"id":"785f7ab7.2228e4","type":"inject","z":"4c31633a.905f9c","name":"OFF","props":[{"p":"command","v":"TurnOffRequest","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payloadType":"str","x":830,"y":100,"wires":[["30058f2f.b8934"]]},{"id":"6c4df569.7f474c","type":"inject","z":"4c31633a.905f9c","name":"ON","props":[{"p":"command","v":"TurnOnRequest","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","x":830,"y":40,"wires":[["30058f2f.b8934"]]},{"id":"e591746b.7141d8","type":"change","z":"dac02106.9590c","name":"On_Display","rules":[{"t":"set","p":"payload","pt":"msg","to":"heating","tot":"str"},{"t":"set","p":"topic","pt":"msg","to":"hvac_state","tot":"str"},{"t":"set","p":"last_change","pt":"global","to":"hvac_state","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":450,"y":40,"wires":[["3e309b7e.594174"]]},{"id":"e5717ef9.98c1","type":"change","z":"dac02106.9590c","name":"Temp","rules":[{"t":"set","p":"topic","pt":"msg","to":"target_temperature","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":750,"y":220,"wires":[["25fcda7e.45d3c6"]]},{"id":"8400fe5a.d2f92","type":"ui_slider","z":"dac02106.9590c","d":true,"name":"","label":"Temp","tooltip":"","group":"8a50f58a.83fee8","order":2,"width":"5","height":"1","passthru":true,"outs":"all","topic":"topic","topicType":"msg","min":"18","max":"25","step":"0.5","className":"","x":610,"y":240,"wires":[["e5717ef9.98c1"]]},{"id":"3e309b7e.594174","type":"link out","z":"dac02106.9590c","name":"Cale_Status","links":["4d37f64d.421ea8","f79e47eb.00cba8"],"x":655,"y":60,"wires":[]},{"id":"4d37f64d.421ea8","type":"link in","z":"dac02106.9590c","name":"","links":["3e309b7e.594174","136c5bbf.d5f8d4","e196bad2.48f738"],"x":895,"y":260,"wires":[["f4683732.e68048"]]},{"id":"a9b35f22.75ac4","type":"link in","z":"dac02106.9590c","name":"","links":["46f2d309.82330c","829a277b.dcd058"],"x":1355,"y":340,"wires":[["c6e614d5.fa6338"]]},{"id":"f4962d95.167af","type":"inject","z":"dac02106.9590c","name":"Estado_Temperatura","props":[{"p":"command","v":"TurnOffRequest","vt":"str"},{"p":"payload"}],"repeat":"3","crontab":"","once":false,"onceDelay":"","topic":"","payload":"false","payloadType":"bool","x":140,"y":840,"wires":[["205dac73.687c14"]]},{"id":"205dac73.687c14","type":"function","z":"dac02106.9590c","name":"Paquete MQTT","func":"var values=global.get([\"nest1_hvac_state\",\"nest1_ambient_temperature\",\"nest1_target_temperature\"]);\nvar v1=values[1];\n//msg.payload=values;\n//return [[msg],[msg.payload[0]],Number([msg.payload[1]]),[msg.payload[2]]];\n\nif ((global.get(\"nest1_hvac_state\")) == \"heating\"){\n    \n    if ((Number(global.get(\"nest1_ambient_temperature\"))) >= (Number(global.get(\"nest1_target_temperature\")))){\n        \n        msg.payload=\"Wait\";\n        \n    } else if ((Number(global.get(\"nest1_ambient_temperature\"))) <= (Number(global.get(\"nest1_target_temperature\")-env.get(\"Histeresis\")))){\n        \n            msg.payload=\"Start\";\n    }\n    \n} else {msg.payload=\"Stop\" }\n\nreturn msg;","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":340,"y":840,"wires":[["34a257bd.069bd8"],[]]},{"id":"8752134d.c9afe","type":"comment","z":"dac02106.9590c","name":"Estado de trigger","info":"Sirve para poder comprobar cada x segundos si se ha llegado a la temperatura programada.","x":120,"y":780,"wires":[]},{"id":"efc0ceae.b4ef7","type":"change","z":"dac02106.9590c","name":"Mqtt-Wait","rules":[{"t":"set","p":"nest1_flame","pt":"global","to":"Wait","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"Wait","tot":"str"},{"t":"set","p":"last_change","pt":"global","to":"flame_Wait","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":700,"y":800,"wires":[["51fbf552.28a8bc","c207791e.17bd58"]]},{"id":"34a257bd.069bd8","type":"switch","z":"dac02106.9590c","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Wait","vt":"str"},{"t":"eq","v":"Start","vt":"str"},{"t":"eq","v":"Stop","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":550,"y":840,"wires":[["efc0ceae.b4ef7"],["bc9424ce.194be8"],["3dfddd6c.26c57a"]]},{"id":"bc9424ce.194be8","type":"change","z":"dac02106.9590c","name":"Mqtt-Start","rules":[{"t":"set","p":"nest1_flame","pt":"global","to":"On","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"On","tot":"str"},{"t":"set","p":"last_change","pt":"global","to":"flame_On","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":710,"y":840,"wires":[["51fbf552.28a8bc","c207791e.17bd58"]]},{"id":"829a277b.dcd058","type":"link out","z":"dac02106.9590c","name":"","links":["a9b35f22.75ac4","f79e47eb.00cba8"],"x":995,"y":800,"wires":[]},{"id":"95fb11f9.d1dea","type":"ui_button","z":"dac02106.9590c","name":"","group":"8a50f58a.83fee8","order":5,"width":3,"height":1,"passthru":false,"label":"On","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"","payloadType":"str","topic":"topic","topicType":"msg","x":190,"y":40,"wires":[["e591746b.7141d8"]]},{"id":"f1ff96c0.ba87e8","type":"ui_button","z":"dac02106.9590c","name":"","group":"8a50f58a.83fee8","order":6,"width":3,"height":1,"passthru":false,"label":"Off","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"","payloadType":"str","topic":"topic","topicType":"msg","x":190,"y":80,"wires":[["d56abc3f.fd245"]]},{"id":"c9cd0514.b21368","type":"change","z":"dac02106.9590c","name":"Calefaccion -setTemp","rules":[{"t":"set","p":"extra","pt":"msg","to":"{\"targetTemperature\":{\"value\":24}}","tot":"json"},{"t":"set","p":"extra.targetTemperature.value","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":220,"wires":[["8400fe5a.d2f92","e5717ef9.98c1"]]},{"id":"51fbf552.28a8bc","type":"ui_led","z":"dac02106.9590c","d":true,"order":4,"group":"8a50f58a.83fee8","width":"1","height":"1","label":"","labelPlacement":"left","labelAlignment":"left","colorForValue":[{"color":"#3700ff","value":"Wait","valueType":"str"},{"color":"#ef7d32","value":"On","valueType":"str"},{"color":"#121212","value":"off","valueType":"str"}],"allowColorForValueInMessage":false,"shape":"circle","showGlow":true,"name":"","x":970,"y":880,"wires":[]},{"id":"1d9c0b93.d98344","type":"link out","z":"dac02106.9590c","name":"Led","links":["23155005.974d6"],"x":655,"y":120,"wires":[]},{"id":"23155005.974d6","type":"link in","z":"dac02106.9590c","name":"Led","links":["1d9c0b93.d98344"],"x":815,"y":900,"wires":[["51fbf552.28a8bc"]]},{"id":"dc55e7cf.10e578","type":"function","z":"dac02106.9590c","name":"Mqtt Json","func":"var data = {\n    'ambient': global.get(\"nest1_ambient_temperature\") || 20,\n    'target': global.get(\"nest1_target_temperature\") || 20,\n    'state': global.get(\"nest1_hvac_state\") || 'off',\n    'flame': global.get(\"nest1_flame\") || 'wait'\n    //'has_leaf': global.get(\"nest1_has_leaf\") || 'false',\n    //'away': global.get(\"nest1_away\") || 'false'\n}\nmsg.payload = data;\n\n//msg.payload='{\"trigger\":'+trigger+'\",hola}\"';\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1880,"y":280,"wires":[["64b7d170.1c411","84610015.547f98","d5ad6c25.e998"]]},{"id":"4b0da6b0.841458","type":"delay","z":"dac02106.9590c","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1700,"y":280,"wires":[["dc55e7cf.10e578"]]},{"id":"8bae5588.4b8328","type":"switch","z":"dac02106.9590c","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"update","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1390,"y":280,"wires":[["c6e614d5.fa6338"]]},{"id":"c6e614d5.fa6338","type":"rbe","z":"dac02106.9590c","name":"","func":"rbe","gap":"","start":"","inout":"out","septopics":true,"property":"payload","x":1550,"y":280,"wires":[["4b0da6b0.841458"]]},{"id":"3f0b5b8b.860714","type":"alexa-home","z":"4c31633a.905f9c","conf":"45adb211.c11d1c","device":"100074","acknoledge":false,"name":"calefacción","topic":"","x":230,"y":160,"wires":[["30058f2f.b8934","d845ef.2341ba1"]],"info":"https://alexa-node-red.bm.hardill.me.uk/docs"},{"id":"220eda19.60bd26","type":"alexa-home-resp","z":"dac02106.9590c","x":2220,"y":580,"wires":[]},{"id":"84610015.547f98","type":"json","z":"dac02106.9590c","name":"","property":"payload","action":"obj","pretty":false,"x":1830,"y":580,"wires":[["97008be.4eacdf8"]]},{"id":"97008be.4eacdf8","type":"function","z":"dac02106.9590c","name":"","func":"var backup = msg.payload;\nmsg.payload= \"true\";\nmsg.extra = {targetTemperature: { value: backup.target}};\n\nmsg.extra = {\n        targetTemperature: {\n            value: backup.target\n        },\n        applianceResponseTimestamp: new Date().toISOString(),\n        temperatureMode: {\n            value: \"AUTO\"\n        }\n    };\n    msg.payload = true;\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2000,"y":580,"wires":[["220eda19.60bd26"]]},{"id":"ede12ef7.685c28","type":"function","z":"dac02106.9590c","name":"Temperatura de casa","func":"msg.payload=global.get(\"nest1_ambient_temperature\");\n\n msg.extra = {\n        temperatureReading: {\n        value: msg.payload\n    },\n    temperatureMode: {\n        value: \"AUTO\"\n    }\n    };\n    msg.payload = true;\n\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":300,"wires":[["696f99f7.c28a78"]]},{"id":"696f99f7.c28a78","type":"link out","z":"dac02106.9590c","name":"","links":["e6a8b1d4.1e8d2"],"x":575,"y":300,"wires":[]},{"id":"e6a8b1d4.1e8d2","type":"link in","z":"dac02106.9590c","name":"","links":["696f99f7.c28a78"],"x":2035,"y":660,"wires":[["220eda19.60bd26"]]},{"id":"5a31ea62.9084c4","type":"inject","z":"dac02106.9590c","name":"","props":[{"p":"payload","v":"cooling","vt":"str"},{"p":"topic","v":"hvac_state","vt":"string"}],"repeat":"","crontab":"","once":false,"topic":"hvac_state","payload":"cooling","payloadType":"str","x":290,"y":380,"wires":[[]]},{"id":"c207791e.17bd58","type":"rbe","z":"dac02106.9590c","name":"","func":"rbe","gap":"","start":"","inout":"out","septopics":true,"property":"payload","x":890,"y":800,"wires":[["829a277b.dcd058"]]},{"id":"bbbd394e.f7f828","type":"switch","z":"dac02106.9590c","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"nan","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":910,"y":680,"wires":[["2c465d7.a947da2"]]},{"id":"14334e3d.14a182","type":"mqtt out","z":"dac02106.9590c","name":"MQTT","topic":"${MQTT_Ordenes_Termo}","qos":"1","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"cc03406e.951f78","x":1270,"y":640,"wires":[]},{"id":"2c465d7.a947da2","type":"change","z":"dac02106.9590c","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"dhtRestart\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":680,"wires":[["14334e3d.14a182","5404e555.4c1e6c"]]},{"id":"5404e555.4c1e6c","type":"change","z":"dac02106.9590c","name":"Off_Display","rules":[{"t":"set","p":"payload","pt":"msg","to":"off","tot":"str"},{"t":"set","p":"topic","pt":"msg","to":"hvac_state","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1290,"y":720,"wires":[["e196bad2.48f738"]]},{"id":"e196bad2.48f738","type":"link out","z":"dac02106.9590c","name":"","links":["4d37f64d.421ea8"],"x":1415,"y":720,"wires":[]},{"id":"c8348153.ca3fd","type":"comment","z":"dac02106.9590c","name":"Reinicio de Sonda y mandar off a calefacción","info":"Si detecto que la temperatura es NAN significa que no se está leyendo nada del termometro.","x":1230,"y":600,"wires":[]},{"id":"de3a0004.dbf858","type":"ssh-client","z":"ccc70095.e8d18","debug":false,"ssh":"","hostname":"192.168.3.181","name":"Reinicio RPI","x":570,"y":1380,"wires":[["e74f8625.45ea68"]]},{"id":"76e739de.f2ed8","type":"function","z":"ccc70095.e8d18","name":"Sudo Shutdown -r","func":"msg.payload = \"sudo /sbin/shutdown -r now\";\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":1380,"wires":[["de3a0004.dbf858"]]},{"id":"896f5d84.7e0c1","type":"inject","z":"ccc70095.e8d18","name":"","props":[{"p":"payload","v":"","vt":"date"},{"p":"topic","v":"","vt":"string"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":120,"y":1380,"wires":[["76e739de.f2ed8"]]},{"id":"e74f8625.45ea68","type":"debug","z":"ccc70095.e8d18","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":790,"y":1380,"wires":[]},{"id":"62f42e52.0afc3","type":"ui_button","z":"ccc70095.e8d18","name":"","group":"47562201.21775c","order":1,"width":"3","height":"1","passthru":false,"label":"Reinicio RPI","tooltip":"","color":"","bgcolor":"","className":"","icon":"fa-power-off","payload":"","payloadType":"str","topic":"topic","topicType":"msg","x":110,"y":1440,"wires":[["76e739de.f2ed8"]]},{"id":"3c6c6dd9.269582","type":"alexa-home","z":"ccc70095.e8d18","conf":"45adb211.c11d1c","device":"117695","acknoledge":true,"name":"tiesto","topic":"","x":90,"y":1500,"wires":[["76e739de.f2ed8"]],"info":"https://alexa-node-red.bm.hardill.me.uk/devices"},{"id":"a299f9ee.221638","type":"mysql","z":"4c31633a.905f9c","d":true,"mydb":"4cab9f17.1e3dc","name":"","x":1390,"y":180,"wires":[[]]},{"id":"eb3cab85.579e48","type":"rbe","z":"dac02106.9590c","name":"","func":"rbe","gap":"","start":"","inout":"out","septopics":true,"property":"payload","x":910,"y":1040,"wires":[[]]},{"id":"e5a7c624.fd57d8","type":"function","z":"dac02106.9590c","name":"Mqtt Json","func":"if(global.get(\"last_change\") == 'ambient_temperature'){\n    msg.command = \"Drop\";\n    var data = {\n    'ambient': global.get(\"nest1_ambient_temperature\") || 20\n}\n    \n} else {\n    msg.command = \"SQL_update\";\n   var data = {\n    'ambient': global.get(\"nest1_ambient_temperature\") || 20,\n    'target': global.get(\"nest1_target_temperature\") || 20,\n    'state': global.get(\"nest1_hvac_state\") || 'off',\n    'flame': global.get(\"nest1_flame\") || 'wait'\n    //'has_leaf': global.get(\"nest1_has_leaf\") || 'false',\n    //'away': global.get(\"nest1_away\") || 'false'\n}\n\n\n}\nmsg.payload = data;\nreturn msg;\n\n\n//msg.payload='{\"trigger\":'+trigger+'\",hola}\"';\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":1060,"wires":[["6d269e4b.8bf0a"]]},{"id":"efaefc50.2fa47","type":"template","z":"4c31633a.905f9c","name":"insert","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `control`( `ambient`,`target`,`state`,`flame`) VALUES ('{{payload.ambient}}','{{payload.target}}','{{payload.state}}','{{payload.flame}}');\n","output":"str","x":1210,"y":180,"wires":[["a299f9ee.221638"]]},{"id":"6d269e4b.8bf0a","type":"switch","z":"dac02106.9590c","name":"Ignorar subidas de temperatura","property":"command","propertyType":"msg","rules":[{"t":"eq","v":"SQL_update","vt":"str"},{"t":"eq","v":"Drop","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":630,"y":1060,"wires":[["eb3cab85.579e48"],[]]},{"id":"3dfddd6c.26c57a","type":"change","z":"dac02106.9590c","name":"Flame-Off","rules":[{"t":"set","p":"nest1_flame","pt":"global","to":"Off","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":700,"y":880,"wires":[[]]},{"id":"7de0a13a.ac6b8","type":"function","z":"ccc70095.e8d18","name":"","func":"msg.payload = {\"torrent\":\"off\"}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":1060,"wires":[["ebb2386f.a5bad8"]]},{"id":"209f5ebd.3bdac2","type":"mytimeout","z":"ccc70095.e8d18","name":"","outtopic":"","outsafe":"","outwarning":"","outunsafe":"false","warning":"","timer":"50","debug":false,"ndebug":false,"ignoreCase":false,"repeat":false,"again":false,"x":270,"y":1060,"wires":[["12c88c55.fcaebc","7de0a13a.ac6b8"],[]]},{"id":"51afb6ab.1768b","type":"inject","z":"ccc70095.e8d18","name":"Inicial","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":110,"y":1100,"wires":[["209f5ebd.3bdac2"]]},{"id":"c04833e1.60b86","type":"switch","z":"ccc70095.e8d18","name":"","property":"payload.torrent","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":430,"y":1160,"wires":[["209f5ebd.3bdac2"]]},{"id":"b8a27d94.1df06","type":"debug","z":"4c31633a.905f9c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1070,"y":600,"wires":[]},{"id":"f79e47eb.00cba8","type":"link in","z":"dac02106.9590c","name":"","links":["829a277b.dcd058","3e309b7e.594174"],"x":255,"y":1060,"wires":[["e5a7c624.fd57d8"]]},{"id":"b42cdd75.9fbb2","type":"inject","z":"4c31633a.905f9c","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":270,"y":600,"wires":[["f74db5aa.ac037"]]},{"id":"40bf0d1e.69203c","type":"inject","z":"4c31633a.905f9c","name":"Pulso de inicio ","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":"1","topic":"","payload":"Start","payloadType":"str","x":260,"y":360,"wires":[["f7562177.16cf5"]]},{"id":"f74db5aa.ac037","type":"template","z":"4c31633a.905f9c","name":"insert","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT * FROM `control`;","output":"str","x":450,"y":600,"wires":[["b6b280dc.ce7dd"]]},{"id":"b6b280dc.ce7dd","type":"mysql","z":"4c31633a.905f9c","mydb":"4cab9f17.1e3dc","name":"","x":650,"y":600,"wires":[["f9423780.204df"]]},{"id":"73fcb0d5.7cdba","type":"function","z":"4c31633a.905f9c","name":"","func":"\nvar fecha = msg.payload.fecha\nvar state = msg.payload.state\nvar flame = msg.payload.flame\n\nif (state != \"off\"){\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":920,"y":600,"wires":[["b8a27d94.1df06"]]},{"id":"f9423780.204df","type":"split","z":"4c31633a.905f9c","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":790,"y":600,"wires":[["73fcb0d5.7cdba"]]},{"id":"5dfe8b7e.2392a4","type":"mqtt in","z":"4c31633a.905f9c","name":"","topic":"persia/termo2/voltage","qos":"2","datatype":"auto","broker":"cc03406e.951f78","nl":false,"rap":false,"rh":"0","x":260,"y":260,"wires":[["d0222129.f0cff","f7562177.16cf5","a36c040f.ea1a48"]]},{"id":"d0222129.f0cff","type":"ui_artlessgauge","z":"4c31633a.905f9c","group":"80677e24.b1fa78","order":8,"width":"3","height":"1","name":"","icon":"","label":"Bateria","unit":"","layout":"linear","decimals":"2","differential":false,"minmax":false,"colorTrack":"#555555","style":"","colorFromTheme":true,"property":"payload","secondary":"secondary","inline":false,"animate":true,"sectors":[{"val":3.2,"col":"#ff2600","t":"min","dot":0},{"val":3.3,"col":"#f40b0b","t":"sec","dot":0},{"val":3.5,"col":"#f0900a","t":"sec","dot":0},{"val":3.7,"col":"#3d9900","t":"sec","dot":0},{"val":4,"col":"#3d9900","t":"max","dot":0}],"lineWidth":3,"bgcolorFromTheme":true,"diffCenter":"","x":1040,"y":260,"wires":[]},{"id":"f7562177.16cf5","type":"mytimeout","z":"4c31633a.905f9c","name":"","outtopic":"","outsafe":"","outwarning":"","outunsafe":"out","warning":"","timer":"910","debug":false,"ndebug":false,"ignoreCase":false,"repeat":false,"again":false,"x":510,"y":340,"wires":[["8663abba.5ddce8","7c8a9818.f287b"],[]]},{"id":"8663abba.5ddce8","type":"function","z":"4c31633a.905f9c","name":"Seguro de termometro","func":"msg.command = \"TurnOffRequest\";\nmsg.payload = 0;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":800,"y":340,"wires":[["30058f2f.b8934","d0222129.f0cff"]]},{"id":"c2d328a5.fc927","type":"comment","z":"4c31633a.905f9c","name":"Rescatar de DB","info":"","x":100,"y":560,"wires":[]},{"id":"f7bcdb40.d45a4","type":"comment","z":"4c31633a.905f9c","name":"Protecccion termo sin bateria","info":"","x":620,"y":300,"wires":[]},{"id":"89e40b9c.c361f8","type":"mytimeout","z":"4c31633a.905f9c","name":"","outtopic":"","outsafe":"","outwarning":"","outunsafe":"wait","warning":"","timer":"5","debug":false,"ndebug":false,"ignoreCase":false,"repeat":false,"again":false,"x":690,"y":400,"wires":[["7c8a9818.f287b"],[]]},{"id":"a36c040f.ea1a48","type":"function","z":"4c31633a.905f9c","name":"","func":"msg.payload = true\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":440,"wires":[["89e40b9c.c361f8","7c8a9818.f287b"]]},{"id":"f152f9bf.9d1f68","type":"inject","z":"4c31633a.905f9c","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":240,"y":440,"wires":[["a36c040f.ea1a48"]]},{"id":"7c8a9818.f287b","type":"ui_led","z":"4c31633a.905f9c","order":9,"group":"80677e24.b1fa78","width":"3","height":"1","label":"DHT22","labelPlacement":"left","labelAlignment":"left","colorForValue":[{"color":"#008000","value":"true","valueType":"bool"},{"color":"#ffaa00","value":"wait","valueType":"str"},{"color":"#ff2600","value":"out","valueType":"str"}],"allowColorForValueInMessage":false,"shape":"circle","showGlow":true,"name":"","x":870,"y":440,"wires":[]},{"id":"51d19b8b.c9e43c","type":"inject","z":"4c31633a.905f9c","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"out","payloadType":"str","x":690,"y":500,"wires":[["7c8a9818.f287b"]]},{"id":"9311df98.f299d","type":"ui_slider","z":"4c31633a.905f9c","d":true,"name":"","label":"slider","tooltip":"","group":"80677e24.b1fa78","order":10,"width":0,"height":0,"passthru":true,"outs":"all","topic":"topic","topicType":"msg","min":"3","max":"4","step":"0.05","className":"","x":1010,"y":440,"wires":[["d0222129.f0cff"]]},{"id":"d845ef.2341ba1","type":"debug","z":"4c31633a.905f9c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":450,"y":200,"wires":[]},{"id":"1196a7eb.874f08","type":"mqtt in","z":"4c31633a.905f9c","name":"","topic":"persia/temp","qos":"2","datatype":"auto","broker":"cc03406e.951f78","nl":false,"rap":false,"rh":"0","x":250,"y":760,"wires":[["af303eb0.d8b0a"]]},{"id":"af303eb0.d8b0a","type":"json","z":"4c31633a.905f9c","name":"","property":"payload","action":"","pretty":false,"x":450,"y":760,"wires":[["d240ce98.0214a","60e176d9.8f1cd8"]]},{"id":"d240ce98.0214a","type":"change","z":"4c31633a.905f9c","name":"Actu-Temp-Actual-Interior","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.Humedad","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":650,"y":760,"wires":[["b6daf29d.38d5c","b4c3b3a6.e7713"]]},{"id":"b6daf29d.38d5c","type":"debug","z":"4c31633a.905f9c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":890,"y":700,"wires":[]},{"id":"b4c3b3a6.e7713","type":"ui_text","z":"4c31633a.905f9c","group":"80677e24.b1fa78","order":2,"width":"3","height":"1","name":"","label":"Hum","format":"{{msg.payload}}","layout":"row-left","className":"","x":870,"y":760,"wires":[]},{"id":"979c582b.99ab38","type":"ui_text","z":"4c31633a.905f9c","group":"80677e24.b1fa78","order":1,"width":"3","height":"1","name":"","label":"Temp","format":"{{msg.payload}}","layout":"row-left","className":"","x":870,"y":820,"wires":[]},{"id":"60e176d9.8f1cd8","type":"change","z":"4c31633a.905f9c","name":"Actu-Temp-Actual-Interior","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.Temperatura","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":650,"y":820,"wires":[["979c582b.99ab38"]]},{"id":"7fc9f08.8328d1","type":"ui_template","z":"4c31633a.905f9c","group":"dc53cc09.4e298","name":"dashboard CSS","order":1,"width":0,"height":0,"format":"<style id=\"blue-dashboard\">\n\nbody.nr-dashboard-theme {\n    background: radial-gradient(circle, rgb(45 97 186) 0%, rgb(16 16 146) 40%, rgba(2,0,36,1) 100%);\n}\nbody.nr-dashboard-theme md-toolbar {\n   background: radial-gradient(circle, rgb(45 97 186) 0%, rgb(16 16 146) 40%, rgba(2,0,36,1) 100%);\n    color: #fff;\n}\nbody.nr-dashboard-theme md-sidenav {\n    color: rgb(215 223 245);\n    background: radial-gradient(circle, rgb(45 97 186) 0%, rgb(16 16 146) 40%, rgba(2,0,36,1) 100%);\n}\nbody.nr-dashboard-theme md-sidenav div.md-list-item-inner {\n    color: rgb(215 223 245);\n    background-color: transparent;\n}\n.nr-dashboard-theme ui-card-panel {\n    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);\n    border: none;\n    border-radius: 1em;\n    box-shadow: 0 0 1em 0em rgb(0 0 100 / 50%)\n}\nbody.nr-dashboard-theme md-content md-card {\n    background:transparent;\n    color: rgb(215 223 245);\n}\n.nr-dashboard-theme .nr-dashboard-template {\n    background:transparent;\n}\n.nr-dashboard-theme ui-card-panel p.nr-dashboard-cardtitle {\n    color: #6a99f1;\n    text-shadow: 1px 1px 0px rgb(0 0 0 / 50%);\n}\n.md-button{\n    border-radius:0.6em;\n    color:rgb(215 223 245);\n}\n.nr-dashboard-theme .nr-dashboard-button .md-button {\n    background-color: #053ea8;\n    color:rgb(215 223 245);\n}\n.nr-dashboard-theme .nr-dashboard-button .md-button:hover {\n    background-color: #0646bd;\n}\n.nr-dashboard-theme .nr-dashboard-button .md-button:focus {\n    background-color: #0646bd;\n}\n.nr-dashboard-theme .nr-dashboard-numeric .value {\n    background:unset;\n    color:rgb(215 223 245);\n}\n.nr-dashboard-theme .nr-dashboard-form {\n    color:rgb(215 223 245);\n}\n.nr-dashboard-theme .nr-dashboard-form-button {\n    background-color: #053ea8;\n    color:rgb(215 223 245);\n}\n\n.nr-dashboard-theme .nr-dashboard-form-button:hover {\n    background-color: #0646bd !important;\n}\n.nr-dashboard-theme .nr-dashboard-form-button:focus {\n    background-color: #0646bd !important;\n}\n.nr-dashboard-theme md-input-container.md-default-theme .md-input, md-input-container .md-input {\n     color:rgb(215 223 245);\n    border-color: #074fd4 !important;\n}\n.nr-dashboard-theme .nr-dashboard-switch md-switch .md-thumb {\n    background-color: rgb(25 31 153);\n}\n.nr-dashboard-theme .nr-dashboard-switch md-switch .md-bar {\n    background-color: rgb(94 94 177);\n    box-shadow: inset 0 0 1px #0000005e;\n}\n.nr-dashboard-theme .nr-dashboard-switch md-switch.md-checked .md-bar {\n    background-color: rgb(94 94 177);\n     box-shadow: 0 0 10px 0px #101086;\n}\n.nr-dashboard-theme .nr-dashboard-switch md-switch.md-checked .md-thumb {\n    background-color: rgb(61 107 232);\n    box-shadow: 0 0 10px 0px #101086;\n}\n.nr-dashboard-theme .nr-dashboard-slider .md-track {\n    background-color: rgb(125 172 249 / 35%);\n}\nmd-slider .md-thumb {\n    box-shadow: 0 0 10px 0px #101086;\n}\n\n.nr-dashboard-theme .nr-dashboard-slider .md-thumb:after {\n    background-color: #3d6be8;\n    border-color: #3d6be8;\n}\n\n.nr-dashboard-theme md-select-menu, .nr-dashboard-theme md-select-menu md-option {\n    background-color: rgb(0 0 0 / 12%);\n    color:rgb(215 223 245);\n    border-radius:0.8em;\n}\n\n.nr-dashboard-theme .nr-dashboard-dropdown md-select .md-select-value, .nr-dashboard-theme .nr-dashboard-dropdown md-select .md-select-value.md-select-placeholder {\n    margin-top: -3px;\n    border-color: #eeeeee7a;\n    \n}\n.nr-dashboard-theme .md-select-menu-container {\n    max-height: 85%;\n    overflow-y: auto;\n    border: none;\n    border-radius: 0.8em;\n}\n.nr-dashboard-theme .nr-dashboard-dropdown .md-select-icon {\n\n}\n.nr-dashboard-theme md-select-menu md-option {\n    background-color: rgb(40 53 147);\n   \n    height: 29px;\n    border-radius: 0.6em;\n    margin-left: 10px;\n    margin-right: 10px;\n    margin-top: 2px;\n    box-shadow: 0 0 6px 6px #24202133;\n    transition: 0.3s;\n}\n.nr-dashboard-theme md-select-menu md-option[selected] {\n    color: rgb(130 177 255) !important;\n    background-color: rgb(27 90 197) !important;\n}\n.nr-dashboard-theme md-select-menu md-option:nth-child(even) {\n    background-color: rgb(31 31 152);\n}\n.nr-dashboard-theme md-select-menu md-option:last-child {\n   margin-bottom: 8px;\n}\n.nr-dashboard-theme md-select-menu md-option:hover {\n    background-color: rgb(20 91 211) !important;\n    padding-left: 26px;\n}\n.nr-dashboard-theme md-select-menu md-option > .md-ripple-container{\n     border-radius: 14px;\n}\n\n</style>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"global","x":120,"y":40,"wires":[[]]},{"id":"f96b06c2.ba3d38","type":"mqtt out","z":"4c31633a.905f9c","name":"MQTT - Retain payload","topic":"","qos":"2","retain":"true","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"cc03406e.951f78","x":570,"y":1060,"wires":[]},{"id":"48f2f0a.6c7f01","type":"ui_button","z":"4c31633a.905f9c","name":"","group":"24ec8664.0046ea","order":4,"width":"3","height":"1","passthru":false,"label":"3,3 min","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"{\"time\": \"2e8\"}","payloadType":"str","topic":"persia/termo2/time","topicType":"str","x":240,"y":1040,"wires":[["f96b06c2.ba3d38"]]},{"id":"a3627761.c31a28","type":"comment","z":"4c31633a.905f9c","name":"boton para cambio de tiempo espera termometro movil (microsegundos)","info":"https://fontawesome.com","x":290,"y":920,"wires":[]},{"id":"1bb27e4c.565222","type":"ui_button","z":"4c31633a.905f9c","name":"","group":"24ec8664.0046ea","order":5,"width":"3","height":"1","passthru":false,"label":"5 min","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"{\"time\": \"3e8\"}","payloadType":"str","topic":"persia/termo2/time","topicType":"str","x":250,"y":1100,"wires":[["f96b06c2.ba3d38"]]},{"id":"52c9e21e.072fcc","type":"ui_button","z":"4c31633a.905f9c","name":"","group":"24ec8664.0046ea","order":6,"width":"3","height":"1","passthru":false,"label":"6,6 min","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"{\"time\": \"4e8\"}","payloadType":"str","topic":"persia/termo2/time","topicType":"str","x":240,"y":1160,"wires":[["f96b06c2.ba3d38"]]},{"id":"ecb3ae28.184a8","type":"ui_button","z":"4c31633a.905f9c","name":"","group":"24ec8664.0046ea","order":3,"width":"3","height":"1","passthru":false,"label":"15 min","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"{\"time\": \"9e8\"}","payloadType":"str","topic":"persia/termo2/time","topicType":"str","x":240,"y":980,"wires":[["f96b06c2.ba3d38"]]},{"id":"23aaacfc.32ca04","type":"mqtt in","z":"9fe9cc56.678888","name":"","topic":"persia/log","qos":"2","datatype":"auto","broker":"cc03406e.951f78","nl":false,"rap":false,"x":140,"y":440,"wires":[["8bdecd73.74552"]]},{"id":"5e3582e7.42685c","type":"json","z":"9fe9cc56.678888","name":"","property":"payload","action":"","pretty":false,"x":490,"y":440,"wires":[["1d2d2333.12e03d","bed1cb5b.d67f18"]]},{"id":"da00e54f.65ea28","type":"ui_toast","z":"9fe9cc56.678888","position":"bottom right","displayTime":"4","highlight":"","sendall":true,"outputs":0,"ok":"OK","cancel":"","raw":false,"className":"","topic":"","name":"","x":1230,"y":400,"wires":[]},{"id":"1d2d2333.12e03d","type":"switch","z":"9fe9cc56.678888","name":"pop-up connecting","property":"payload.staus","propertyType":"msg","rules":[{"t":"eq","v":"connecting","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":710,"y":400,"wires":[["e364993.29a2a68"]]},{"id":"e364993.29a2a68","type":"json","z":"9fe9cc56.678888","name":"","property":"payload","action":"str","pretty":false,"x":910,"y":400,"wires":[["da00e54f.65ea28"]]},{"id":"bed1cb5b.d67f18","type":"switch","z":"9fe9cc56.678888","name":"pop-up alive","property":"payload.staus","propertyType":"msg","rules":[{"t":"eq","v":"alive","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":690,"y":460,"wires":[["f552c28b.74dd7"]]},{"id":"f552c28b.74dd7","type":"json","z":"9fe9cc56.678888","name":"","property":"payload","action":"str","pretty":false,"x":910,"y":460,"wires":[["c70c0f19.573a5"]]},{"id":"c70c0f19.573a5","type":"ui_toast","z":"9fe9cc56.678888","position":"bottom right","displayTime":"4","highlight":"","sendall":true,"outputs":0,"ok":"OK","cancel":"","raw":false,"topic":"","name":"","x":1230,"y":460,"wires":[]},{"id":"8bdecd73.74552","type":"delay","z":"9fe9cc56.678888","name":"","pauseType":"rate","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"2","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":320,"y":440,"wires":[["5e3582e7.42685c"]]},{"id":"c08e9d6d.f77bb","type":"ui_switch","z":"f996f74a.c8c748","name":"Select_Kilian","label":"","tooltip":"","group":"6f32de3d.bc927","order":2,"width":"2","height":"1","passthru":false,"decouple":"true","topic":"topic","topicType":"msg","style":"","onvalue":"kilion","onvalueType":"str","onicon":"fa-child fa-2x","oncolor":"green","offvalue":"kilioff","offvalueType":"str","officon":"fa-child fa-2x","offcolor":"red","animate":false,"className":"","x":810,"y":560,"wires":[["b881584c.aecc38"]]},{"id":"54b31e01.67ed7","type":"ui_switch","z":"f996f74a.c8c748","name":"Select_Habitacion","label":"","tooltip":"","group":"6f32de3d.bc927","order":3,"width":"2","height":"1","passthru":false,"decouple":"true","topic":"topic","topicType":"msg","style":"","onvalue":"papeson","onvalueType":"str","onicon":"fa-bed fa-2x","oncolor":"green","offvalue":"papesoff","offvalueType":"str","officon":"fa-bed fa-2x","offcolor":"red","animate":false,"className":"","x":790,"y":720,"wires":[["b881584c.aecc38"]]},{"id":"ac40e671.4e1d38","type":"change","z":"f996f74a.c8c748","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"kilioff","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":560,"wires":[["c08e9d6d.f77bb"]]},{"id":"71d5af12.da80b","type":"change","z":"f996f74a.c8c748","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"papesoff","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":720,"wires":[["54b31e01.67ed7"]]},{"id":"6ff9bb65.693fe4","type":"switch","z":"f996f74a.c8c748","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"kilion","vt":"str"},{"t":"eq","v":"papeson","vt":"str"},{"t":"eq","v":"comeon","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":190,"y":400,"wires":[["71d5af12.da80b","9bf2edd3.a1e61","a8406f46.e115a","e08858b.a4377a8"],["ac40e671.4e1d38","237081df.ef1abe","b58eb569.a65048","7840ac98.d8a924"],["570b4ff7.2c4b9","25677788.418d88","a393b189.3c707","64e21e53.aa3a"]]},{"id":"892dc52e.7a8ed8","type":"ui_switch","z":"f996f74a.c8c748","name":"Select_Tele","label":"","tooltip":"","group":"6f32de3d.bc927","order":1,"width":"2","height":"1","passthru":false,"decouple":"true","topic":"topic","topicType":"msg","style":"","onvalue":"comeon","onvalueType":"str","onicon":"fa-television fa-2x","oncolor":"green","offvalue":"comeoff","offvalueType":"str","officon":"fa-television fa-2x","offcolor":"red","animate":false,"className":"","x":810,"y":400,"wires":[["b881584c.aecc38"]]},{"id":"25677788.418d88","type":"change","z":"f996f74a.c8c748","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"kilioff","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":600,"wires":[["c08e9d6d.f77bb"]]},{"id":"570b4ff7.2c4b9","type":"change","z":"f996f74a.c8c748","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"papesoff","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":760,"wires":[["54b31e01.67ed7"]]},{"id":"9bf2edd3.a1e61","type":"change","z":"f996f74a.c8c748","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"comeoff","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":440,"wires":[["892dc52e.7a8ed8"]]},{"id":"237081df.ef1abe","type":"change","z":"f996f74a.c8c748","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"comeoff","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":400,"wires":[["892dc52e.7a8ed8"]]},{"id":"bcf45561.3164a8","type":"ui_button","z":"f996f74a.c8c748","name":"Subir_persiana","group":"6f32de3d.bc927","order":4,"width":"2","height":1,"passthru":false,"label":"","tooltip":"","color":"","bgcolor":"","className":"","icon":"fa-arrow-up fa-2x","payload":"{\"order\":\"up\"}","payloadType":"json","topic":"${persiana}","topicType":"str","x":120,"y":860,"wires":[["6ec65b48.4951e4","7401f8bf.3ac528"]]},{"id":"65acc34.c5e073c","type":"ui_button","z":"f996f74a.c8c748","name":"Bajar_persiana","group":"6f32de3d.bc927","order":6,"width":"2","height":1,"passthru":false,"label":"","tooltip":"","color":"","bgcolor":"","className":"","icon":"fa-arrow-down fa-2x","payload":"{\"order\":\"down\"}","payloadType":"json","topic":"${persiana}","topicType":"str","x":120,"y":940,"wires":[["6ec65b48.4951e4","7401f8bf.3ac528"]]},{"id":"38e0f8ce.4d5f18","type":"ui_button","z":"f996f74a.c8c748","name":"Parar_persiana","group":"6f32de3d.bc927","order":5,"width":"2","height":1,"passthru":false,"label":"","tooltip":"","color":"","bgcolor":"","className":"","icon":"fa-stop fa-2x","payload":"{\"order\":\"stop\"}","payloadType":"json","topic":"${persiana}","topicType":"str","x":120,"y":900,"wires":[["7401f8bf.3ac528","6ec65b48.4951e4"]]},{"id":"a393b189.3c707","type":"change","z":"f996f74a.c8c748","name":"","rules":[{"t":"set","p":"persiana","pt":"global","to":"persia/per1/order","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":450,"y":40,"wires":[[]]},{"id":"a8406f46.e115a","type":"change","z":"f996f74a.c8c748","name":"","rules":[{"t":"set","p":"persiana","pt":"global","to":"persia/per2/order","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":470,"y":80,"wires":[[]]},{"id":"b58eb569.a65048","type":"change","z":"f996f74a.c8c748","name":"","rules":[{"t":"set","p":"persiana","pt":"global","to":"persia/per3/order","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":490,"y":120,"wires":[[]]},{"id":"a44c1852.871e18","type":"mqtt out","z":"f996f74a.c8c748","name":"MQTT - Retain payload","topic":"","qos":"2","retain":"false","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"cc03406e.951f78","x":1050,"y":900,"wires":[]},{"id":"6ec65b48.4951e4","type":"function","z":"f996f74a.c8c748","name":"","func":"msg.topic= global.get(\"persiana\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":620,"y":900,"wires":[["a44c1852.871e18"]]},{"id":"7401f8bf.3ac528","type":"timeouttrigger","z":"f996f74a.c8c748","ontimeouttype":"str","ontimeoutval":"{\"order\":\"stop\"}","duration":"70","units":"s","name":"","x":330,"y":1000,"wires":[["3cb78c10.d278f4"]]},{"id":"5a2678d6.2b5118","type":"json","z":"f996f74a.c8c748","name":"","property":"payload","action":"obj","pretty":false,"x":590,"y":1000,"wires":[["217a6576.3c6dfa","3865fddd.758302","89a3a860.14ca68"]]},{"id":"b881584c.aecc38","type":"link out","z":"f996f74a.c8c748","name":"","links":["585cc938.069988"],"x":975,"y":560,"wires":[]},{"id":"585cc938.069988","type":"link in","z":"f996f74a.c8c748","name":"","links":["b881584c.aecc38"],"x":75,"y":400,"wires":[["6ff9bb65.693fe4"]]},{"id":"d7ff5b18.669618","type":"link in","z":"f996f74a.c8c748","name":"","links":["e08858b.a4377a8"],"x":615,"y":500,"wires":[["c08e9d6d.f77bb"]]},{"id":"e08858b.a4377a8","type":"link out","z":"f996f74a.c8c748","name":"","links":["d7ff5b18.669618"],"x":415,"y":260,"wires":[]},{"id":"bb75fc99.1b226","type":"link in","z":"f996f74a.c8c748","name":"","links":["7840ac98.d8a924"],"x":605,"y":680,"wires":[["54b31e01.67ed7"]]},{"id":"7840ac98.d8a924","type":"link out","z":"f996f74a.c8c748","name":"","links":["bb75fc99.1b226"],"x":415,"y":300,"wires":[]},{"id":"54cd8d02.e834c4","type":"link in","z":"f996f74a.c8c748","name":"","links":["64e21e53.aa3a"],"x":615,"y":340,"wires":[["892dc52e.7a8ed8"]]},{"id":"64e21e53.aa3a","type":"link out","z":"f996f74a.c8c748","name":"","links":["54cd8d02.e834c4"],"x":415,"y":220,"wires":[]},{"id":"b9aa0f0b.71767","type":"ui_text","z":"4c31633a.905f9c","group":"24ec8664.0046ea","order":7,"width":"6","height":"1","name":"","label":"Config Time in minutes:","format":"{{msg.payload}}","layout":"row-spread","className":"","x":810,"y":1260,"wires":[]},{"id":"d9fa3e6f.81a24","type":"mqtt in","z":"4c31633a.905f9c","name":"","topic":"persia/termo2/time","qos":"2","datatype":"auto","broker":"cc03406e.951f78","nl":false,"rap":false,"rh":"0","x":270,"y":1260,"wires":[["6569c01b.f08468"]]},{"id":"d00c5f1.9653aa","type":"debug","z":"f0ddc17c.4ba93","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":840,"y":780,"wires":[]},{"id":"ee58a85f.f38428","type":"inject","z":"f0ddc17c.4ba93","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"manual","payload":"up","payloadType":"str","x":100,"y":800,"wires":[["1ae0058a.18ba6a","1266d002.07163"]]},{"id":"597ca53e.8049dc","type":"inject","z":"f0ddc17c.4ba93","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"manual","payload":"down","payloadType":"str","x":110,"y":880,"wires":[["1ae0058a.18ba6a","1266d002.07163"]]},{"id":"e4e53ee8.2ae59","type":"inject","z":"f0ddc17c.4ba93","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"manual","payload":"stop","payloadType":"str","x":110,"y":840,"wires":[["1ae0058a.18ba6a","1266d002.07163"]]},{"id":"e688613.4a143a","type":"debug","z":"f0ddc17c.4ba93","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":840,"y":820,"wires":[]},{"id":"da1b10e9.26bd1","type":"debug","z":"f0ddc17c.4ba93","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":840,"y":740,"wires":[]},{"id":"7e9ed2b3.e9db8c","type":"debug","z":"f0ddc17c.4ba93","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":830,"y":860,"wires":[]},{"id":"1ae0058a.18ba6a","type":"subflow:fa9b3c4d.e0031","z":"f0ddc17c.4ba93","name":"","env":[{"name":"move_time","value":"24","type":"num"},{"name":"MQTT_Topic","value":"persia/per5/order","type":"str"},{"name":"up_whit_correction","value":"18","type":"num"},{"name":"down_whit_correction","value":"28","type":"str"}],"x":480,"y":800,"wires":[["80fa2de2.e903f"],["da1b10e9.26bd1"],[],[],["d00c5f1.9653aa"],["e688613.4a143a"],[]]},{"id":"3b7dae97.ced772","type":"range","z":"fa9b3c4d.e0031","minin":"0","maxin":"${move_time}","minout":"0","maxout":"100","action":"scale","round":false,"property":"payload","name":"conversor tiempo","x":1930,"y":440,"wires":[["4a2e155.230b1ec"]]},{"id":"3a788793.62a438","type":"comment","z":"ccc70095.e8d18","name":"Estado Pc estudio","info":"","x":130,"y":1180,"wires":[]},{"id":"d53484ac.38c98","type":"comment","z":"ccc70095.e8d18","name":"Reinicio RPI","info":"","x":110,"y":1340,"wires":[]},{"id":"e144f978.c5353","type":"comment","z":"4c31633a.905f9c","name":"Mostrar datos del termometro en pantalla","info":"","x":190,"y":700,"wires":[]},{"id":"b62c6a4b.b9b258","type":"comment","z":"f0ddc17c.4ba93","name":"Pruebas de botones de persianas","info":"","x":140,"y":620,"wires":[]},{"id":"f822eef9.0f9a8","type":"inject","z":"9fe9cc56.678888","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"60","crontab":"","once":true,"onceDelay":"1","topic":"","payload":"","payloadType":"date","x":190,"y":660,"wires":[["246868d8.30318","9e8b14fe.fb9c8"]]},{"id":"246868d8.30318","type":"function","z":"9fe9cc56.678888","name":"Hora_actual","func":"var d=new Date();\n//msg.hours=d.getHours();\nmsg.date = new Date();\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":600,"wires":[[]]},{"id":"5de27393.bc496c","type":"debug","z":"9fe9cc56.678888","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":870,"y":600,"wires":[]},{"id":"9e8b14fe.fb9c8","type":"moment","z":"9fe9cc56.678888","name":"","topic":"","input":"","inputType":"msg","inTz":"Europe/Madrid","adjAmount":"","adjType":"hours","adjDir":"add","format":"HH","locale":"es-ES","output":"","outputType":"msg","outTz":"Europe/Madrid","x":380,"y":660,"wires":[["40b54602.f399f","163149aa.4d9a56","1d0e7427.4dabbc"]]},{"id":"40b54602.f399f","type":"function","z":"9fe9cc56.678888","name":"Func_Luz_actual","func":"if ((msg.payload >= \"01\") && (msg.payload <= \"07\")) {msg.payload=\"Valle\";}\nif ((msg.payload >= \"08\") && (msg.payload <= \"09\")) {msg.payload=\"Llano\";}\nif ((msg.payload >= \"10\") && (msg.payload <= \"13\")) {msg.payload=\"Punta\";}\nif ((msg.payload >= \"14\") && (msg.payload <= \"17\")) {msg.payload=\"Llano\";}\nif ((msg.payload >= \"18\") && (msg.payload <= \"21\")) {msg.payload=\"Punta\";}\nif (msg.payload == \"22\") {msg.payload=\"Llano\";}\nif (msg.payload == \"23\") {msg.payload=\"Llano\";}\nif (msg.payload == \"00\") {msg.payload=\"Valle\";}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":660,"wires":[["5de27393.bc496c","21ab1f2d.5b41"]]},{"id":"21ab1f2d.5b41","type":"ui_led","z":"9fe9cc56.678888","order":3,"group":"80677e24.b1fa78","width":"3","height":"1","label":"Luz","labelPlacement":"left","labelAlignment":"left","colorForValue":[{"color":"#ff0000","value":"Punta","valueType":"str"},{"color":"#008000","value":"Valle","valueType":"str"},{"color":"#ff9500","value":"Llano","valueType":"str"}],"allowColorForValueInMessage":false,"shape":"circle","showGlow":true,"name":"luz_actual","x":880,"y":660,"wires":[]},{"id":"e350ec0b.71a1e8","type":"comment","z":"9fe9cc56.678888","name":"Led indicador de precio de LUZ","info":"","x":150,"y":540,"wires":[]},{"id":"c468882c.4a6d88","type":"comment","z":"9fe9cc56.678888","name":"Mostrar información de dispositivos conectados","info":"","x":190,"y":360,"wires":[]},{"id":"1741ba4c.0e1a06","type":"ui_statetrail","z":"9fe9cc56.678888","d":true,"group":"80677e24.b1fa78","order":11,"width":0,"height":0,"name":"","label":"","states":[{"state":"Valle","col":"#009933","t":"str","label":""},{"state":"Punta","col":"#fc0303","t":"str","label":""},{"state":"Plano","col":"#ef6001","t":"str","label":""}],"periodLimit":"24","periodLimitUnit":"3600","timeformat":"HH","tickmarks":"24","persist":false,"legend":"0","combine":true,"blanklabel":"","x":660,"y":1040,"wires":[[]]},{"id":"b974d49e.a74b78","type":"inject","z":"9fe9cc56.678888","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":180,"y":1040,"wires":[["f72fb973.b64608"]]},{"id":"f72fb973.b64608","type":"function","z":"9fe9cc56.678888","name":"","func":"msg.payload = [\n    {state:\"Valle\",timestamp:1640998740000},\n    {state:\"Valle\",timestamp:1640995200000},\n    {state:\"Plano\",timestamp:1641027600000},\n    {state:\"Plano\",timestamp:1641038400000},\n    {state:\"Punta\",timestamp:1641049200000},\n    {state:\"Punta\",timestamp:1641081540000},\n    \n    \n    \n]\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":1040,"wires":[["1741ba4c.0e1a06"]]},{"id":"4bdf3053.233e3","type":"comment","z":"9fe9cc56.678888","name":"Pagina - milisegundos","info":"https://www.epochconverter.com/","x":120,"y":980,"wires":[]},{"id":"7466fde3.5274e4","type":"link in","z":"fa9b3c4d.e0031","name":"","links":["86125c3d.2b6c3","fa52b803.f4e088"],"x":1215,"y":440,"wires":[["b0e38fdd.942d5"]]},{"id":"80fa2de2.e903f","type":"debug","z":"f0ddc17c.4ba93","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":830,"y":700,"wires":[]},{"id":"b0e38fdd.942d5","type":"function","z":"fa9b3c4d.e0031","name":"","func":"if ((msg.payload == \"cancel\") || (msg.payload == \"stop\")){\nmsg = {};\nmsg.command = \"stop\";\nmsg.status = true;\nreturn [ msg, null, null];\n} \n\n\nif (msg.payload == \"up\"){\nmsg.command = \"start\"; \nmsg.mov = \"up\";\nreturn [ null, msg, null];\n    \n}\n\nif (msg.payload == \"down\"){\nmsg.command = \"start\"; \nmsg.mov = \"down\";\nreturn [ null, null, msg];\n    \n}","outputs":3,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1320,"y":440,"wires":[["12b3c24f.1f57ce","674e9ab5.480114"],["12b3c24f.1f57ce","b1ad9b5b.3a2138","1677374c.f60e19"],["12b3c24f.1f57ce","b1ad9b5b.3a2138","2b6e14ac.5b425c"]]},{"id":"12b3c24f.1f57ce","type":"hourglass","z":"fa9b3c4d.e0031","name":"tempo_mov","persistId":"","humanizeLocale":"es","x":1550,"y":440,"wires":[["f406e799.5537f8"]]},{"id":"d8cb2e7d.cc1f9","type":"change","z":"fa9b3c4d.e0031","name":"","rules":[{"t":"set","p":"command","pt":"msg","to":"reset","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1630,"y":540,"wires":[["12b3c24f.1f57ce"]]},{"id":"f406e799.5537f8","type":"function","z":"fa9b3c4d.e0031","name":"","func":"temp_time = msg.elapsed.time.seconds;\ntemp_mov = flow.get('mov');\n\nmsg = {};\nmsg.payload = temp_time;\nmsg.mov = temp_mov;\n\nif (msg.payload != 0){\nreturn msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1720,"y":440,"wires":[["d8cb2e7d.cc1f9","3b7dae97.ced772"]]},{"id":"74876425.de259c","type":"function","z":"f0ddc17c.4ba93","name":"","func":"if ((msg.payload == \"cancel\") || (msg.payload == \"stop\")){\nmsg = {};\nmsg.command = \"stop\";\nmsg.status = true;\nreturn [ msg, null];\n} \n\n\nif ((msg.payload == \"up\") || (msg.payload = \"down\")){\nmsg.command = \"start\"; \nreturn [ null, msg];\n    \n}\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":1000,"wires":[["1abf3fe5.89b0d"],["1abf3fe5.89b0d"]]},{"id":"1abf3fe5.89b0d","type":"hourglass","z":"f0ddc17c.4ba93","name":"test","persistId":"","humanizeLocale":"es","x":530,"y":1000,"wires":[["2156d3a2.0c44fc"]]},{"id":"d6aa9371.4f54c","type":"change","z":"f0ddc17c.4ba93","name":"","rules":[{"t":"set","p":"command","pt":"msg","to":"reset","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":1180,"wires":[["1abf3fe5.89b0d"]]},{"id":"2156d3a2.0c44fc","type":"function","z":"f0ddc17c.4ba93","name":"","func":"temp = msg.elapsed.time.seconds;\nmsg = {};\nmsg.payload = temp;\n\nif (msg.payload != 0){\nreturn msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":680,"y":1000,"wires":[["fe1957f7.12c548","d6aa9371.4f54c"]]},{"id":"fe1957f7.12c548","type":"debug","z":"f0ddc17c.4ba93","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":890,"y":1000,"wires":[]},{"id":"217a6576.3c6dfa","type":"function","z":"f996f74a.c8c748","name":"","func":"msg.topic= \"persia/per1/order\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":760,"y":980,"wires":[["a44c1852.871e18"]]},{"id":"3865fddd.758302","type":"function","z":"f996f74a.c8c748","name":"","func":"msg.topic= \"persia/per2/order\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":756.25,"y":1017.5,"wires":[["a44c1852.871e18"]]},{"id":"89a3a860.14ca68","type":"function","z":"f996f74a.c8c748","name":"","func":"msg.topic= \"persia/per3/order\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":760,"y":1060,"wires":[["a44c1852.871e18"]]},{"id":"3cb78c10.d278f4","type":"switch","z":"f996f74a.c8c748","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"{\"order\":\"stop\"}","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":470,"y":1000,"wires":[["5a2678d6.2b5118"]]},{"id":"e1ad1f7e.4843a","type":"catch","z":"fa9b3c4d.e0031","name":"","scope":["12b3c24f.1f57ce"],"uncaught":false,"x":1330,"y":360,"wires":[[]]},{"id":"b1ad9b5b.3a2138","type":"change","z":"fa9b3c4d.e0031","name":"","rules":[{"t":"set","p":"mov","pt":"flow","to":"mov","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1550,"y":380,"wires":[[]]},{"id":"4a2e155.230b1ec","type":"switch","z":"fa9b3c4d.e0031","name":"","property":"mov","propertyType":"msg","rules":[{"t":"eq","v":"up","vt":"str"},{"t":"eq","v":"down","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1990,"y":540,"wires":[["74209058.c0c5c"],["870f3d3e.c5f98"]]},{"id":"74209058.c0c5c","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["3e1fe211.06a58e"],"x":2235,"y":520,"wires":[]},{"id":"9029e1c0.aa0c5","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["ff7deb41.674b08"],"x":2235,"y":640,"wires":[]},{"id":"870f3d3e.c5f98","type":"function","z":"fa9b3c4d.e0031","name":"","func":"msg.payload = msg.payload * -1;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2120,"y":640,"wires":[["9029e1c0.aa0c5"]]},{"id":"2b6e14ac.5b425c","type":"change","z":"fa9b3c4d.e0031","name":"baja","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"down\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1550,"y":280,"wires":[["7759fb5a.cc4984"]]},{"id":"1677374c.f60e19","type":"change","z":"fa9b3c4d.e0031","name":"Sube","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"up\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1550,"y":220,"wires":[["7759fb5a.cc4984"]]},{"id":"674e9ab5.480114","type":"change","z":"fa9b3c4d.e0031","name":"Stop","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"order\":\"stop\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1550,"y":160,"wires":[["7759fb5a.cc4984"]]},{"id":"7759fb5a.cc4984","type":"link out","z":"fa9b3c4d.e0031","name":"","links":["b27682da.71eec"],"x":1715,"y":220,"wires":[]},{"id":"3cada813.6f45b8","type":"function","z":"fa9b3c4d.e0031","name":"Decision up/down","func":"var local=flow.get('data') || {};\n\n\nif (local.count===undefined)//test exists\n{\n  return [ msg, null, null ];\n}\n\n  msg.demand = msg.payload; \n  msg.initial = local.count;\n  \n//Saber si la ventana esta en maximos para decidir que tiempo usar\n\nmsg.time_to_use = \"standar\";\n \nif (local.count===100)//test exists\n{\n    msg.time_to_use = \"up_whit_correction\";\n  //return [ msg, null, null ];\n}\n\nif (local.count===0)\n{\n    msg.time_to_use = \"down_whit_correction\";\n    \n    //var user_move_time = env.get(\"move_time\");\n    //var correction_up = env.get(\"Up_correction\");\n    \n    //user_move_time = user_move_time+correction_up;\n    //global.set(\"move_time_set\",user_move_time);\n    \n    //msg.time_to_use = user_move_time;\n  \n  //return [ msg, null, null ];\n} \n//-----------------------------------------\n\n\nif (msg.payload > local.count)//test Subir\n{\n  msg.type =\"up\";\n  msg.payload=msg.payload - local.count;\n  if (msg.payload > 100)//test exists\n        {\n            msg.payload=100;\n        }\n\n  return [ null, msg, null ];\n}\n\n\nif (msg.payload < local.count)//test Bajar\n{\n      msg.type =\"down\";\n      msg.payload=local.count - msg.payload;\n      \n      if (msg.payload < 0)//test exists\n            {\n                msg.payload=0;\n            }\n      else {      \n          var i = parseInt(msg.payload);\n          i = i * -1;\n          msg.payload = i;\n       }\n      \n      return [ null, null, msg ];\n}\n","outputs":3,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1490,"y":700,"wires":[[],[],[]]},{"id":"163149aa.4d9a56","type":"function","z":"9fe9cc56.678888","name":"Func_Luz_sguiente","func":"if ((msg.payload >= 01) && (msg.payload <= 07)) {msg.payload=\"Llano\";}\nif ((msg.payload >= 08) && (msg.payload <= 09)) {msg.payload=\"Punta\";}\nif ((msg.payload >= 10) && (msg.payload <= 13)) {msg.payload=\"Llano\";}\nif ((msg.payload >= 14) && (msg.payload <= 17)) {msg.payload=\"Punta\";}\nif ((msg.payload >= 18) && (msg.payload <= 21)) {msg.payload=\"Llano\";}\nif (msg.payload == 22) {msg.payload=\"Valle\";}\nif (msg.payload == 23) {msg.payload=\"Valle\";}\nif (msg.payload == 00) {msg.payload=\"Valle\";}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":780,"wires":[["ae0b76d8.3fb228"]]},{"id":"ae0b76d8.3fb228","type":"ui_led","z":"9fe9cc56.678888","order":5,"group":"80677e24.b1fa78","width":"2","height":"1","label":"   ","labelPlacement":"left","labelAlignment":"left","colorForValue":[{"color":"#ff0000","value":"Punta","valueType":"str"},{"color":"#008000","value":"Valle","valueType":"str"},{"color":"#ff9500","value":"Llano","valueType":"str"}],"allowColorForValueInMessage":false,"shape":"circle","showGlow":true,"name":"Luz_siguiente","x":900,"y":780,"wires":[]},{"id":"c527cb6b.beecb8","type":"comment","z":"9fe9cc56.678888","name":"Precio de LUZ siguiente periodo","info":"","x":690,"y":720,"wires":[]},{"id":"e12cc343.87562","type":"ui_text","z":"9fe9cc56.678888","group":"80677e24.b1fa78","order":4,"width":"1","height":"1","name":"Luz_siguiente_texto","label":"","format":"{{msg.payload}}","layout":"col-center","className":"","x":920,"y":840,"wires":[]},{"id":"1d0e7427.4dabbc","type":"function","z":"9fe9cc56.678888","name":"Func_Hora_sguiente","func":"if ((msg.payload >= 08) && (msg.payload <= 09)) {msg.payload=\"10:00\";msg.topic=\"siguiente\";}\nif ((msg.payload >= 10) && (msg.payload <= 13)) {msg.payload=\"14:00\";msg.topic=\"siguiente\";}\nif ((msg.payload >= 14) && (msg.payload <= 17)) {msg.payload=\"18:00\";msg.topic=\"siguiente\";}\nif ((msg.payload >= 18) && (msg.payload <= 21)) {msg.payload=\"22:00\";msg.topic=\"siguiente\";}\nif (msg.payload == 22) {msg.payload=\"00:00\";msg.topic=\"siguiente\";}\nif (msg.payload == 23) {msg.payload=\"00:00\";msg.topic=\"siguiente\";}\nif (msg.payload == 00) {msg.payload=\"08:00\";msg.topic=\"siguiente\";}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":840,"wires":[["e12cc343.87562"]]},{"id":"8f13a8d1.5e4588","type":"comment","z":"4c31633a.905f9c","name":"Mostrar la configuración de tiempo actual","info":"https://fontawesome.com","x":200,"y":1220,"wires":[]},{"id":"4c948cd7.6f6eac","type":"function","z":"4c31633a.905f9c","name":"","func":"\nmsg.payload= (msg.payload.time /60000000);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":1260,"wires":[["b9aa0f0b.71767"]]},{"id":"6569c01b.f08468","type":"json","z":"4c31633a.905f9c","name":"","property":"payload","action":"","pretty":false,"x":450,"y":1260,"wires":[["4c948cd7.6f6eac"]]},{"id":"d5ad6c25.e998","type":"switch","z":"dac02106.9590c","name":"","property":"payload.state","propertyType":"msg","rules":[{"t":"eq","v":"heating","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":2030,"y":440,"wires":[["4e1aa777.be5768"],["e7223b12.2b25b8"]]},{"id":"203188a0.5bb978","type":"mqtt out","z":"dac02106.9590c","name":"MQTT - Retain payload","topic":"","qos":"2","retain":"true","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"cc03406e.951f78","x":2550,"y":420,"wires":[]},{"id":"4e1aa777.be5768","type":"change","z":"dac02106.9590c","name":"Periodo_Termo_ON","rules":[{"t":"set","p":"payload","pt":"msg","to":"${MQTT_Periodo_Termo_On}","tot":"str"},{"t":"set","p":"topic","pt":"msg","to":"${MQTT_Termometro_Time}","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2280,"y":420,"wires":[["203188a0.5bb978"]]},{"id":"e7223b12.2b25b8","type":"change","z":"dac02106.9590c","name":"Periodo_Termo_Off","rules":[{"t":"set","p":"payload","pt":"msg","to":"${MQTT_Periodo_Termo_Off}","tot":"str"},{"t":"set","p":"topic","pt":"msg","to":"${MQTT_Termometro_Time}","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2270,"y":480,"wires":[["203188a0.5bb978"]]},{"id":"6a3e101e.39d88","type":"comment","z":"dac02106.9590c","name":"Cambio de periodo de lectura termometro","info":"","x":2160,"y":360,"wires":[]},{"id":"f87c405c.2393a","type":"debug","z":"4c31633a.905f9c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1210,"y":120,"wires":[]}]